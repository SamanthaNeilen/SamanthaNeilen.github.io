<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Samantha Neilen</title>
    <meta name="description" content="My name is Samantha Neilen, a dutch .Net developer. I have been coding professionaly since 2008. On this blog I will be writing about multiple subjects that ...">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/site.css" />
    <link rel="canonical" href="https://samanthaneilen.github.io/">
    <link rel="alternate" type="application/rss+xml" title="Samantha Neilen" href="/feed.xml">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109838057-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-109838057-1');
</script>


</head>

<body>
    <div class="container-fluid">
        <div class="row">
    <header aria-label="header" class="header">
        <span class="header-text">Samantha Neilen</span>
    </header>
</div>
        <div class="row">
            <div class="col-md-7 col-md-offset-1">
                <main class="page-content" aria-label="content">
                    <div>
    
    
        
            <article>
                <header class="article-header">
                    <a href="/2018/06/08/pre-compiled-azure-functions-example.html">Pre-compiled Azure Functions example</a>
                </header>
                
                <span>Jun 8, 2018</span> <br/>
                Tags: 
                        Azure
			           
                        AzureFunctions
			           
                <div class="article-content">
                    <p>
	Azure Functions are a great way of setting up small asynchronous processing with great parallel processing scaling options and a pay-as-you go pricing model at the cost of some time and memory limitations.
</p>
<p>There are multiple ways of creating a C# Azure Function: <br />
- Precompiled Azure Functions are created with a Visual Studio Azure Functions project<br />
- File based Azure Functions leverage the Azure Function CLI NPM package for development and do not require any specific editor to create.<br />
</p>
<p>
	In this blog post I will focus on developing precompiled Azure Functions using Visual Studio. In a next blog post I explain creating an Azure Function using the file based and Azure Functions.
</p>
<p>
	Azure Functions can be developed run and tested locally using the latest version of the Visual Studio 2017 IDE that has the Azure workload installed without the need to upload anything to the cloud. Installing the Azure workload also installs the Azure Storage Emulator to mimic the functionality of a storage account on your local machine.
</p>
<p> 
	I have created an <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExample github repository</a> with a solution that can be run local and be published to the cloud. An Azure Function v1 (Net Framework project) and a v2 (Net Standard and still in preview) example respond to a queue message, get some extra data from a database using Entity Framework Core, retrieve an emailtemplate from a blob storageaccount and then send an email using the data and the template with the <a href="https://sendgrid.com/solutions/email-api/" target="_blank">SendGrid emailservice</a>. (SendGrid offers an emailservice API that is free to use up to 100 emails per day)
</p>
<p>
	I used a separate class library to demonstrate that referencing other project libraries works the same as other project types. Complex Azure Functions can be build as a small microservice with a layer architecture to separate your execution/workflow, business logic and resource access into separate libraries.
</p>
<p>
 	In my example repository I used and referenced a .Net Standard 2.0 library by both an Azure Function v1 and v2 project but you can also add a class library matching the framework version of the Azure Function project. The code executed by the Functions is the same, just the underlying Framework and Azure Function runtime differs. Note that when installing NuGet package on a project it may reference different dll versions and dependencies with the same NuGet package version for the different Standard, Core and Framework projects. So when the referenced dependencies on the class library and executing project do not match it may result in runtime errors because expected DLL versions do not match on the executing project. An example of this is the WindowsAzure.Storage package version as shown below.
 <br /><img src="/assets/images/20180608/AzureStoragePackageVersionDifferences.png" alt="AzureStorage Package Version Differences" />
 </p>
<h3>Set up and run the storage emulator</h3>
<p> 
	In the windows programs or start menu find and start the Azure Storage Emulator. I encountered some issues starting the Azure Storage Emulator using the default LocalDB instance due to path naming and/or access rights, however I did manage to set up the needed database on my local SQLExpress instance. To force the Azure Storage Emulator to initialize on a named SQL instance instead of the default LocalDB use the command below and replace SQLExpress with the name of the SQL Server instance that you wish to use: 
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">AzureStorageEmulator.exe init /server SQLEXPRESS</code></pre></figure>

<p>
	After it's started, an icon for the emulator will pop-up. Use the context menu on the icon to use the "Show Storage Emulator UI" to view the command prompt with the possible commands for the emulator below.
	<br /><img src="/assets/images/20180608/AzureStorageEmulatorCommandPromt.png" alt="Azure Storage Emulator Commandpromt" />
</p>
<p>
	You can explore the contents of the endpoints using the Visual Studio Cloud Explorer window (found under the View main menu in Visual Studio) under the (Local) and then Storage Accounts node.
	You can access the storage programmatically using the account name and key found on the <a href="https://docs.microsoft.com/nl-nl/azure/storage/common/storage-use-emulator" target="_blank">Microsoft Docs page</a> for the emulator. The access key and account are defaults and publicly known thus they are also included in the config and appsettings files in the projects of my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExample GitHub repository</a>. 
</p>
<p>
	Note that the Storage Emulator will shutdown when the computer is turned of and will need to be restarted to access it after rebooting your computer.
</p>
<h3>Create a simple NetCore console application to post a queue message</h3>
<p>
	After the Azure Storage Emulator is running you can create a simple console application to post a message to the local queue storage. First create a new .Net Core Console application.	
	Next add an appsettings.json file to store any credentials and settings. Fill it with the content shown below and be sure to mark the file as "Copy to Output Directory" with a value of always in the file properties window.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"AzureStorageUri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:10001/devstoreaccount1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"AzureStorageAccountName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devstoreaccount1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"AzureStorageAccountKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw=="</span><span class="p">,</span><span class="w">
  </span><span class="s2">"AzureStorageQueueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"messages"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
	Next create a class that will be our data structure. We can use this to serialize easily to JSON. Because an Azure Function can automatically convert our serialized json queue message back to an object as I will show in the later part of this post where we create the actual Azure Function.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">internal</span> <span class="k">class</span> <span class="nc">QueueMessage</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
	Add the following NuGet packages to your project:<br />
- Microsoft.Extensions.Configuration.Json, used to access the appsettings file<br />
- WindowsAzure.Storage, used to access the queue storage<br />
<p>
	The code below shows the program.cs that can create and post a message.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Auth</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Queue</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">QueueMessageClient</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Get access to appsettings
</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConfigurationBuilder</span><span class="p">()</span>
               <span class="p">.</span><span class="nf">SetBasePath</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">GetCurrentDirectory</span><span class="p">())</span>
               <span class="p">.</span><span class="nf">AddJsonFile</span><span class="p">(</span><span class="s">"appsettings.json"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

            <span class="c1">//Get or create queue in StorageAccount
</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CloudQueueClient</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageUri"</span><span class="p">]),</span> 
                <span class="k">new</span> <span class="nf">StorageCredentials</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageAccountName"</span><span class="p">],</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageAccountKey"</span><span class="p">]));</span>
            <span class="kt">var</span> <span class="n">queue</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetQueueReference</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageQueueName"</span><span class="p">]);</span>
            <span class="kt">var</span> <span class="n">creationresult</span> <span class="p">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">CreateIfNotExistsAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>

            <span class="c1">//Create and send message as JSON
</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">QueueMessage</span>
            <span class="p">{</span>
                <span class="n">Order</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
                <span class="n">Person</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
                <span class="n">Status</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">OrderStatus</span><span class="p">.</span><span class="n">Processed</span>
            <span class="p">};</span>
            <span class="kt">var</span> <span class="n">messageJSON</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
            <span class="n">queue</span><span class="p">.</span><span class="nf">AddMessageAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">CloudQueueMessage</span><span class="p">(</span><span class="n">messageJSON</span><span class="p">)).</span><span class="nf">Wait</span><span class="p">();</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Message Sent"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
	Use the Cloud explorer to check if your message has been created in the queue.
	<br /><img src="/assets/images/20180608/CloudExplorerAndQueueWindows.png" alt="Cloud Explorer and Queue windows" />
</p>
<p>
	To post a message to an actual Azure Blob Storage, simply replace the access credentials and storage uri to values associated to an existing Azure Blob Storage.
</p>
<h3>Create a local database</h3>
<p>
	I've added a simple database project to my example solution. Create a local database in your SQL Instance, do a Schema Compare and create the tables and then run the testdata script included for a few records of data.
	(For more information on these steps outlined see my <a href="https://samanthaneilen.github.io/2017/11/24/managing-a-sql-server-database-from-a-visual-studio-database-project.html" target="_blank">previous blog post</a> on using a database project.
</p>
<h3>Create an Azure Function project</h3>
<p>
	The Azure Function project can be found under the cloud category (the Azure workload needs to be installed). When you create a project you immediately get a popup asking what kind of function you want to create within the project.
	<br /><img src="/assets/images/20180608/AzureFunctionProject.png" alt="Azure Function Project" />
</p>
<p>
	Notice the popup for the version of your function. Azure Functions V1 is based on the full .Net Framework and currently supports more triggers and bindings than the Azure Functions V2 that is currently still in preview and is based on the .Net Standard Framework. The choices for the kind of Azure Function to create with the project are actually limited to the most common ones. If you do not see the trigger you want to use, select the empty option and use the File then New option in the project context menu in the Solution Explorer to add a new Azure Function.	
</p>
<p>
Function V1 default trigger dialog:
<br /><img src="/assets/images/20180608/CreateV1Function.png" alt="Create V1 Function" />
</p>
<p>
Function V2 default trigger dialog:
<br /><img src="/assets/images/20180608/CreateV2Function.png" alt="Create V2 Function" />
</p>
<p> 
	When using the Add then Add New Item option in the context menu of the project, you get a lot more options for the Azure Function that you want to create.
</p>
<p>
    Add New Item dialog:
    <br /><img src="/assets/images/20180608/AzureFunctionItem.png" alt="Azure Function Item" />
</p>
<p>
	Azure Function version 1 triggers:
	<br /><img src="/assets/images/20180608/AzureFunctionTypesV1.png" alt="Azure Function Types V1" />
</p>
<p>
	Azure Function version 2 triggers:
	<br /><img src="/assets/images/20180608/AzureFunctionTypesV2.png" alt="Azure Function Types V2" />
</p>
<p>In my example project I created a Queue Function. For the settings I used the UseDevelopment storage and chose AzureWebJobsStorage for my connectionstring. A default project contains the Function1.cs with the default input variables defined by the chosen function template. More information on the bindings can be found <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings" target="_blank">here</a>.
</p>
<p>Default content of Function1.cs for a queue trigger</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Function1</span>
<span class="p">{</span>
	<span class="p">[</span><span class="nf">FunctionName</span><span class="p">(</span><span class="s">"Function1"</span><span class="p">)]</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="kt">string</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
Other than the Function1.cs there is a local.settings.json and a host.json. The local.settings.json is your appsettings file for running locally. When deployed to Azure the Azure Function will use the appsettings defined in the Application Settings page of the Function App in the Azure Portal. 
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"IsEncrypted"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AzureWebJobsStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"AzureWebJobsDashboard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
The host.json is used to defined certain runtime settings. Possible settings and the defaults if no settings are defined can be found <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-host-json" target="_blank">here </a>. The most important setting in the host.json is the functionTimeout setting. Azure Functions that run on a consumption plan only have a timeout of 5 minutes, meaning that the execution is terminated after 5 minutes without any decent error. When persisting state within the function this may lead to  leaving data in an unfinished or corrupted state. In a queue function a  message is set invisible when processing and only removed from the queue after being fully processed. When processing is interrupted without removing the message, the message will become visible again after a configurable timeout. The message then triggers another run of the Azure Function. This can trigger an infinite loop of failing requests in the message never finishes processing within the functionTimeout interval. On a consumption (pay-as-you-go plan) you can currently set the maximum to a 10 minute timeout. If you have workloads that need more processing time you should switch to an app service billing plan and be sure to remove the functionTimeout setting from the host.json to avoid functions being terminated.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
	</span><span class="s2">"functionTimout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00:10:00"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
The next thing of interest is the NuGet package for the Azure Function SDK called Microsoft.NET.Sdk.Functions. 
<br /><img src="/assets/images/20180608/NuGetSdkFunctions.png" alt="NuGet Sdk Functions" />
<br />
This NuGet contains al the references that are available in the Azure Function Environment. A thing to remember when using functionality, like accessing azure storage, is to use the version referenced in the SDK package because the Azure Function Apps runtime does not run the latest versions of packages like AzureStorage or SendGrid. When creating separate referenced class libraries use the same version Azure Function SDK to avoid mismatching dependencies. You will get a runtime error stating that the dependent dll with the expected version number is not found.
</p>
<p>
Now that we have an Azure Function that can respond to a queue message and that logs a logmessage. Run the project, you can add a breakpoint to the log line to see that debugging works as expected. Azure Functions projects start a console with logging as shown below.
<p>
	Azure Function v1 run in the console window:
	<br /><img src="/assets/images/20180608/ConsoleRunningFunctionV1.png" alt="Console Running Function V1" />
</p>
<p>
	Azure Function v2 run in the console window:
	<br /><img src="/assets/images/20180608/ConsoleRunningFunctionV2.png" alt="Console Running Function V1" />
</p>
</p>
Debugging one of the Functions:
<br /><img src="/assets/images/20180608/DebugDefaultAzureFunction.png" alt="DebugDefaultAzureFunction" />
</p>
<p>When working with queue triggers be aware that only one Function can respond to a queue message. If multiple functions are listening to the same queue only the first to respond to the message (and set the message invisible) will execute.</p>
<p>
There is one known issue when running a V2 Azure Function in that it has trouble finding the Azure CLI Runtime located in you Users/AppData/ folder when the path (usually your usename) contains spaces. Introduce a launchSettings.json file inside a properties folder in your project directory to help the runtime out in locating the correct location for the needed assemblies as described <a href="https://github.com/Azure/Azure-Functions/issues/623" target="_blank">here</a>.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"MyApp"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"commandName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Executable"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"executablePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">Program Files</span><span class="se">\\</span><span class="s2">dotnet</span><span class="se">\\</span><span class="s2">dotnet.exe"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"commandLineArgs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"</span><span class="se">\"</span><span class="s2">C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">XXXX</span><span class="se">\\</span><span class="s2">AppData</span><span class="se">\\</span><span class="s2">Roaming</span><span class="se">\\</span><span class="s2">npm</span><span class="se">\\</span><span class="s2">node_modules</span><span class="se">\\</span><span class="s2">azure-functions-core-tools</span><span class="se">\\</span><span class="s2">bin</span><span class="se">\\</span><span class="s2">Azure.Functions.Cli.dll</span><span class="se">\"</span><span class="s2"> host start"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"workingDirectory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$(TargetDir)"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span></code></pre></figure>

<p>
When running and debugging the message you can see that the message input is currently a string that needs to be deserialised. Since the structure is a known JSON input you can just add a class defining this structure to your Function project or a referenced class library and replace string type input with the type of your class.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">QueueMessage</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span></code></pre></figure>

<p>
After doing this you can see in the debugger that you get a nice object input ready for use in your function code. 
<br /><img src="/assets/images/20180608/DebugSerializedInput.png" alt="Debug Serialized Input" />	
</p>
<h3>Access the database using Entity Framework Core</h3>
<p>
For the data access framework I will be using Entity Framework Core. Add the Microsoft.EntityFrameworkCore.SqlServer NuGet package to your Function project or a referenced class library and specify a database context as shown below:
</p>
<p>Person class:

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">Person</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Orders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</p>
<p>Order class:

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">PersonID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>        
        <span class="k">public</span> <span class="kt">string</span> <span class="n">OrderNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="n">Person</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</p>
<p>Context class:

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>


        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">HasMany</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Orders</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">WithOne</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Person</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">HasForeignKey</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">OrderDbContext</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DbContextOptionsBuilder</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;().</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Options</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</p>
<p>
Next add a connectionstring to your local.settings.json referencing the database you created with the database project.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"OrderDbConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Server=.</span><span class="se">\\</span><span class="s2">SQLEXPRESS;Database=OrderDb;Integrated Security=True;"</span></code></pre></figure>

<p>
Then add the code to your Azure Function to create and call the context. The code snippet below shows how to get the ordernumber and person name into a MailSettings object that can be used as input for a mail sending service class.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">MailData</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">PersonName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">OrderNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">EmailTemplate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">OrderDbContext</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
	<span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span><span class="p">);</span>

	<span class="kt">var</span> <span class="n">mailData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MailData</span>
	<span class="p">{</span>
		<span class="n">PersonName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
		<span class="n">Email</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
		<span class="n">OrderNumber</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderNumber</span><span class="p">,</span>
		<span class="n">Status</span> <span class="p">=</span> <span class="p">((</span><span class="n">OrderStatus</span><span class="p">)</span><span class="n">myQueueItem</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(),</span>
		<span class="n">EmailTemplate</span> <span class="p">=</span> <span class="n">blobService</span><span class="p">.</span><span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateContainerName"</span><span class="p">),</span>
			<span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateBlobName"</span><span class="p">))</span>
	<span class="p">};</span>

	<span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Debug or log the contents of the MailSettings object instance to check if the database data is retrieved as expected.
</p>
<p> </p>
<h3>Retrieve an emailtemplate file from a blobstorage</h3>
<p>
First create a emailtemplate html as shown below and upload it to an emaltemplate container in your local development blob storage. The text between brackets will be replaced with the data we retrieved from the database before sending the email.
</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Dear {CONTACT},<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>You order with ordernumber {ORDERNUMBER} now has status {STATUS}.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Regards,<span class="nt">&lt;br/&gt;</span>
        Sender
    <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure>

<p> 
Next add the Microsoft.NET.Sdk.Functions NuGet package to your Function project or class library so we have a reference to the WindowsAzureStorage. 
Below is the code to get a reference to a blob storage, get the file as a stream and then read the stream from the beginning to get the contents of a blob as a string. 
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Auth</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Blob</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">BlobStorageService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_storageUri</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_accountName</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_key</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">BlobStorageService</span><span class="p">(</span><span class="kt">string</span> <span class="n">storageUri</span><span class="p">,</span> <span class="kt">string</span> <span class="n">accountName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_storageUri</span> <span class="p">=</span> <span class="n">storageUri</span><span class="p">;</span>
            <span class="n">_accountName</span> <span class="p">=</span> <span class="n">accountName</span><span class="p">;</span>
            <span class="n">_key</span> <span class="p">=</span> <span class="n">key</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="kt">string</span> <span class="n">containerName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">emailTemplateName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="n">CloudBlobClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CloudBlobClient</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">_storageUri</span><span class="p">),</span> <span class="k">new</span> <span class="nf">StorageCredentials</span><span class="p">(</span><span class="n">_accountName</span><span class="p">,</span> <span class="n">_key</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetContainerReference</span><span class="p">(</span><span class="n">containerName</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="nf">ExistsAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">blob</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="nf">GetBlobReference</span><span class="p">(</span><span class="n">emailTemplateName</span><span class="p">);</span>
                    <span class="n">blob</span><span class="p">.</span><span class="nf">DownloadToStreamAsync</span><span class="p">(</span><span class="n">stream</span><span class="p">).</span><span class="nf">Wait</span><span class="p">();</span>

                    <span class="n">stream</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> 
                    <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamReader</span><span class="p">(</span><span class="n">stream</span><span class="p">).</span><span class="nf">ReadToEnd</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Container </span><span class="p">{</span><span class="n">containerName</span><span class="p">}</span><span class="s"> not found"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>        
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
All of the parameters for the constructor en method will be defined in the local.settings.json of the calling assembly so we can easily change the location and name of the emailtemplate without the need to redeploy the function. The settings below show the connection to the local Azure Emulator blob storage.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"BlobStorageUri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:10000/devstoreaccount1"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BlobStorageAccount"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devstoreaccount1"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BlobStorageKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw=="</span><span class="p">,</span><span class="w">
</span><span class="s2">"EmailTemplateContainerName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"emailtemplates"</span><span class="p">,</span><span class="w">
</span><span class="s2">"EmailTemplateBlobName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"emailtemplate.html"</span></code></pre></figure>

<p>
Next we can create the blobservice in our function instance and call the method to get the emailtemplate contents as a string.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">OrderDbContext</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">blobService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlobStorageService</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageUri"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageAccount"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageKey"</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">mailData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MailData</span>
    <span class="p">{</span>
        <span class="n">PersonName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
        <span class="n">Email</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
        <span class="n">OrderNumber</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderNumber</span><span class="p">,</span>
        <span class="n">Status</span> <span class="p">=</span> <span class="p">((</span><span class="n">OrderStatus</span><span class="p">)</span><span class="n">myQueueItem</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(),</span>
        <span class="n">EmailTemplate</span> <span class="p">=</span> <span class="n">blobService</span><span class="p">.</span><span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateContainerName"</span><span class="p">),</span>
            <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateBlobName"</span><span class="p">))</span>
    <span class="p">};</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
When calling this code from the Azure Function V1 (Framework project), referencing a .Net Standard 2.0 library you will get a runtime error because as stated before referenced dll versions in the referenced SDK NuGet package do not match.
<br /><img src="/assets/images/20180608/AzureStorageDLLVersionError.png" alt="AzureStorageDLLVersionError" />
<br /><img src="/assets/images/20180608/AzureStoragePackageVersionDifferences.png" alt="AzureStorage Package Version Differences" />
<br />
To resolve this issue add the matching Windows Azure Storage version NuGet package to the Azure Function V1 project. After that it will have the proper version in the output directory of the Azure Function Project.
</p>
<p><br /><img src="/assets/images/20180608/ExtraWindowsAzureStoragePackage.png" alt="Extra Windows Azure Storage Package" /></p>
<p>
Again you can use the console or debugger to verify that the retrieved string matches the contents of the uploaded file. 
</p>
<h3>Send an email using the SendGrid email client</h3>
<p>
Now that we have all the settings data and a html string with placeholders for the data, we can add a sendemailservice to our project. (There is also an output binding that can send an email using a Azure SendGrid resource as explained <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-sendgrid" target="_blank">here</a>) but I prefer creating a custom serviceclient because you can change the implementation to use another online emailing service if needed and have more control for error handling.
</p>
<p>
First add the SendGrid NuGet package. Then add EmailService as show below. The key passed in the constructor is a unique API key that you can create in your SendGrid account under the Settings then API Keys option.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">AzureFunctionsExample.Shared</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">SendGrid</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">SendGrid.Helpers.Mail</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_apiKey</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_from</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">HttpStatusCode</span><span class="p">&gt;</span> <span class="n">_validStatusCodes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HttpStatusCode</span><span class="p">&gt;{</span>
            <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">Accepted</span><span class="p">,</span>
            <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span>
        <span class="p">};</span>


        <span class="k">public</span> <span class="nf">EmailService</span><span class="p">(</span><span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span> <span class="kt">string</span> <span class="k">from</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_apiKey</span> <span class="p">=</span> <span class="n">apiKey</span><span class="p">;</span>
            <span class="n">_from</span> <span class="p">=</span> <span class="k">from</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="k">public</span> <span class="k">void</span> <span class="nf">SendEmail</span><span class="p">(</span><span class="n">MailData</span> <span class="n">mailData</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendGridMessage</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">From</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmailAddress</span><span class="p">(</span><span class="n">_from</span><span class="p">)</span>
            <span class="p">};</span>

            <span class="n">message</span><span class="p">.</span><span class="nf">AddTo</span><span class="p">(</span><span class="k">new</span> <span class="nf">EmailAddress</span><span class="p">(</span><span class="n">mailData</span><span class="p">.</span><span class="n">Email</span><span class="p">));</span>

            <span class="n">message</span><span class="p">.</span><span class="n">HtmlContent</span> <span class="p">=</span> <span class="n">mailData</span><span class="p">.</span><span class="n">EmailTemplate</span>
                <span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{CONTACT}"</span><span class="p">,</span><span class="n">mailData</span><span class="p">.</span><span class="n">PersonName</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{ORDERNUMBER}"</span><span class="p">,</span> <span class="n">mailData</span><span class="p">.</span><span class="n">PersonName</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{STATUS}"</span><span class="p">,</span> <span class="n">mailData</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
                
            <span class="n">message</span><span class="p">.</span><span class="n">Subject</span> <span class="p">=</span> <span class="s">"Mail from Azure Function"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendGridClient</span><span class="p">(</span><span class="n">_apiKey</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendEmailAsync</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_validStatusCodes</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Error sending mail"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
Next we add the API key and from email settings to the local.settings.json file and then create the mailservice calls the with the data in the Function. 
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"SendGridApiKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOUR_KEY_HERE"</span><span class="p">,</span><span class="w">
</span><span class="s2">"FromEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOUR_SENDER_EMAIL_HERE"</span><span class="p">,</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">OrderDbContext</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">blobService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlobStorageService</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageUri"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageAccount"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageKey"</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">mailData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MailData</span>
    <span class="p">{</span>
        <span class="n">PersonName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
        <span class="n">Email</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
        <span class="n">OrderNumber</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderNumber</span><span class="p">,</span>
        <span class="n">Status</span> <span class="p">=</span> <span class="p">((</span><span class="n">OrderStatus</span><span class="p">)</span><span class="n">myQueueItem</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(),</span>
        <span class="n">EmailTemplate</span> <span class="p">=</span> <span class="n">blobService</span><span class="p">.</span><span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateContainerName"</span><span class="p">),</span>
            <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateBlobName"</span><span class="p">))</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">senGridService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmailService</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"SendGridApiKey"</span><span class="p">),</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"FromEmail"</span><span class="p">));</span>
    <span class="n">senGridService</span><span class="p">.</span><span class="nf">SendEmail</span><span class="p">(</span><span class="n">mailData</span><span class="p">);</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Next run the function to send an email with your SendGrid account. (Some servers or domain names may have the SendGrid domain blacklisted and deny delivery but you can verify mails send in your SendGrid account under the Activity setting) 
</p>
<h3>Some notes on publishing to Azure</h3>
<p>Sometimes a publish to a new Azure Function app fails because the Function app resource is not created fast enough. Usually a second publish will succeed.</p>
<p>You cannot publish a version 1 Azure Function to a version 2 Azure Function app and publishing an Azure Function v2 app to an existing v1 app will cause a pop-up asking if you want to upgrade the version.</p>
<p>Publishing will not create the appropriate Application Setting keys for the Azure Function app in Azure. You will have to create them separately in the Azure portal.</p>


                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2018/04/20/podcasts-a-tip-for-consuming-it-related-content-on-the-go.html">Podcasts, a tip for consuming IT related content on the go</a>
                </header>
                
                <span>Apr 20, 2018</span> <br/>
                Tags: 
                <div class="article-content">
                    <p>
This month no technical article but a tip I want to share. For written content I usually tend to focus on books and lose track of blogs. With podcasts I can just listen on my work commute or exercise walks. There is a lot of free and actively updated content out there and the podcasts can be listened to from your phone from the different podcast apps out there like <a href="https://www.stitcher.com/" target="_blank">Stitcher</a> for Android or <a href="https://www.apple.com/itunes/" target="_blank">Itunes</a> for Apple devices. 
</p>
<h3>.Net/Microsoft specific shows</h3>
<ul>
    <li>
        <a href="https://www.dotnetrocks.com/" target="_blank"><b>.Net rocks</b></a><p>
        A show with interviews about .Net subjects. Mostly features interviews with Microsoft employee’s about their projects. Shows come out multiple times in a week and shows are about 45-60 minutes.
    </p></li>
    <li>
        <a href="https://msdevshow.com/" target="_blank"><b>MS dev show </b></a><p>
        A show with interviews about .Net subjects. Mostly features interviews with people about their .Net projects. Shows come out once every week, sometimes they have bigger gaps in their shedule. Shows are about 45-60 minutes long.
    </p></li>
    <li>
        <a href="http://www.mergeconflict.fm/" target="_blank"><b>Merge conflict</b></a><p>
        A show where 2 developers talk about their experiences and projects has a .NET focus but may also sometimes dive into other technology. Shows come out every week and are about 45-60 minutes long.
    </p></li>
    <li>
        <a href="https://www.microsoft.com/en-us/research/blog/category/podcast/" target="_blank"><b>Microsoft research podcast</b></a><p>
        Interview with employees at Microsoft research about their project. This podcast is less developer focused and features a variety of subjects researched at Microsoft. Shows come out every week and are about 30 minutes long.
    </p></li>   
</ul>
<h3>General IT shows</h3>
<ul>
     <li>
        <a href="https://www.codingblocks.net/" target="_blank"><b>Coding Blocks</b></a><p>
        3 developers talk about patterns, practices and design methodologies. Shows usually come out every one or 2 weeks and are about 90-120 minutes long.
    </p></li>
    <li>
        <a href="http://developeronfire.com/" target="_blank"><b>Developer on fire</b></a><p>
        Interviews with developers, follows a pattern of personal stories about their failures, successes, book recommendations and tips for other developers. Shows come out once or twice a week and are about 45 minutes long.
    </p></li>
    <li>
        <a href="https://www.hanselminutes.com/" target="_blank"><b>Hanselminutes</b></a><p>
        Interviews that Scott Hanselman from Microsoft has with a variety of people related to technology. Shows come out every week and are about 30 minutes long.
    </p></li>
        <li>
        <a href="https://www.codenewbie.org/" target="_blank"><b>CodeNewbie</b></a><p>
        Feature interviews about how people got into tech and their experiences in the developer world. Shows come out in seasons of weekly shows that are about 45 minutes long.
    </p></li>
        <li>
        <a href="https://learntocodewith.me/" target="_blank"><b>Learn to code with me</b></a><p>
        Interviews with developers on how they got started with their jobs. Shows come out in seasons of weekly episodes and are about 30-60 minutes long.
    </p></li>
    <li>
        <a href="https://www.legacycode.rocks/" target="_blank"><b>Legacy code rocks</b></a><p>
        Interviews with people about working with legacy code. Shows come out irregular and are about 45-60 minutes long.
    </p></li>
    <li>
        <a href="https://securityweekly.com/" target="_blank"><b>Paul’s security weekly</b></a><p>
        Discussions and interviews about security. The podcasts features numerous shows that zoom in on the various IT fields. Application Security weekly focusses on the developer side of things. This show also has a version with video, sometimes the interviews are demos and are not easily followed with audio only. Features multiple themed shows a week that are about 60-120 minutes long.
    </p></li>
    <li>
        <a href="https://softwareengineeringdaily.com/" target="_blank"><b>Software engineering daily</b></a><p>
        Daily shows featuring interviews with software engineers about a wide range of topics and technologies. Shows come out every business day and are about 60 minutes long.
    </p></li>
    <li>
        <a href="http://www.se-radio.net/" target="_blank"><b>Software Engineering Radio</b></a><p>
        Interviews with software engineers about a wide range of topics and technologies. Shows come out every 2 to 3 weeks and last about 60 minutes.
    </p></li>
    <li>
        <a href="https://joecolantonio.com/testtalks/" target="_blank"><b>TestTalks</b></a><p>
        A show featuring interviews about test automation. Shows come out every week and are about 30-45 minutes long.
    </p></li>
    <li>
        <a href="https://thewomenintechshow.com/" target="_blank"><b>The Women in Tech show</b></a><p>
        A show featuring interviews with software engineers (mostly women) and their projects and experiences. Shows come out every week and are about 30-60 minutes long.
    </p></li>
    <li>
        <a href="https://spec.fm/podcasts/developer-tea" target="_blank"><b>Developer tea</b></a><p>
        A show about taking on a learning mindset and developing you soft skills. Comes out 3 times a week and shows are about 20-30 minutes long. 
    </p></li>
    <li>
        <a href="http://www.weeklydevtips.com/" target="_blank"><b>Weekly dev tips</b></a><p>
        A show by Steve Smith about patterns and practices for developers. Shows come out very irregular and are about 5-10 minutes long. 
    </p></li>
    <li>
        <a href="https://channel9.msdn.com/Shows/Visual-Studio-Toolbox" target="_blank"><b>Visual Studio Toolbox</b></a><p>
        A video podcast affiliated with channel 9 that features demos about the tooling and usage of Visual Studio en Visual Studio Team Services. Shows come out about every 2 weeks and vary in length from 15-60 minutes.
    </p></li>  
</ul>
<h3>Shows about agile &amp; scrum</h3>
<ul>
    <li>
        <a href="https://scrum-master-toolbox.org/" target="_blank"><b>Scrum master toolbox</b></a><p>
        Interviews with scrum masters about their experiences. Features a set schedule of “theme-days” covering successes, failures, book recommendations, retro format recommendations. Shows come out every businessday and are about 10-20 minutes long.
    </p></li>
    <li>
        <a href="https://ryanripley.com/agile-for-humans/" target="_blank"><b>Agile for humans</b></a><p>
        This shows features subjects and Interviews relating to the scrum/agile way of working in teams. Shows come out about every week but may sometimes have gaps in the schedules. Shows vary in length from 30-45 minutes.
    </p></li>
</ul>

                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2018/03/17/setting-up-a-release-using-vsts.html">Setting up a release using VSTS</a>
                </header>
                
                <span>Mar 17, 2018</span> <br/>
                Tags: 
                        DevOps
			           
                <div class="article-content">
                    <p>
    In <a href="https://samanthaneilen.github.io/2018/02/10/setting-up-a-build-using-vsts.html" target="_blank">my last</a> post I showed how to build your project using VSTS. In this blog post I will describe how to set up a release to deploy the database and website from that build to an Azure Environment. 
</p>
<h3>Preparing the project for the release environment</h3>
<p>
    First I would like to point out some changes I made to the ECommerceApp.
    First of was the Target platform of the database project property pages.
<br /><img src="/assets/images/20180317/DatabaseProjectTarget.png" alt="Database Release Target" />
</p>
<p>
    It needs to be set to target an Azure SQL Database as that will be my target platform. Not setting this to the correct target will lead to errors when deploying the .dacpac file.
    Next I altered the Web.Release.config. The transformation rules below will change any local paths to HIDDEN. 
<br /><img src="/assets/images/20180317/ReleaseConfig.png" alt="Release Config" />
</p>
<p>
    These settings will be overwritten by the settings in the “Application settings” configured in the Azure Portal on the Web App, so there is no need for those paths to be filled with Debug or local settings. In production environments this would ensure no that no sensitive data is in the web.config on the file system and only in the “Application Settings” on the portal. The settings in the portal can be secured with access rights and are saved encrypted in the Azure Environment. The project contains a file download that expects a download to a local folder. That will not work on Azure, so I added the EnableExport feature flag that is set to false in the deployment.
</p>
<h3>Setting up the Azure artifacts for deployment</h3>
<p>
    In my example I set up de Web app and the Azure SQL Database by hand. The deployment pipelines in VSTS have steps to create these artifacts during a release if they do not exist with PowerShell steps. This is beyond the scope of this blog post. In this post I assume that the Web app and Azure SQL Database are present and correctly configured in the Azure environment that I am targeting. 
    My resource group looks like the image below:
<br /><img src="/assets/images/20180317/ResourceGroupAzure.png" alt="Resource Group Azure" />
</p>
<p>
    Also my Web App already has the correct application settings and connection string configured in the Application settings tab as shown below. The application and configuration settings in the Azure portal are used at runtime instead of the settings in the web.config that is deployed in the Azure environment.
<br /><img src="/assets/images/20180317/ApplicationSettingsAzure.png" alt="Application Settings Azure" />
</p>
<h3>Setting up the release</h3>
<p>
    In your VSTS project go to the Build and Release menu, then click Releases and then select New definition.
<br /><img src="/assets/images/20180317/CreateReleasePage.png" alt="Create Release Page" />
</p>
<p>
    In the new Release Definition window select I selected the “Empty” template and named my deployment environment Test.
<br /><img src="/assets/images/20180317/NewReleaseDefinitionOverview.png" alt="New Release Definition Overview" />
</p>
<p> 
    Next I want to select the output artifacts (the database .dacpac and web deployment zip) from my build with the Add button next to Artifacts.
<br /><img src="/assets/images/20180317/ArtifactSelection.png" alt="Artifact Selection" />
</p>
<p>
    After selecting your artifacts the build trigger will become available. You can set the trigger to create the release every time a build has been successfully created.
<br /><img src="/assets/images/20180317/DeploymentTrigger.png" alt="Deployment Trigger" />
</p>
<p> 
    Next are the pre-deployment settings where you can set up extra rules that the deployment will start after a manual approval by for example your QA team.  I kept the defaults for this step.
<br /><img src="/assets/images/20180317/PreDeploymentConditions.png" alt="Pre-Deployment Conditions" />
</p>
<p>
    Next click on the 1 phase, 0 tasks link to get into the screen where you can actually add the deployment steps for the environment. Here add a Azure SQL DacpacTask and a Azure App Service Deploy task. Then setup the tasks to deploy to your Azure environment.
<br /><img src="/assets/images/20180317/EnvironmentSteps.png" alt="Environment Steps" />
</p>
<p>
    The DacpacTask is configured as shown below:
<br /><img src="/assets/images/20180317/DacPacStepDetails.png" alt="DacPac Step Details" />
</p>
<p>
    The Azure App Service Deploy is configured as below. I only setup the settings shown below and used the defaults for all the others. Notice the menu to deploy or change the application and configuration settings. As all my configuration is already set up correctly in the portal, I do not need to set these up here.
<br /><img src="/assets/images/20180317/WebAppStepDetails.png" alt="WebApp Step Details" />
</p>
<p>
    These steps are enough to deploy the output from the build to the Azure environment. You can return to the release overview using the Pipeline option and add some post-release options to the environment. Post-deployment approvals can be used to sign of on the release after the deployment has been tested. So if you add another environment like Acceptance or Production after the Test environment (using the Add button) the Post-Deployment approval is used to halt the release for the next environment until the current environment is approved by the QA team. 
<br /><img src="/assets/images/20180317/PostDeploymentConditions.png" alt="Post Deployment Conditions" />
</p>
<p>
    In the options tab of the release definition you can set up the format for the naming conventions for your release.
<br /><img src="/assets/images/20180317/ReleaseOptions.png" alt="Release Options" />
</p>
<p>
    Now that we’ve set up the release pipeline, save it and start a new build to trigger the release. As I did not set any pre-deployment approvals the build will immediately and automatically release to the test environment after the build is complete.
</p>
<p>
    You can see the active releases under the release tab and also go to the overview or details for a release execute the approval actions on an environment.
<br /><img src="/assets/images/20180317/ReleaseOverview.png" alt="Release Overview" />
</p>
<p>
    After the release has been completed you can see an overview by clicking on the name of a release.
<br /><img src="/assets/images/20180317/ReleaseDetails.png" alt="Release Details" /> 
</p>
<p>
    If a deploy fails click on the log tab in the release details to troubleshoot errors.
<br /><img src="/assets/images/20180317/ReleaseDetailsLogs.png" alt="Release Details Logs" />
</p>

                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2018/02/10/setting-up-a-build-using-vsts.html">Setting up a build using VSTS</a>
                </header>
                
                <span>Feb 10, 2018</span> <br/>
                Tags: 
                        DevOps
			           
                <div class="article-content">
                    <p>
VSTS is the online platform from Microsoft to save your code. A VSTS project is free when there are 5 users or less and can function as a free private source control for small teams and projects. It also has Scrum/Kanban board functionality to manage a backlog and issues. But the best feature might be that you can use the  build and deployment features to fully adopt a DevOps way of working.  In this blogpost I will be showing how to create and run a build using VSTS. In a next blog post I will cover how to set up a deployment to Azure using the output of the build.
</p>
<p>
Even if you are not using a build for creating deployments, they still ensure that the source repository does not only build on your machine. It can also run your unit tests for you if you forget to run them yourself. 
</p>
<p>
In the past you always needed to set up a server or workstation with a build agent installed to set up builds, but I recently learned that there are Hosted Agents that actually spin up a build agent for you in the cloud and publish the build output (deployment assets) to an output folder. You can then use the deployment pipelines to deploy these assets to Azure or a server. To see what builds are supported by the Hosted Agent see the <a href="https://docs.microsoft.com/en-us/vsts/build-release/concepts/agents/hosted" target="_blank">Microsoft Docs page</a>. 
<p>
To set up a VSTS project visit <a href="https://www.visualstudio.com/team-services" target="_blank">https://www.visualstudio.com/team-services/</a>. You can create builds for other source control providers like GitHub so you can create a build but will not have to migrate your source control and lose any check-in history.
</p>
<p>
<h3>Setting up a build</h3>
<p>
In this example I will be setting up a build for my <a href="https://github.com/SamanthaNeilen/ECommerceSampleApplication" target="blank">ECommerceSampleApplication repository</a> that is hosted on GitHub. It contains a .Net Framework 4.6.1 MVC application, a supporting database project and some unit tests.
</p>
<p>
First go to your team project. Go to the builds section under Build and Release. Then click the New button to start a new build definition.
<br /><img src="/assets/images/20180210/CreateNewBuildDefinition.png" alt="Create New Build Definition" />
</p> 
<p>
I want to create a build for my GitHub repository so I choose GitHub as my provided and created a connection to GitHub using my username and password. (Note that the process of creating the connection to GitHub uses several pop-ups and may not work properly in all browsers.)
<br /><img src="/assets/images/20180210/ConnectToSource.png" alt="Connect To Source Control Provider" />
</p>
<p>
After clicking continue you get the option of selecting a specific build template for your type of project. If you want more details on the templates or the build steps included, see <a href="https://docs.microsoft.com/en-us/vsts/build-release/" target="_blank">https://docs.microsoft.com/en-us/vsts/build-release/</a>.
<br /><img src="/assets/images/20180210/SelectBuildTemplate.png" alt="Select A Build Template" />
</p>
<p>
I chose the ASP.Net project template. It gets my sources, restores my NuGet packages, builds the solution, runs the unittests, sets up publishing of the pdb files for remote debugging and publishes the build artifacts (project output) to the VSTS deployment/download location. 
<br /><img src="/assets/images/20180210/BuildSolutionStepDefaults.png" alt="Build Solution Step Defaults" />
</p>
<p>
I can actually just use most of the defaults for my project. I don’t need the publish symbol paths task so I deleted it. In the Build Solution Task, note the input field for Platform and Configuration. These variables will be populated with values from the Variables tab. In this task also notice the MSBuild arguments. This configuration will output the deployment package for my web package to the artifact staging directory. Seeing as my MVC project is not only the project I wanted to build and deploy, I removed everything in the MSBuild Arguments except the /p DeployOnBuild=true argument. 
<br /><img src="/assets/images/20180210/BuildSolutionStepAfterChanges.png" alt="Build Solution Step After Changes" />
</p> 
<p>
Next I added 2 custom steps to copy the deployment files from the website and database projects. The Copy tasks are shown in the images below.  (All advanced and control options settings were not changed from the defaults)
<br /><img src="/assets/images/20180210/CopyWebFilesTask.png" alt="Copy Web Files Task" />
<br /><img src="/assets/images/20180210/CopyDatabaseFilesTask.png" alt="Copy Database Files Task" />
</p>
<p>
If you have tests in your solution that run as integration tests and cannot and connect to resources like the database or a webservice from the test run process, you could choose exclude them in the Test Assemblies task via the Test filter criteria box. 
<br /><img src="/assets/images/20180210/TestFilterAttribute.png" alt="Test Filter Attribute Field" />
</p>
<p> 
Most input fields in the tasks have an information icon to figure out how the fields are used. Also again look at <a href="https://docs.microsoft.com/en-us/vsts/build-release/" target="_blank">https://docs.microsoft.com/en-us/vsts/build-release/</a> for more guidance on specific needs.
</p>
<p>
Also check out the settings under the other tabs of the build. 
<br /><img src="/assets/images/20180210/BuildTemplateTabsMenu.png" alt="Build Template Tabs Menu" />
</p>
<p>
- Triggers allow you to configure whether or not to use gated checkins or trigger the build on a checkin or to schedule the build as a nightly or other scheduled build. <br />
- The Options tab allows you to configure the name and versioning of the build output. <br />
- Retention specifies how long the assets will be maintained. <br />
- History will contain references to builds for this template if you have already triggered the build template before.
</p>
<p>
Now that you have a build template you can save or save and queue. The save and queue option will immediately start the dialog to start a build using the template.
<br /><img src="/assets/images/20180210/SaveAndQueueDialog.png" alt="Save And Queue Dialog" />
</p>
<p>
Here you can see the Agent Queue and you can select the hosted queues provided by VSTS or any private build agents that you have configured. Also note the variables, you can change their values here. If you have set up an additional variable in the Variables tab of the build template and you want to set the value at every build, then be sure to check the "Settable on queue time" option
</p>
<p>
After the build has been queued you can see the status under the build tab. Click on the version number link to see the progress and details for a build.
<br /><img src="/assets/images/20180210/BuildsOverview.png" alt="Builds Overview" />
</p> 
<p>
If you are running private agents or multiple builds you might sometimes see the Status as waiting for available agent. If this happens you can check out the agents workload under the Gear icon under the Agent Queue option. You need certain account permissions on the project to access this information and it may not be visible if you do not have permission.
<br /><img src="/assets/images/20180210/AgentQueueOverview.png" alt="Agent Queue Overview" />
</p>
<p>
After a build completes you get an email with the results and you can view the results in the build details after it finishes. 
<br /><img src="/assets/images/20180210/BuildSummary.png" alt="Build Summary" />
</p>
<p>
The resulting output of the build (or rather the artifacts) can be found under the artifacts tab.
<br /><img src="/assets/images/20180210/ArtifactOverview.png" alt="Artifact Overview" />
</p>
<p> 
You could download the artifacts and manually release or publish them or discover the output files of the build in this tab.
</p>
</p></p>

                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2018/01/14/writing-tests-for-your-graphical-user-interface.html">Writing tests for your graphical user interface</a>
                </header>
                
                <span>Jan 14, 2018</span> <br/>
                Tags: 
                        TestAutomation
			           
                <div class="article-content">
                    <p>
In this blogpost I will be talking on how to create tests using Coded UI and Selenium. 
</p>
<p>
Coded UI is the UI testing framework from Microsoft for testing any type of UI that runs on the windows platform. This means you can test websites as well as WPF or other windows applications. Coded UI is shipped as a module on Visual Studio. Currently Coded UI is only shipped with Visual Studio Enterprise editions. For the currently automatable configurations see <a href="https://docs.microsoft.com/nl-nl/visualstudio/test/supported-configurations-and-platforms-for-coded-ui-tests-and-action-recordings" target="_blank">Supported configurations and platforms forCoded UI tests and action recordings</a>.
</p>
<p>
Coded UI supports IE website testing out of the box and you can install an extension to run tests in other browsers including Edge using Selenium drivers (another UI test framework). Note that the <a href="https://marketplace.visualstudio.com/items?itemName=AtinBansal.SeleniumcomponentsforCodedUICrossBrowserTesting" target="_blank">Selenium Cross Browser tools</a> have not been updated in a while and is no longer fully compatible with the latest version of the Selenium implementation. Updating the Selenium drivers of the cross-browser tools to the latest version will break functionality like finding a dropdown on a page. Therefor I recommend using Selenium to test your website if you want to test in multiple and the latest browsers that are not Internet Explorer. You can also use Selenium to automate actions within the browser windows and use Coded UI to manipulate the browser application itself.  (For example controlling the browser dialog windows.) Also Selenium is free and open source. If you do not have a Visual Studio Enterprise edition, definitely look into Selenium.
</p>
<p>
UI testing is a great method of automating regression tests for your applications. This way you can avoid human errors in repetitive tasks and when run during development of changes, you may possibly spot bugs before you hand of a new change to your QA team.
</p>
<p>
Please note that all the sample tests later in this blog post are just simple examples to help you get started. If you wish to build an extensive test library please look into building your own UI test framework using the page-object approach.
</p>
<h3>Setting up a Code UI project</h3>
<p>
To start with Coded UI make sure you have the Coded UI project type installed. It can be found under test projects.
<br /><img src="/assets/images/20180114/VisualStudioTestProjects.png" alt="Visual Studio Test Project Templates" />
</p>
<p>
If you do not see anything else than the Unit Test Project type, it means that you have not yet installed it. Open Visual Studio Installer, modify your Visual Studio Enterprise Edition and under Individual Components select the Coded UI test option under the Debugging and Testing section.
<br /><img src="/assets/images/20180114/VisualStudioInstaller.png" alt="Visual Studio Installation Coded UI CheckBox" />
</p>
<p> 
After creating your new Coded UI project, the project will add a test class and a UI Map file. Visual Studio will also startup the UIMap - Coded UI Test Builder. This tool is used to record or inspect elements on your screen. If you close it you can restart it by right clicking a .uitest file or Map file as they are called and select the Edit with Coded UI Test Builder option.
 <br /><img src="/assets/images/20180114/CleanCodedUIProject.png" alt="Default Coded UI Project Files And Test Builder Window" />
</p>
<p>
You can now either start coding or recording tests. If you press the record button, do some clicks in any application in your windows machine and then click the generate code button. Visual Studio will generate the code for the actions you took in the CodedUITest.cs file. All code for UI controls is placed inside the UIMap.uittest file.
</p>
<p>
Recording UI tests can be helpful to start up fast but will be less maintainable in the long run, so I wish to focus on writing tests by hand for your applications. The Coded UI Test Builder is a great tool for inspecting controls on the screen and showing you the properties that Coded UI can access. These properties can also be used to search controls as I will explain later on.
</p>
<p>
To use the Coded UI Test Builder element inspector, click and drag the circle button to any UI element that you want to inspect. You will see a blue highlight on the control that is focused. When releasing your mouse, a properties window will popup showing you the details of the control that you have selected. When inspecting an UI element in a browser it may take a second or so for the highlight to get into the page. 
</p>
<p>
A windows application example of inspecting a button is shown below:
<br /><img src="/assets/images/20180114/WindowsButtonProperties.png" alt="Windows Button Properties" />
 </p>
<p>
And here is an example of inspecting a button in a web page:
<br /><img src="/assets/images/20180114/WebButtonProperties.png" alt="Web Button Properties" />

 </p>
<h3>Setting up a simple WPF test with Coded UI</h3>
<p>
 A working sample of the code below including the sample application that it is run on can be found in my <a href="https://github.com/SamanthaNeilen/CodedUITestApplication" target="_blank">CodedUITestApplication repository</a>.
 </p>
<p>
The class containing the test must be decorated with the [CodedUITest] attribute. The test method itself is decorated with a [TestMethod] attribute.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.WinControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.WpfControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CodedUITestTestApplication.Tests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">CodedUITest</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">WindowsAppTests</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Test_WPF_Addition</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">ApplicationUnderTest</span><span class="p">.</span><span class="nf">Launch</span><span class="p">(</span><span class="s">@"..\..\..\CodedUITestApplication.WPF\bin\Debug\CodedUITestApplication.WPF.exe"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">amount1Edit</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WpfEdit</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">amount1Edit</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WpfEdit</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">AutomationId</span><span class="p">,</span> <span class="s">"txtFirstAmount"</span><span class="p">);</span>
            <span class="n">amount1Edit</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"5"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">amount2Edit</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WpfEdit</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">amount2Edit</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WpfEdit</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">AutomationId</span><span class="p">,</span> <span class="s">"txtSecondAmount"</span><span class="p">);</span>
            <span class="n">amount2Edit</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"10"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">buttonPlus</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WpfButton</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">buttonPlus</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WpfEdit</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">AutomationId</span><span class="p">,</span> <span class="s">"btnAdd"</span><span class="p">);</span>
            <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">buttonPlus</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">resultLabel</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WpfText</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">resultLabel</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WpfEdit</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">AutomationId</span><span class="p">,</span> <span class="s">"lblResult"</span><span class="p">);</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"15"</span><span class="p">,</span> <span class="n">resultLabel</span><span class="p">.</span><span class="n">DisplayText</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
As you can see, you find WPF controls by adding search properties. As long as you are adding search properties, your object in memory will not actually search for the control until you either call TryFind, use the control as parent for another new control, change a property or try to invoke an action on the control in the application. If a control is not found when calling TryFind, false is returned. In all other cases a ControlNotFound exception is thrown.
</p>
<p>
The framework uses certain timeouts when finding controls. These timeouts can be changed by accessing the static PlayBack class.
</p>
<h3>Setting up a simple Windows application test with Coded UI</h3>
<p>
In this example I just boot up and automate the windows calculator.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.WinControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.WpfControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CodedUITestTestApplication.Tests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">CodedUITest</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">WindowsAppTests</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Test_Windows_Calculator</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">ApplicationUnderTest</span><span class="p">.</span><span class="nf">Launch</span><span class="p">(</span><span class="s">@"C:\Windows\system32\calc.exe"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">button5</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WinButton</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">button5</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WinControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"5"</span><span class="p">);</span>
            <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">button5</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">buttonPlus</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WinButton</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">buttonPlus</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WinControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"Add"</span><span class="p">);</span>
            <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">buttonPlus</span><span class="p">);</span>

            <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">button5</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">buttonEquals</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WinButton</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">buttonEquals</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WinControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"Equals"</span><span class="p">);</span>
            <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">buttonEquals</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">resultText</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WinText</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
            <span class="n">resultText</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">WinControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"Result"</span><span class="p">);</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"10"</span><span class="p">,</span> <span class="n">resultText</span><span class="p">.</span><span class="n">DisplayText</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
Notice that the searching and asserting is the same as with the WPF application. Only the base class for defining the type of control is different. 
</p>
<h3>Setting up a simple web test with Coded UI</h3>
<p>
A webtest is quite similar. Here again the base class for the control is different. Also, we start a BrowserWindow instead of using ApllicationUnderTest. BrowserWindow is actually inherited from ApplicationUnderTest. You can use BrowserWindow.CurrentBrowser (before calling Launch) to determine the browser to use. The default is "IE" and you can use "Chrome" or "Firefox" to start other browsers. Note that Firefox will not start if your browser version is not supported by the  <a href="https://marketplace.visualstudio.com/items?itemName=AtinBansal.SeleniumcomponentsforCodedUICrossBrowserTesting" target="_blank">Selenium Cross Browser tools (version &gt; 47.0.1, 32 bit)</a>.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">CodedUITestApplication.Shared.Resources</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.HtmlControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="na">[CodedUITest]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">WebTests</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="kt">string</span> <span class="n">StartUrl</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"ApplicationStartUrl"</span><span class="p">];</span>

    <span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">WebTest_TestForm</span><span class="p">()</span>
    <span class="p">{</span>           
        <span class="n">BrowserWindow</span> <span class="n">browser</span> <span class="p">=</span> <span class="n">BrowserWindow</span><span class="p">.</span><span class="nf">Launch</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">StartUrl</span><span class="p">));</span>

        <span class="kt">var</span> <span class="n">nameTextBox</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlEdit</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">nameTextBox</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="s">"Name"</span><span class="p">);</span>
        <span class="n">nameTextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"Some Name"</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">submitButton</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlButton</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">submitButton</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlButton</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Type</span><span class="p">,</span> <span class="s">"submit"</span><span class="p">);</span>
        <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">submitButton</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlControl</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">header</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="s">"addCustomerHeader"</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="nf">TryFind</span><span class="p">());</span>

        <span class="kt">var</span> <span class="n">nameValidationmessage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlSpan</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">nameValidationmessage</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="s">"Name-error"</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsFalse</span><span class="p">(</span><span class="n">nameValidationmessage</span><span class="p">.</span><span class="nf">TryFind</span><span class="p">());</span>

        <span class="kt">var</span> <span class="n">expectedEmailvalidationMessage</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">Messages</span><span class="p">.</span><span class="n">FieldRequired</span><span class="p">,</span> <span class="n">Labels</span><span class="p">.</span><span class="n">EmailAddress</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">emailAddessValidationMessage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlSpan</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Class</span><span class="p">,</span> <span class="s">"field-validation-error"</span><span class="p">);</span>
        <span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">InnerText</span><span class="p">,</span> <span class="n">expectedEmailvalidationMessage</span><span class="p">,</span> 
		    <span class="n">PropertyExpressionOperator</span><span class="p">.</span><span class="n">Contains</span><span class="p">);</span>

        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="nf">TryFind</span><span class="p">());</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="n">InnerText</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">expectedEmailvalidationMessage</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3>Running a single test on multiple browsers using a data source file</h3>
<p>
<b>[Edit Feb 16 2018]</b> Note that the solution described below works for projects using the Coded UI framework. When using the default Microsoft Test V2 framework, the use of the TestSettings files is deprecated and your tests will stay undiscoverable in the Test Explorer window. See the <a href="https://github.com/SamanthaNeilen/WebDriverTestApplication" target="">WebDriverTestApplication repository</a> for running tests with the MSTest V2 framework. <b>[End edit Feb 16 2018]</b>
</p>
<p>
The default unit test framework from Microsoft can consume input files to run your tests for multiple data rows. In the following example I have added a CSV with the browsers names I want to test as data source. When this test is run the test will execute for each browser in sequence.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">CodedUITestApplication.Shared.Resources</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.HtmlControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="na">[CodedUITest]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">WebTests</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">TestContext</span> <span class="n">_testContextInstance</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">TestContext</span> <span class="n">TestContext</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_testContextInstance</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">_testContextInstance</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="kt">string</span> <span class="n">StartUrl</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"ApplicationStartUrl"</span><span class="p">];</span>

    <span class="p">[</span><span class="n">TestMethod</span><span class="p">,</span> <span class="nf">DataSource</span><span class="p">(</span><span class="s">"Browsers"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">WebTest_TestForm</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">browserIdentifier</span> <span class="p">=</span> <span class="s">"IE"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">TestContext</span><span class="p">.</span><span class="n">DataRow</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">browserIdentifier</span> <span class="p">=</span> <span class="n">TestContext</span><span class="p">.</span><span class="n">DataRow</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="nf">ToString</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">BrowserWindow</span><span class="p">.</span><span class="n">CurrentBrowser</span> <span class="p">=</span> <span class="n">browserIdentifier</span><span class="p">;</span>
        <span class="n">BrowserWindow</span> <span class="n">browser</span> <span class="p">=</span> <span class="n">BrowserWindow</span><span class="p">.</span><span class="nf">Launch</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">StartUrl</span><span class="p">));</span>

        <span class="kt">var</span> <span class="n">nameTextBox</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlEdit</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">nameTextBox</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="s">"Name"</span><span class="p">);</span>
        <span class="n">nameTextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"Some Name"</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">submitButton</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlButton</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">submitButton</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlButton</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Type</span><span class="p">,</span> <span class="s">"submit"</span><span class="p">);</span>
        <span class="n">Mouse</span><span class="p">.</span><span class="nf">Click</span><span class="p">(</span><span class="n">submitButton</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlControl</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">header</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="s">"addCustomerHeader"</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="nf">TryFind</span><span class="p">());</span>

        <span class="kt">var</span> <span class="n">nameValidationmessage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlSpan</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">nameValidationmessage</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="s">"Name-error"</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsFalse</span><span class="p">(</span><span class="n">nameValidationmessage</span><span class="p">.</span><span class="nf">TryFind</span><span class="p">());</span>

        <span class="kt">var</span> <span class="n">expectedEmailvalidationMessage</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">Messages</span><span class="p">.</span><span class="n">FieldRequired</span><span class="p">,</span> <span class="n">Labels</span><span class="p">.</span><span class="n">EmailAddress</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">emailAddessValidationMessage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HtmlSpan</span><span class="p">(</span><span class="n">browser</span><span class="p">);</span>
        <span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">Class</span><span class="p">,</span> <span class="s">"field-validation-error"</span><span class="p">);</span>
        <span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="n">SearchProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">HtmlControl</span><span class="p">.</span><span class="n">PropertyNames</span><span class="p">.</span><span class="n">InnerText</span><span class="p">,</span> <span class="n">expectedEmailvalidationMessage</span><span class="p">,</span> 
		     <span class="n">PropertyExpressionOperator</span><span class="p">.</span><span class="n">Contains</span><span class="p">);</span>

        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="nf">TryFind</span><span class="p">());</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">emailAddessValidationMessage</span><span class="p">.</span><span class="n">InnerText</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">expectedEmailvalidationMessage</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
To ensure that the Browsers datasource is present in your project, first add the file you want to use as a data source to the project. Set the properties of the file to Content and Copy always.
<br /><img src="/assets/images/20180114/FileBuildAction.png" alt="File Properties Build Action" />
</p>
<p>
Next define the data source connection string in the App.config of the test project. You will also need to add a configuration section to ensure that the configuration elements will be processed. 

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">"microsoft.visualstudio.testtools"</span> <span class="na">type=</span><span class="s">"Microsoft.VisualStudio.TestTools.UnitTesting.TestConfigurationSection, 
	    Microsoft.VisualStudio.QualityTools.UnitTestFramework, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>  
  <span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"Browsers"</span> <span class="na">connectionString=</span><span class="s">"Browsers.csv"</span> <span class="na">providerName=</span><span class="s">"Microsoft.VisualStudio.TestTools.DataSource.CSV"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
  <span class="nt">&lt;microsoft.visualstudio.testtools&gt;</span>
    <span class="nt">&lt;dataSources&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"Browsers"</span> <span class="na">connectionString=</span><span class="s">"Browsers"</span> <span class="na">dataTableName=</span><span class="s">"Browsers#csv"</span> <span class="na">dataAccessMethod=</span><span class="s">"Sequential"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/dataSources&gt;</span>
  <span class="nt">&lt;/microsoft.visualstudio.testtools&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre></figure>

</p>
<p>
Next add a TestSettings file to the solution.
<br /><img src="/assets/images/20180114/VisualStudioTestSettings.png" alt="Visual Studio Test Settings File Type" />
</p>
<p>
Open the test settings file and navigate to deployment. Check the Enable Deployment option and add the csv file that needs to be deployed when running the test. 
<br /><img src="/assets/images/20180114/DeploymentSettingBrowsers.png" alt="Deployment settings Browser tag" />
</p>
<p>
Sometimes Visual Studio will not automatically pick up the TestSettings file. If you get errors about not finding the data source first check if the TestSettings file is selected for use.
<br /><img src="/assets/images/20180114/VisualStudioTestSettingsMenu.png" alt="Visua Studio Test Settings Menu Option" />
</p>
<h3>Setting up a simple web test with Selenium</h3>
<p>
<b>[Edit Feb 16 2018]</b> Note that the solution described below works for projects using the Coded UI framework. When using the default Microsoft Test V2 framework, the use of the TestSettings files is deprecated and your tests will stay undiscoverable in the Test Explorer window. See the <a href="https://github.com/SamanthaNeilen/WebDriverTestApplication" target="">WebDriverTestApplication repository</a> for running tests with the MSTest V2 framework. <b>[End edit Feb 16 2018]</b>
</p>
<p>
In this last section I wanted to show a web test using Selenium. To be able to use Selenium in your test project first add the Selenium.Support NuGet package. This package will also automatically add the Selenium.Webdriver package.
<br /><img src="/assets/images/20180114/SeleniumNuGetPackages.png" alt="Selenium NuGet Packages" />
</p>
<p>
Next you need to download the driver executables that will actually start and control the browser. The latest driver executables can be found on the <a href="http://www.seleniumhq.org/download/" target="_blank">Selenium download page</a>.
Add them to your project and make sure that they get deployed to either the bin folder of the project or add them to the deployment configuration in the TestSettings file as explained in the "Running a single test on multiple browsers using a data source file" section of this post, so that they are in the same directory as the test project output dll.
<br /><img src="/assets/images/20180114/SeleniumDrivers.png" alt="Selenium Driver Files" />
<br /><img src="/assets/images/20180114/DeploymentSettingsSelenium.png" alt="Deployment Settings Selenium" />
</p>
<p>
After setting up, you can use the test method below to check the same functionality as the Coded UI web test in the last section. Note the different syntax but the same general idea of searching and manipulating controls.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">CodedUITestApplication.Shared.Resources</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UITesting.HtmlControls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">OpenQA.Selenium</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">OpenQA.Selenium.Chrome</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">OpenQA.Selenium.IE</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">OpenQA.Selenium.Firefox</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CodedUITestTestApplication.Tests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">CodedUITest</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">WebTests</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">TestMethod</span><span class="p">,</span> <span class="nf">DataSource</span><span class="p">(</span><span class="s">"Browsers"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">WebTest_Selenium_TestForm</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">browserIdentifier</span> <span class="p">=</span> <span class="s">"Chrome"</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">TestContext</span><span class="p">.</span><span class="n">DataRow</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">browserIdentifier</span> <span class="p">=</span> <span class="n">TestContext</span><span class="p">.</span><span class="n">DataRow</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="nf">ToString</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">driver</span> <span class="p">=</span> <span class="nf">StartWebdriver</span><span class="p">(</span><span class="n">browserIdentifier</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">driver</span><span class="p">.</span><span class="nf">Navigate</span><span class="p">().</span><span class="nf">GoToUrl</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">StartUrl</span><span class="p">));</span>

                <span class="kt">var</span> <span class="n">nameTextBox</span> <span class="p">=</span> <span class="n">driver</span><span class="p">.</span><span class="nf">FindElement</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="nf">Id</span><span class="p">(</span><span class="s">"Name"</span><span class="p">));</span>
                <span class="n">nameTextBox</span><span class="p">.</span><span class="nf">SendKeys</span><span class="p">(</span><span class="s">"Some Name"</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">submitButton</span> <span class="p">=</span> <span class="n">driver</span><span class="p">.</span><span class="nf">FindElement</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="nf">TagName</span><span class="p">(</span><span class="s">"button"</span><span class="p">));</span>
                <span class="n">submitButton</span><span class="p">.</span><span class="nf">Click</span><span class="p">();</span>

                <span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="n">driver</span><span class="p">.</span><span class="nf">FindElement</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="nf">Id</span><span class="p">(</span><span class="s">"addCustomerHeader"</span><span class="p">));</span>
                <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">Displayed</span><span class="p">);</span>

                <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">driver</span><span class="p">.</span><span class="nf">FindElements</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="nf">Id</span><span class="p">(</span><span class="s">"Name-error"</span><span class="p">)).</span><span class="n">Count</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">expectedEmailvalidationMessage</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">Messages</span><span class="p">.</span><span class="n">FieldRequired</span><span class="p">,</span> <span class="n">Labels</span><span class="p">.</span><span class="n">EmailAddress</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">validationMessages</span> <span class="p">=</span> <span class="n">driver</span><span class="p">.</span><span class="nf">FindElements</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="nf">CssSelector</span><span class="p">(</span><span class="s">".field-validation-error"</span><span class="p">));</span>
                <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">validationMessages</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">element</span> <span class="p">=&gt;</span> <span class="n">element</span><span class="p">.</span><span class="n">Displayed</span> 
                    <span class="p">&amp;&amp;</span> <span class="nf">ChildSpanContainsExpectedText</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">expectedEmailvalidationMessage</span><span class="p">)));</span>

                <span class="n">driver</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">ChildSpanContainsExpectedText</span><span class="p">(</span><span class="n">IWebElement</span> <span class="n">element</span><span class="p">,</span> <span class="kt">string</span> <span class="n">expectedEmailvalidationMessage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">element</span><span class="p">.</span><span class="nf">FindElement</span><span class="p">(</span><span class="n">By</span><span class="p">.</span><span class="nf">TagName</span><span class="p">(</span><span class="s">"span"</span><span class="p">)).</span><span class="n">Text</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">expectedEmailvalidationMessage</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">IWebDriver</span> <span class="nf">StartWebdriver</span><span class="p">(</span><span class="kt">string</span> <span class="n">browserIdentifier</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">browserIdentifier</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="s">"IE"</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">InternetExplorerDriver</span><span class="p">();</span>
                <span class="k">case</span> <span class="s">"Firefox"</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">FirefoxDriver</span><span class="p">();</span>
                <span class="k">case</span> <span class="s">"Chrome"</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">ChromeDriver</span><span class="p">();</span>
                <span class="k">default</span><span class="p">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotSupportedException</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3>Resources</h3>
<p>
<a href="https://app.pluralsight.com/library/courses/codedui-test-automation/table-of-contents" target="_blank">Pluralsight- Coded UI</a><br />
<a href="https://app.pluralsight.com/library/courses/selenium/table-of-contents" target="_blank">Pluralsight- Selenium</a><br />
<a href="https://docs.microsoft.com/nl-nl/visualstudio/test/use-ui-automation-to-test-your-code" target="_blank">Microsoft docs - Use UI Automation To Test Your Code</a><br />
<a href="http://www.seleniumhq.org/" target="_blank">Selenium HQ</a><br />
</p>

                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2017/12/29/tips-for-making-your-code-more-suitable-for-unit-tests.html">Tips for making your code more suitable for unit testing</a>
                </header>
                
                <span>Dec 29, 2017</span> <br/>
                Tags: 
                        TestAutomation
			           
                <div class="article-content">
                    <p>
Unit tests are important to test your business logic. Unit tests should not call actual services or the database and they should be able to run within a few minutes.
In this blogpost I want to give a few tips on how to make your codebase more suitable for writing unit tests.
</p>
<h3>Interfaces and dependency injection</h3>
<p>
When dealing with legacy code you will often find that different functional classes are called with the new keyword throughout other functional classes. This will often get in the way of writing a true unit test that only tests the method that you are working on.
Mitigate the problem by extracting an interface for the class whose functionality you want to access and instead pass the interface into the constructor of the class that will use the class. 
An example of code that instantiates a direct link to an Entity Framework database context is shown below.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;</span> <span class="nf">GetCustomerOverview</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nf">ECommerceDbContext</span><span class="p">()).</span><span class="n">Customer</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">customer</span><span class="p">.</span><span class="n">Deleted</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="nf">MapToCustomerViewModel</span><span class="p">().</span><span class="nf">Compile</span><span class="p">());</span>
    <span class="p">}</span>
	
    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">,</span> <span class="n">CustomerViewModel</span><span class="p">&gt;&gt;</span> <span class="nf">MapToCustomerViewModel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">customer</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">CustomerViewModel</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="n">EmailAdress</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">EmailAdress</span><span class="p">,</span>
            <span class="n">PhoneNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">,</span>
            <span class="n">Street</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Street</span><span class="p">,</span>
            <span class="n">HouseNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumber</span><span class="p">,</span>
            <span class="n">HouseNumberExtension</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumberExtension</span><span class="p">,</span>
            <span class="n">ZipCode</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">ZipCode</span><span class="p">,</span>
            <span class="n">City</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">City</span><span class="p">,</span>
            <span class="n">Country</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Country</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
The GetCustomerOverview method above cannot be unit tested because all calls to the method will actually instantiate the Entity Framework context with a actual calls to the underlying database.
A refactored CustomerService with interfaces passed through the constructor is shown below.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IECommerceDbContext</span> <span class="n">_eCommerceDbContext</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CustomerService</span><span class="p">(</span><span class="n">IECommerceDbContext</span> <span class="n">eCommerceDbContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_eCommerceDbContext</span> <span class="p">=</span> <span class="n">eCommerceDbContext</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;</span> <span class="nf">GetCustomerOverview</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">customer</span><span class="p">.</span><span class="n">Deleted</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="nf">MapToCustomerViewModel</span><span class="p">().</span><span class="nf">Compile</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">,</span> <span class="n">CustomerViewModel</span><span class="p">&gt;&gt;</span> <span class="nf">MapToCustomerViewModel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">customer</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">CustomerViewModel</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="n">EmailAdress</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">EmailAdress</span><span class="p">,</span>
            <span class="n">PhoneNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">,</span>
            <span class="n">Street</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Street</span><span class="p">,</span>
            <span class="n">HouseNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumber</span><span class="p">,</span>
            <span class="n">HouseNumberExtension</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumberExtension</span><span class="p">,</span>
            <span class="n">ZipCode</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">ZipCode</span><span class="p">,</span>
            <span class="n">City</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">City</span><span class="p">,</span>
            <span class="n">Country</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Country</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
The interface for my DbContext is shown below.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">interface</span> <span class="nc">IECommerceDbContext</span>
<span class="p">{</span>
    <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">Customer</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">int</span> <span class="nf">SaveChanges</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>
Now you can create a unit test to the GetCustomerOverview method. I will describe how to create a mock Entity Framework class in the next section of this post.
</p>
<p>
If you are not using Entity Framework Code First but using the database designer, you must create a separate partial class of your DbContext and set the interface inheritance in the new custom partial class. If you add an interface in the generated file, it will be lost at the next code generation from the model.
</p>
<p>
Making sure that all dependencies are passed to a class via the constructor is called dependency injection. To ensure that you do not have to new up all the dependencies in the constructors in the UI or other top layer of your application you can leverage a framework like <a href="https://msdn.microsoft.com/en-us/library/dn178463(v=pandp.30).aspx" target="_blank">Unity</a> to handle all the dependency injection for you. An example of this can be found in my <a href="https://github.com/SamanthaNeilen/ECommerceSampleApplication" target="_blank">ECommerceSampleApplication repository</a> in the ECommerceApp.NetFramework.Web project. The Unity NuGet packages combined with a unity configuration file section map all the interfaces with the concrete implementations. .Net Core has a built in dependency injection framework.
</p>
<p>
When writing tests you will want to call only specific calls of an interface during a test. You can use a mocking framework like Moq to create and verify fake behavior on interface calls. More information and examples of Moq can be found <a target="_blank" href="https://github.com/Moq/moq4/wiki/Quickstart">here</a>.
</p>
<h3>Mocking Entity Framework</h3>
<p>
When using Entity Framwork 6 and onward you can use the mock implementation in <a href="https://msdn.microsoft.com/en-us/library/dn314431(v=vs.113).aspx" target="_blank">this MSDN post</a> to simulate an entity framework without having to use a mocking framework to mock out all the calls.
</p>
<p>
An example of a testclass, using the mock framework and the refactored GetCustomerOverview method of the previous section, would look like the code snippet below (This test class uses <a href="https://github.com/nunit/docs/wiki/NUnit-Documentation" target="_blank">the NUnit framework</a> for writing and running the tests):
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerServiceTests</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">IECommerceDbContext</span> <span class="n">_eCommerceDbContext</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">CustomerService</span> <span class="n">_customerService</span><span class="p">;</span>

    <span class="p">[</span><span class="n">SetUp</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_eCommerceDbContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockECommerceDbContext</span><span class="p">();</span>
        <span class="n">_customerService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CustomerService</span><span class="p">(</span><span class="n">_eCommerceDbContext</span><span class="p">);</span>

        <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Test customer 1"</span><span class="p">,</span> <span class="n">Deleted</span> <span class="p">=</span> <span class="k">false</span> <span class="p">});</span>
        <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Test customer 2"</span><span class="p">,</span> <span class="n">Deleted</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
        <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Test customer 3"</span><span class="p">,</span> <span class="n">Deleted</span> <span class="p">=</span> <span class="k">false</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">GetCustomerOverview_Should_Return_Non_Deleted_Customers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ACT
</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">_customerService</span><span class="p">.</span><span class="nf">GetCustomerOverview</span><span class="p">();</span>

        <span class="c1">// ASSERT
</span>
        <span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOf</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;&gt;(</span><span class="n">result</span><span class="p">);</span>            
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="m">1</span><span class="p">));</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsFalse</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="m">2</span><span class="p">));</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="m">3</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
My mock DbContext implementation is shown below:
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">MockECommerceDbContext</span> <span class="p">:</span> <span class="n">IECommerceDbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">MockECommerceDbContext</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Customer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TestDbSet</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">Customer</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">SaveChangesCount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="nf">SaveChanges</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">SaveChangesCount</span><span class="p">++;</span>
        <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
The implementation of the TestDbSet is found in the MSDN post referenced earlier in this section.
When using Entity Framework below version 6 look at the same MSDN post on how to write unit tests using interfaces and mock classes for the Entity Framework database context.
</p>
<h3>Dealing with 3rd party classes</h3>
<p>
When writing .Net code you will probably use NuGet packages or other 3rd party references that do not always have interfaces available. 
The class below uses 2 external packages. FileHelpers to enable CSV exports and DotNetZip to create a ZipFile on the filesystem. 
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ExportService</span><span class="p">:</span> <span class="n">IExportService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_exportLocation</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"ExportLocation"</span><span class="p">];</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">_customerOverviewExportName</span> <span class="p">=</span> <span class="s">"CustomerOverview"</span><span class="p">;</span>      

    <span class="k">public</span> <span class="n">IZipFile</span> <span class="nf">CreateCustomerOverviewZipFile</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">_exportLocation</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Directory</span><span class="p">.</span><span class="nf">CreateDirectory</span><span class="p">(</span><span class="n">_exportLocation</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">customerOverViewExportFileLocation</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_exportLocation</span><span class="p">}{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.csv"</span><span class="p">;</span>
        <span class="nf">CreateExportFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">ZipExportFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">ZipFile</span> <span class="nf">ZipExportFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">customerOverViewExportFileLocation</span><span class="p">)</span>
    <span class="p">{</span>            
        <span class="kt">var</span> <span class="n">zipfile</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ZipFile</span><span class="p">();</span>
        <span class="n">zipfile</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.zip"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">zipentry</span> <span class="p">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="nf">AddFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">);</span>
        <span class="n">zipentry</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.csv"</span><span class="p">;</span>
        <span class="n">zipfile</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">_exportLocation</span><span class="p">}{</span><span class="n">zipfile</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">zipfile</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">CreateExportFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">customerOverViewExportFileLocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">customerData</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="nf">ECommerceDbContext</span><span class="p">()).</span><span class="n">Customer</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">customer</span><span class="p">.</span><span class="n">Deleted</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="nf">MapToCustomerExportModel</span><span class="p">().</span><span class="nf">Compile</span><span class="p">());</span>

        <span class="p">(</span><span class="k">new</span> <span class="n">FileHelperEngine</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;()).</span><span class="nf">WriteFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">,</span> <span class="n">customerData</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">,</span> <span class="n">CustomerExport</span><span class="p">&gt;&gt;</span> <span class="nf">MapToCustomerExportModel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">customer</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">CustomerExport</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="n">EmailAdress</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">EmailAdress</span><span class="p">,</span>
            <span class="n">PhoneNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">,</span>
            <span class="n">Street</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Street</span><span class="p">,</span>
            <span class="n">HouseNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumber</span><span class="p">,</span>
            <span class="n">HouseNumberExtension</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumberExtension</span><span class="p">,</span>
            <span class="n">ZipCode</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">ZipCode</span><span class="p">,</span>
            <span class="n">City</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">City</span><span class="p">,</span>
            <span class="n">Country</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Country</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
The FileHelperEngine class already has an interface and can be easily refactored but the ZipFile implementation does not. The ZipFile class also does not allow itself to be mocked properly. 
</p>
<p>
A solution to mitigate these issues is to create an Inherited object on which we can create an interface and thus create a mock object. The inherited object which I have called Adapter after the <a href="https://en.wikipedia.org/wiki/Adapter_pattern" target="_blank">Adapter Design principle</a> is shown below.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ZipFileAdapter</span> <span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">IZipFile</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ZipFileAdapter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">UseZip64WhenSaving</span> <span class="p">=</span> <span class="n">Zip64Option</span><span class="p">.</span><span class="n">AsNecessary</span><span class="p">;</span>
        <span class="n">CompressionLevel</span> <span class="p">=</span> <span class="n">CompressionLevel</span><span class="p">.</span><span class="n">BestCompression</span><span class="p">;</span>
    <span class="p">}</span>        

    <span class="n">IZipEntry</span> <span class="n">IZipFile</span><span class="p">.</span><span class="nf">AddFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">location</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ZipEntryAdapter</span><span class="p">(</span><span class="nf">AddFile</span><span class="p">(</span><span class="n">location</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IZipFile</span>
<span class="p">{</span>
    <span class="n">Zip64Option</span> <span class="n">UseZip64WhenSaving</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">CompressionLevel</span> <span class="n">CompressionLevel</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">IZipEntry</span> <span class="nf">AddFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">location</span><span class="p">);</span>
    <span class="k">void</span> <span class="nf">Save</span><span class="p">(</span><span class="kt">string</span> <span class="n">location</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Because I also wanted to use the created ZipEntry after calling AddFile I also had to create an Adapter for the ZipEntry class. The implementation of this class is shown below.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ZipEntryAdapter</span> <span class="p">:</span> <span class="n">IZipEntry</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">ZipEntry</span> <span class="n">_zipEntry</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ZipEntryAdapter</span><span class="p">(</span><span class="n">ZipEntry</span> <span class="n">zipEntry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_zipEntry</span> <span class="p">=</span> <span class="n">zipEntry</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FileName</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_zipEntry</span><span class="p">.</span><span class="n">FileName</span><span class="p">;</span> <span class="p">}</span> <span class="k">set</span> <span class="p">{</span> <span class="n">_zipEntry</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IZipEntry</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">FileName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
Notice that in the adapters above that I only implemented and extracted the interfaces that I actually use. It is not necessary to extract all the functionality of the third party code if you never call it. 
</p>
<p>
Now that I have interfaces for all my ExportService dependencies I can refactor my ExportService class and write the appropriate unittest for the public CreateCustomerOverviewZipFile method.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ExportService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_exportLocation</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"ExportLocation"</span><span class="p">];</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">_customerOverviewExportName</span> <span class="p">=</span> <span class="s">"CustomerOverview"</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IFileHelperEngine</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;</span> <span class="n">_fileExporter</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IECommerceDbContext</span> <span class="n">_eCommerceDbContext</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ExportService</span><span class="p">(</span><span class="n">IFileHelperEngine</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;</span> <span class="n">fileExporter</span><span class="p">,</span> <span class="n">IECommerceDbContext</span> <span class="n">eCommerceDbContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_fileExporter</span> <span class="p">=</span> <span class="n">fileExporter</span><span class="p">;</span>
        <span class="n">_eCommerceDbContext</span> <span class="p">=</span> <span class="n">eCommerceDbContext</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IZipFile</span> <span class="nf">CreateCustomerOverviewZipFile</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">_exportLocation</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Directory</span><span class="p">.</span><span class="nf">CreateDirectory</span><span class="p">(</span><span class="n">_exportLocation</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">customerOverViewExportFileLocation</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_exportLocation</span><span class="p">}{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.csv"</span><span class="p">;</span>

        <span class="nf">CreateExportFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">ZipExportFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">IZipFile</span> <span class="nf">ZipExportFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">customerOverViewExportFileLocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UnityContainer</span><span class="p">();</span>
        <span class="n">container</span><span class="p">.</span><span class="nf">LoadConfiguration</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">zipfile</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IZipFile</span><span class="p">&gt;();</span>
        <span class="n">zipfile</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.zip"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">zipentry</span> <span class="p">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="nf">AddFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">);</span>
        <span class="n">zipentry</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.csv"</span><span class="p">;</span>
        <span class="n">zipfile</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">_exportLocation</span><span class="p">}{</span><span class="n">zipfile</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">zipfile</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">CreateExportFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">customerOverViewExportFileLocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">customerData</span> <span class="p">=</span> <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">customer</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">customer</span><span class="p">.</span><span class="n">Deleted</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="nf">MapToCustomerExportModel</span><span class="p">().</span><span class="nf">Compile</span><span class="p">());</span>

        <span class="n">_fileExporter</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="n">customerOverViewExportFileLocation</span><span class="p">,</span> <span class="n">customerData</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">,</span> <span class="n">CustomerExport</span><span class="p">&gt;&gt;</span> <span class="nf">MapToCustomerExportModel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">customer</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">CustomerExport</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="n">EmailAdress</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">EmailAdress</span><span class="p">,</span>
            <span class="n">PhoneNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">,</span>
            <span class="n">Street</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Street</span><span class="p">,</span>
            <span class="n">HouseNumber</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumber</span><span class="p">,</span>
            <span class="n">HouseNumberExtension</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">HouseNumberExtension</span><span class="p">,</span>
            <span class="n">ZipCode</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">ZipCode</span><span class="p">,</span>
            <span class="n">City</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">City</span><span class="p">,</span>
            <span class="n">Country</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Country</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ExportServiceTests</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_exportLocation</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"ExportLocation"</span><span class="p">];</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">_customerOverviewExportName</span> <span class="p">=</span> <span class="s">"CustomerOverview"</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">_customerOverViewExportFileLocation</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IFileHelperEngine</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;&gt;</span> <span class="n">_mockFileExporter</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">IECommerceDbContext</span> <span class="n">_eCommerceDbContext</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">ExportService</span> <span class="n">_exportService</span><span class="p">;</span>

    <span class="p">[</span><span class="n">SetUp</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_customerOverViewExportFileLocation</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_exportLocation</span><span class="p">}{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.csv"</span><span class="p">;</span>
        <span class="n">_eCommerceDbContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockECommerceDbContext</span><span class="p">();</span>
        <span class="n">_mockFileExporter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IFileHelperEngine</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;&gt;();</span>
        <span class="n">_exportService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ExportService</span><span class="p">(</span><span class="n">_mockFileExporter</span><span class="p">.</span><span class="n">Object</span><span class="p">,</span> <span class="n">_eCommerceDbContext</span><span class="p">);</span>

        <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Test customer 1"</span><span class="p">,</span> <span class="n">Deleted</span> <span class="p">=</span> <span class="k">false</span> <span class="p">});</span>
        <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Test customer 2"</span><span class="p">,</span> <span class="n">Deleted</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
        <span class="n">_eCommerceDbContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Test customer 3"</span><span class="p">,</span> <span class="n">Deleted</span> <span class="p">=</span> <span class="k">false</span> <span class="p">});</span>

        <span class="n">_mockFileExporter</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">exporter</span> <span class="p">=&gt;</span> <span class="n">exporter</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="n">_customerOverViewExportFileLocation</span><span class="p">,</span> <span class="nf">NonDeletedCustomers</span><span class="p">())).</span><span class="nf">Verifiable</span><span class="p">();</span>
    <span class="p">}</span>


    <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">CreateCustomerOverviewZipFile_Should_Export_Non_Deleted_Customers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ACT
</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">_exportService</span><span class="p">.</span><span class="nf">CreateCustomerOverviewZipFile</span><span class="p">();</span>

        <span class="c1">// ASSERT
</span>
        <span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOf</span><span class="p">&lt;</span><span class="n">IZipFile</span><span class="p">&gt;(</span><span class="n">result</span><span class="p">);</span>
        <span class="n">_mockFileExporter</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">exporter</span> <span class="p">=&gt;</span> <span class="n">exporter</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="n">_customerOverViewExportFileLocation</span><span class="p">,</span> <span class="nf">NonDeletedCustomers</span><span class="p">()));</span>
        <span class="kt">var</span> <span class="n">mockZipfile</span> <span class="p">=</span> <span class="n">result</span> <span class="k">as</span> <span class="n">MockZipFile</span><span class="p">;</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">mockZipfile</span><span class="p">.</span><span class="n">ZipEntries</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">_customerOverviewExportName</span><span class="p">}</span><span class="s">.csv"</span><span class="p">,</span> <span class="n">mockZipfile</span><span class="p">.</span><span class="n">ZipEntries</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">FileName</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">_customerOverViewExportFileLocation</span><span class="p">,</span> <span class="n">mockZipfile</span><span class="p">.</span><span class="n">ZipEntries</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Location</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;</span> <span class="nf">NonDeletedCustomers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">It</span><span class="p">.</span><span class="n">Is</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CustomerExport</span><span class="p">&gt;&gt;(</span><span class="n">customerExports</span> <span class="p">=&gt;</span>
                        <span class="n">customerExports</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">export</span> <span class="p">=&gt;</span> <span class="n">export</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"Test customer 1"</span><span class="p">)</span>
                        <span class="p">&amp;&amp;</span> <span class="n">customerExports</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">export</span> <span class="p">=&gt;</span> <span class="n">export</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"Test customer 3"</span><span class="p">)</span>
                        <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">customerExports</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">export</span> <span class="p">=&gt;</span> <span class="n">export</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"Test customer 2"</span><span class="p">)</span>
                    <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2017/11/24/managing-a-sql-server-database-from-a-visual-studio-database-project.html">Managing a SQL Server database from a Visual Studio Database project</a>
                </header>
                
                <span>Nov 24, 2017</span> <br/>
                Tags: 
                        VisualStudio
			           
                        SQLServer
			           
                <div class="article-content">
                    <p>
	When building an application I also want to manage changes to the database from source control. One of the ways of doing this is with a Visual Studio SQL Server Database project. It integrates well with source control and can be integrated in automatic deployments.
</p>
<p>
	All screenshots and used techniques that are written in this post are available within Visual Studio 2017 community edition and SQL Server 2017 express edition that are both free downloads.
</p>
<p>
	The SQL Server Database project type can be found in the New Project window under de SQL Server templates as shown below:<br />
	<img src="/assets/images/20171124/DatabaseProject.png" alt="Database Project" />
<p>
<p>
	This project will just create an empty project without any objects.<br />
	<img src="/assets/images/20171124/EmptyDatabaseProjectSolution.png" alt="Empty Database Project Solution Explorer" />
</p>
<p>
	You can now start to adding new items like tables, views, stored procedures and all kinds of other SQL Server database objects. A good practice is to put these objects into folders representing the different database objects for better maintainability.
	You can also import objects from an existing database by right clicking on the project and select Import from the available options ( the import database and dacpac options are only available when the database project is still empty).
</p> 
<p>
	When creating an object like a table, Visual Studio will show an editor as shown in the image below. You can leverage the designer combined with the properties window to define fields and column settings or just type in the SQL statements in the T-SQL window on the lower left side.
	Below you can see an example of how I created a simple Customer table.<br />
	<img src="/assets/images/20171124/DesignView.png" alt="Designer View Visual Studio" />
</p>
<p>
	After creating or changing objects in your project you can publish these changes to a database with the Schema Compare option in the project context menu.<br />
	<img src="/assets/images/20171124/SchemaCompareContextMenu.png" alt="Schema Compare Context Option" />
</p>
<p>
	Use the select target drop down to go through the dialogs to select the database that you want to publish to.<br />
	<img src="/assets/images/20171124/SchemaCompareSelectTarget.png" alt="Schema Compare Select Target" />
</p>
<p>
	After selecting the database the Compare button on the upper left will become enabled and you can click it to kick off the compare between your database and the project. You can click on an object to see the changes between the specific objects.<br />
	<img src="/assets/images/20171124/SchemaCompareTableChanges.png" alt="Schema Compare Table changes" />
</p>
<p>
	If you want to update the database to reflect the changes made, click the update button. You can deselect unwanted changes with the checkboxes in the Action column of the SchemaCompare tab. Visual Studio will show if the changes were successful and give you some options to view details.<br />
	<img src="/assets/images/20171124/SchemaCompareUpdateSuccesful.png" alt="Schema Compare Update Succesful" />
</p>
<p>
	When the update fails, when you for example add a new non nullable column without a default value or deleting a column with data, the results will show like below:<br />
	<img src="/assets/images/20171124/SchemaCompareUpdateFailed.png" alt="Schema Compare Update Failed" />
</p>
<p>
	By clicking View Results you see the script that was run but also a tab that shows the message of what went wrong.<br />
	<img src="/assets/images/20171124/SchemaCompareUpdateFailedMessage.png" alt="Schema Compare Update Failed Message" />
</p>
<p>
	You can either force the data loss by changing the schema compare options via the gear icon of the schema compare tab  as shown below or run an update script to mitigate the data loss.<br />
	<img src="/assets/images/20171124/SchemaCompareOptions.png" alt="Schema Compare Options" />
</p>
<p>
	In my case I had a faulty existing Countr column that did not match a newly created Country column. To get schema compare to update my database I had to created a data migration pre-upgrade script as shown below.
</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="mi">1</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">columns</span> <span class="k">WHERE</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Countr'</span> <span class="k">AND</span> <span class="n">Object_ID</span> <span class="o">=</span> <span class="n">Object_ID</span><span class="p">(</span><span class="n">N</span><span class="s1">'dbo.Customer'</span><span class="p">))</span>
	<span class="k">AND</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="mi">1</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">columns</span> <span class="k">WHERE</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">'Country'</span> <span class="k">AND</span> <span class="n">Object_ID</span> <span class="o">=</span> <span class="n">Object_ID</span><span class="p">(</span><span class="n">N</span><span class="s1">'dbo.Customer'</span><span class="p">))</span>
<span class="k">BEGIN</span>
	<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Customer</span> <span class="k">ADD</span> <span class="n">Country</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NULL</span>
 
	<span class="k">DECLARE</span> <span class="o">@</span><span class="n">sqlCommand</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'UPDATE Customer SET Country = Countr'</span>
	<span class="k">EXEC</span><span class="p">(</span><span class="o">@</span><span class="n">sqlCommand</span><span class="p">)</span>
 
	<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Customer</span> <span class="k">DROP</span> <span class="n">Countr</span>
<span class="k">END</span></code></pre></figure>

<p>
	The update is a dynamic statement  because the script will not compile with a column name that does not exist before the upgrade script has been run. Notice that the IF statement is very specific to this change in the database. This is because we can add this script as a Pre-Deployment Script to the database project.<br />
	<img src="/assets/images/20171124/ScriptFileOptions.png" alt="Script File Options" />
</p>
<p>
	Even if we have to run the script manually when using a schema compare, Pre- and Post-Deployment scripts will be run automatically when running the database project (F5) on a database, or when deploying the bacpac file that is the output of this project (found in the bin folder after building the project). The connection string that is used when running/debugging the project can be found and changed in the properties pages of the project in the Debug tab. There is also a SQL Script in the output folder that can be used to upgrade a database. The Pre- and Post-Deployment scripts are contained within the SQL script that is the output of the project.<br />
	<img src="/assets/images/20171124/ProjectPropertyPages.png" alt="Project Property Pages" />
</p>
<p>
	Once all known instances of the database are updated with the specific Pre-Deployment script. It can be removed to avoid clutter of the project. 
	The specific IF statement will ensure that the statements are only run on a database that can do the specific data migration and skips it when creating a completely new instance.
</p>
<p>
	These projects are really only for managing schema information not data. If you want to secure your data, you need to create regular (scheduled) backups of your database. 
	We can use Post-Deployment scripts to add seed data to tables when they are empty. An example is show below:
</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="n">TOP</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">[</span><span class="n">Name</span><span class="p">]</span> <span class="k">FROM</span> <span class="n">Customer</span><span class="p">)</span>
<span class="k">BEGIN</span>
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customer</span> <span class="p">([</span><span class="n">Name</span><span class="p">],[</span><span class="n">Emailadress</span><span class="p">],[</span><span class="n">Phonenumber</span><span class="p">],[</span><span class="n">Street</span><span class="p">],</span> <span class="p">[</span><span class="n">Housenumber</span><span class="p">],</span> <span class="p">[</span><span class="n">HousenumberExtension</span><span class="p">],</span> <span class="p">[</span><span class="n">Zipcode</span><span class="p">],</span> <span class="p">[</span><span class="n">City</span><span class="p">],</span> <span class="p">[</span><span class="n">Country</span><span class="p">])</span>
	<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'My test customer 1'</span><span class="p">,</span> <span class="s1">'company@testcompany1.com'</span><span class="p">,</span> <span class="s1">'0123456789'</span><span class="p">,</span> <span class="s1">'TestStreet'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'1111AA'</span><span class="p">,</span> <span class="s1">'TestCity'</span><span class="p">,</span> <span class="s1">'TestCountry'</span><span class="p">);</span>
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customer</span> <span class="p">([</span><span class="n">Name</span><span class="p">],[</span><span class="n">Emailadress</span><span class="p">],[</span><span class="n">Phonenumber</span><span class="p">],[</span><span class="n">Street</span><span class="p">],</span> <span class="p">[</span><span class="n">Housenumber</span><span class="p">],</span> <span class="p">[</span><span class="n">HousenumberExtension</span><span class="p">],</span> <span class="p">[</span><span class="n">Zipcode</span><span class="p">],</span> <span class="p">[</span><span class="n">City</span><span class="p">],</span> <span class="p">[</span><span class="n">Country</span><span class="p">])</span>
	<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'My test customer 2'</span><span class="p">,</span> <span class="s1">'info@somecompany.com'</span><span class="p">,</span> <span class="s1">'0112233445'</span><span class="p">,</span> <span class="s1">'SomeStreet'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'5555UD'</span><span class="p">,</span> <span class="s1">'SomeCity'</span><span class="p">,</span> <span class="s1">'TestCountry'</span><span class="p">);</span>
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customer</span> <span class="p">([</span><span class="n">Name</span><span class="p">],[</span><span class="n">Emailadress</span><span class="p">],[</span><span class="n">Phonenumber</span><span class="p">],[</span><span class="n">Street</span><span class="p">],</span> <span class="p">[</span><span class="n">Housenumber</span><span class="p">],</span> <span class="p">[</span><span class="n">HousenumberExtension</span><span class="p">],</span> <span class="p">[</span><span class="n">Zipcode</span><span class="p">],</span> <span class="p">[</span><span class="n">City</span><span class="p">],</span> <span class="p">[</span><span class="n">Country</span><span class="p">])</span>
	<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'My test customer 3'</span><span class="p">,</span> <span class="s1">'company3@test.com'</span><span class="p">,</span> <span class="s1">'0997654432'</span><span class="p">,</span> <span class="s1">'StreetStuff'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'8261SK'</span><span class="p">,</span> <span class="s1">'CityStuff'</span><span class="p">,</span> <span class="s1">'TestCountry'</span><span class="p">);</span>
<span class="k">END</span></code></pre></figure>

<p>
	So now we have project that can be plugged into source control. All the objects are stored as SQL files and work well in source control comparing and merging.
	If you have any manual scripts, that you might want to run periodicly, store them with the solution in a seperate solution items folder so they will not be compiled into the project output.
</p>
<p>
	The dacpac files that are the output of the project can be used by an automated or manual deployment process to change the databases in your environments. Once you update the database, it will remember the version of the dacpac used to update the database. The project has a refactorlog file reflecting all changes made in a sequential form. Once  a dacpac version has been applied with the changes and you want to run the dacpac again after making manual modifications to the database, it will not be able to restore properly to the intended database state .This is why during development you will usually be using the Schema Compare functionality and running 
	Pre- and Post-Deployment scripts manually untill all changes are ready and the dacpac reflecting the next sequential update will be pushed out to your testing and eventualy production environments.
</p>
<p>
	If you have a dacpac file you can deploy it in manually in SQL Server Management Studio with the option below for a new database:<br />
	<img src="/assets/images/20171124/ManagementStudioDeploy.png" alt="SQL Management Studio Deploy" />
</p>
<p>
	Or use the option below on an existing database to upgrade it:<br />
	<img src="/assets/images/20171124/ManagementStudioUpgrade.png" alt="SQL Management Studio Upgrade" />
</p>
<p>
	If you are using VSTS for authomatic deployments, you can add a step to deploy dacpac files.
</p>
<p>
	Below are some references to documentation about the topics discussed in this post:<br />
	<a href="https://docs.microsoft.com/en-us/sql/relational-databases/data-tier-applications/data-tier-applications" target="_blank">Microsoft Docs page for data-tier applications</a> <br />
	<a href="https://docs.microsoft.com/en-us/visualstudio/data-tools/creating-and-managing-databases-and-data-tier-applications-in-visual-studio" target="_blank">Microsoft Docs page for database projects</a>
</p>
</p></p>

                </div>
            </article>
        
            <article>
                <header class="article-header">
                    <a href="/2017/11/18/starting-my-blog.html">Starting my blog</a>
                </header>
                
                <span>Nov 18, 2017</span> <br/>
                Tags: 
                        Blog
			           
                        Jekyll
			           
                <div class="article-content">
                    <p>
	I would like to start my blog with a post of how I set up this blog. 
<p>
<p>
	When you start a Github account you can use a repository with the name username.github.io to host a website. That website will be hosted at the url <a href="#">https://username.github.com</a>. These websites on Github are called Github Pages. You can also create a website for a specific repository. Seeing as you can create a free Github account as long as you don't want or need private repositories, this is a great way to host a blog or website for free. For more information see <a href="https://pages.github.com/" target="_blank">Github Pages</a>. 
</p>
<p>
	Github pages promotes Jekyll as a tool to build static websites. It's not officially supported from windows but so for installing it and running it on my Windows 10 (2017 Fall Creators Update) has worked out fine so far.
	See <a href="https://jekyllrb.com/" target="_blank">the Jekyll website</a> for installation instructions.
</p>
<p>
There were a few points in the installation that I had to look up because of my unfamiliarity with Linux so I've included a description below of the steps taken after installing the Ubuntu store app from windows.
</p>
<h3>Installing Jekyll on windows10</h3>
<p>
After I installed the Ubuntu app and started it as an Administrator I got an error. The link in the error shows you to the MSDN page explaining that you have to run a Powershell command to actually enable the Linux subsystem for Windows.
For more information see: <a href="https://msdn.microsoft.com/en-us/commandline/wsl/install-win10" target="_blank">Install the Windows Subsystem for Linux</a>.
</p>
<p>
The command that needs to be run (as administrator in Powershell) was:

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">Enable-WindowsOptionalFeature <span class="nt">-Online</span> <span class="nt">-FeatureName</span> Microsoft-Windows-Subsystem-Linux</code></pre></figure>

</p>
<p>
	After the reboot start the Ubuntu terminal app again as administrator. It will now show the screen below:<br />
	<img src="/assets/images/20171118/UbuntuInstallingMessage.png" alt="Ubuntu Installing Message" />
</p>
<p>
The terminal actually froze up for me the first time here, so if it's not continuing after a few minutes, just close and restart the app. (This may happen a few times when configuring the shell or downloading and updating the packages needed to install Jekyll. Also sometimes the editor seems to not take keyboard input when prompted to press enter or cntrl-c, when that happens click a few times within the editor to get the focus back correctly in the terminal and it will accept the command.)
</p>
<p>
When it's done, you will see an active command line with root@computername:~#<br />
Enter the command below to start bash (the Jekyll website just stated bash without the sudo keyword but the sudo keyword is needed).

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>bash</code></pre></figure>

</p>
<p>
It may prompt you for a username and password. (Be aware you will need that password every time you start up bash. Also the text cursor will not show any signs off accepting input like stars or underscores but it will register your keystrokes). I have installed the terminal on 2 different computers. On one I did not get prompted for the separate login on the other I did need it.
</p>
<p>
Run the commands as provided on the Jekyll site for <a href="https://jekyllrb.com/docs/windows/" target="_blank">the installation on windows</a>. When it shows multiple commands in one code block run them per command and don't paste them in all at once). 
</p>
<p>
Also it may give the message below. You can continue by pressing enter and run the next command when it finishes. <br />
<img src="/assets/images/20171118/BrightboxRubyMessage.png" alt="BrightBox Ruby Message" />
</p>
<p>
After all the commands have run and Jekyll is returning a version number you can navigate to a windows folder to create your first Jekyll website. The Ubuntu terminal is run from a separate sub filesystem so you need to enter the command below to navigate to your C:\ drive. 

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /mnt/c/</code></pre></figure>

</p>
<p>
From the C:\ directory you can just use the "dir" and "cd" commands to navigate to the appropriate folder the same way you would in a Windows command prompt. To create a new Jekyll website within your current folder use the command below. (note that you do not need to use the sudo keyword any more.)

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">jekyll new .</code></pre></figure>

</p>
<p>
After it has finished you have a working default website that you van run with the command below.

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">jekyll serve</code></pre></figure>

</p>
<h3>Customising your site</h3>
<p>
You can now add pages like the one already generated in your _posts folder and alter the _config.yml file to populate the contents of your generated site.
</p>
<p>
Every time you make a change when Jekyll serve command is active or when you issue a Jekyll build command the contents of the _site folder get updated with the generated HTML site that you can access with your browser. This is also the content you can upload to your Git repository and thus will be hosted on your username.github.io website.<br />
<img src="/assets/images/20171118/JekyllDefaultPage.png" alt="Jekkyl Default Page" />
</p>
<p>
As you may notice the default site is quite barren but you do not see the files for the page layouts or the stylesheets. These files can be found in the folder that holds the default theme. It was installed with the other bundles in the Ubuntu terminal. As stated in the <a href="https://jekyllrb.com/docs/structure/">Jekyll documentation</a> ( you can find out where those files are located with the command below.

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">bundle show minima</code></pre></figure>

</p>
<p>
You can copy the files from the theme folder and copy them into the folder of your Jekyll page to completely customize them. However the files installed by the Linux terminal are installed in a folder in your AppData folder. To access them from a windows explorer you need to enable hidden folders in your folder options and search for the "gem" in your %Users%\User\AppData folder to locate the installed ruby packages (including the minima package)
</p>
<p>
Some great references on how to customize your pages are:
<ul>
	<li>
	<a href="https://jekyllrb.com/docs/templates/" target="_blank">Jekyll template documentation</a>
	</li>
	<li>
	<a href="https://shopify.github.io/liquid/" target="_blank">Liquid template language</a>
	</li>
	<li>
	<a href="https://gist.github.com/smutnyleszek/9803727" target="_blank">Liquid for Github pages cheatcheat</a> 
	</li>
</ul>
</p>
<p>
After customizing your site template you can just worry about creating content pages. Any changes you make to your template at a later time will be reflected over all pages in the site. When uploading changes to your site repository, it may take a minute or so before changes are reflected in the browser.
The files used to generate the content for this blog can be found at <a href="https://github.com/SamanthaNeilen/JekyllBlog" target="_blank">https://github.com/SamanthaNeilen/JekyllBlog</a>.
</p>
</p></p>

                </div>
            </article>
        
    
</div>

                </main>
            </div>
            <div class="col-md-3">
                <aside aria-label="sidebar">
                    <section class="sidebar-section">
    <h3>About me</h3>
    I am a dutch .Net developer.
    I have been coding professionaly since 2008.
    On this blog I will be writing about multiple subjects that I use in my daily programming job or subjects that I am studying.
</section>
<section class="sidebar-section">
    <h3>Social</h3>
    <a href="https://github.com/SamanthaNeilen"><i class="fa fa-github" aria-hidden="true"></i><span>&nbsp;SamanthaNeilen</span></a> <br />
    <a href="https://twitter.com/NeilenSamantha"><i class="fa fa-twitter" aria-hidden="true"></i><span>&nbsp;NeilenSamantha</span></a> <br />
    <a href="https://www.linkedin.com/in/samantha-neilen-16153713"><i class="fa fa-linkedin" aria-hidden="true"></i><span>&nbsp;Samantha Neilen</span></a><br />
    Subscribe via <a href="/feed.xml">RSS</a>
</section>
<section class="sidebar-section">
    <h3>Last posts </h3>
    
    <a href="/2018/06/08/pre-compiled-azure-functions-example.html">Pre-compiled Azure Functions example</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/04/20/podcasts-a-tip-for-consuming-it-related-content-on-the-go.html">Podcasts, a tip for consuming IT related content on the go</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/03/17/setting-up-a-release-using-vsts.html">Setting up a release using VSTS</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/02/10/setting-up-a-build-using-vsts.html">Setting up a build using VSTS</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/01/14/writing-tests-for-your-graphical-user-interface.html">Writing tests for your graphical user interface</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/archive">Archive</a>
</section>
                </aside>
            </div>
        </div>
    </div>
</body>
</html>
