<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Samantha Neilen</title>
    <meta name="description" content="My name is Samantha Neilen, a dutch .Net developer. I have been coding professionaly since 2008. On this blog I will be writing about multiple subjects that ...">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/site.css" />
    <link rel="canonical" href="https://samanthaneilen.github.io/">
    <link rel="alternate" type="application/rss+xml" title="Samantha Neilen" href="/feed.xml">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
    <header aria-label="header" class="header">
        <span class="header-text">Samantha Neilen</span>
    </header>
</div>
        <div class="row">
            <div class="col-md-7 col-md-offset-1">
                <main class="page-content" aria-label="content">
                    <div>
    
    
    
    <article>
        <header class="article-header">
            <a href="/2018/10/09/using-route-constraints-for-input-validation-and-improved-security.html">Using route constraints for input validation and improved security</a>
        </header>
        
        <span>Oct 9, 2018</span> <br />
        Tags: 
        MVC
        
        WebApi
        
        <div class="article-content">
            <p>In .Net web applications you use the routing system to expose URLs and endpoints in your application. If your method has a framework value type like int then the routing engine will automatically parse your inputs to these types.</p>

<p>Also if you the default convention based route in a .Net Framework MVC web application uses the convention below:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">"Default"</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"{controller}/{action}/{id}"</span><span class="p">,</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">"Home"</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">"Index"</span><span class="p">,</span> <span class="n">id</span> <span class="p">=</span> <span class="n">UrlParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure>

<p>This means that if I have the controller with a method as shown below:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Index</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>If I pas a numeric value that does not map to an int32 (for example max Int32 +1 (= 2147483648)) so <span class="link-style">http://localhost/My/Index/2147483648</span> or if I use <span class="link-style">http://localhost/My/Index/abc</span>, I get a server error saying that I passed a null value for a non-nullable integer. This error occurs because the input value could not be parsed to the correct value type.</p>

<p>After your method gets hit with an valid int32 value, you may also want to do some input validation. For example: is my integer input a positive number. When using string inputs you may want to validate and execute different code depending on what input was given. An example of this is shown below:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">input</span><span class="p">),</span> <span class="s">"Input has to be a valid positive integer"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">businessLogic</span><span class="p">.</span><span class="nf">ProcessInput</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">input</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"@"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">//return something
</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// return something else
</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>By using route constraints you can avoid cluttering controllers with validation code and routing logic inside your controller methods. Using route constraints will also add security benefits. If a route is not found the processing will stop quite early in the processing pipeline and return a 404 not found exception. This 404 exception will also never include sensitive internal information about a specific method that was being processed.</p>

<p>In this blogpost I will be describing the default route constraints provided by the .Net Frameworks and how to create custom constraints to make sure a method or route only gets hit by the intended input.</p>

<p>I have created a <a href="https://github.com/SamanthaNeilen/WebApiExamples" title="reference project on GitHub" target="_blank">reference project on GitHub</a> where all code snippets described in the rest of this blogpost can be found in a running project including integration tests demonstrating the working and denied routes.</p>

<h3 id="route-constraints-in-a-net-framework-web-application-for-mvc-controllers">Route constraints in a .Net Framework web application for MVC controllers</h3>
<p>Create a new .Net Framework web application using the MVC template. Next navigate to the Controllers/Home.cs file. The parameterless methods for showing the homepage, contact and about page are already listed. The default template uses the convention based routing by default. The default route template is defined in App_Start/RouteConfig.cs.</p>

<p>To add another route using a route constraint to the convention based routes, add the code as shown below:</p>

<p>RouteConfig.cs (make sure to add this above the default route)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">"GetNumber"</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"GetNumber/{input}"</span><span class="p">,</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">"Home"</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">"GetNumber"</span> <span class="p">},</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">input</span> <span class="p">=</span> <span class="s">@"\d{1,3}"</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure>

<p>HomeController.cs</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="kt">string</span> <span class="nf">GetNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.GetNumber((</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">input</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>With this defined route you will expose the <span class="link-style">http://localhost/GetNumber/{number}</span> route where the number parameter is a number of 1 to 3 digits. The constraints parameter in the MapRoute method accepts regular expressions and will route any call to the GetNumber method if the digits match. If the route does not match (for example {number} is 4 digits) no route will be found and you will get a HTTP 404 not found error when calling the GetNumber url.</p>

<p>Next if your logic is too complex for a regular expression you can choose to define a custom RouteConstraint as shown in the code snippets below:</p>

<p>RouteConfig: (again make sure to add this above the default route)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">"GetEmail"</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"GetEmail/{email}"</span><span class="p">,</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">"Home"</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">"GetEmail"</span> <span class="p">},</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Email</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmailRouteContraint</span><span class="p">()</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure>

<p>HomeController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEmail</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.GetEmail((</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>EmailRouteContraint.cs (this is a new class file added to the project)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Utilities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample.Custom</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailRouteContraint</span> <span class="p">:</span> <span class="n">IRouteConstraint</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">HttpContextBase</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">Route</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> 
                <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">,</span> <span class="n">RouteDirection</span> <span class="n">routeDirection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">parameterName</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">routeValue</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">parameterValueString</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">routeValue</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">parameterValueString</span><span class="p">.</span><span class="nf">IsEmail</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">HttpContextBase</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">Route</span> <span class="n">route</span><span class="p">,</span> 
                <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//validate input params  
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">httpContext</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">parameterName</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">parameterName</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>IsEmail extension method implementation:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">namespace</span> <span class="nn">Utilities</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Extensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsEmail</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">value</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"@"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Now we’ve set up a route for <span class="link-style">http://localhost/GetEmail/{email}</span> where the input string for email will only match if the value has a @ symbol in it. So just <span class="link-style">http://localhost/GetEmail/abc</span> will return a 404 not found result, but <span class="link-style">http://localhost/GetEmail/abc@</span> will route to our GetEmail method in the HomeController.cs file.</p>

<p>Convention based routing has some limitations for route constraints and also the route templates may unintentionally overlap and result in unexpected behavior. (If we did not specify the GetEmail of GetNumber paths in the url, the default route would have used our input and try to route it to one of our methods). Also attribute routing already has default constraint options for basic value type constraints.</p>

<p>For more information on convention based and attribute based routing and conventions for defining a route see the Microsoft docs pages about routing.</p>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/asp-net-mvc-routing-overview-cs" title="Microsoft docs page for convention based routing" target="_blank">Microsoft docs page for convention based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#adding-route-attributes" title="Microsoft docs page for attribute based routing" target="_blank">Microsoft docs page for attribute based routing</a>.</li>
</ul>

<p>To enable attribute based routing, add the snippet below to the RouteConfig file. Next add a number method using a Route attribute with a default inline constraint as shown below.</p>

<p>RouteConfig:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapMvcAttributeRoutes</span><span class="p">();</span></code></pre></figure>

<p>HomeController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("Attr/{number:range(0,2147483647)}")]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">GetNumberAttributeRoute</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">number</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Now we have a <span class="link-style">http://localhost/Attr/{number}</span> route defined. The default route constraint will ensure that only a valid positive integer will be accepted. Negative input will result in a 404 not found result. Also if you did not specify a constraint, an input larger than Int32 would have routed to this method and the input would have been 0 as the number would not have been parsable to a valid int32.</p>

<p>For a table of the default inline constraints for attribute routing see: <a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#route-constraints" title="the Microsoft docs page for default inline constraints" target="_blank">the Microsoft docs page for default inline constraints</a>. These default constraints do not seem to work in the convention based routing constraints parameter. When using convention based routing you will only be able to use regex or custom route constraint implementations.</p>

<p>To add a custom constraint to an attribute routing template, change the call to the MapMvcAttributeRoutes method to the snippet shown below and add a method using the custom constraint in the HomeController.</p>

<p>RouteConfig:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">constraintsResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultInlineConstraintResolver</span><span class="p">();</span>
<span class="n">constraintsResolver</span><span class="p">.</span><span class="n">ConstraintMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">EmailRouteContraint</span><span class="p">));</span>
<span class="n">routes</span><span class="p">.</span><span class="nf">MapMvcAttributeRoutes</span><span class="p">(</span><span class="n">constraintsResolver</span><span class="p">);</span></code></pre></figure>

<p>HomeController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("Attr/{email:Email}")]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEmailAttributeRoute</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Here we map the string “Email” to our custom constraint implementation. Now we can use that string in our Route template as “{parametername:Email}”. When using multiple custom constraints you have to map them to unique names to use in your routes. The implementation above maps the url <span class="link-style">http://localhost/Attr/{email}</span> to our method. So now we can use <span class="link-style">http://localhost/Attr/abc@</span> as a valid route but the constaint will ensure that <span class="link-style">http://localhost/Attr/abc</span> will still return a 404 not found.</p>

<h3 id="route-constraints-in-a-net-framework-web-application-for-webapi-controllers">Route constraints in a .Net Framework web application for WebApi controllers</h3>
<p>In the .Net Framework projects, MVC Controllers and WebApi Controllers work with different implementations. When adding a new controller and selecting a WebApi controller template, a WebApiConfig.cs file will appear in the App_Start folder. As you compare that file with the RouteConfig.cs you will see that the methods use different types with different methods to configure routing. 
(When adding a WebApi controller to an MVC project you also need add the GlobalConfiguration.Configure(WebApiConfig.Register); line to your global.asax file to enable the WebApi routing)</p>

<p>We can add a WebApi controller to the project and define some routes showing the attribute route constraints with almost the same code as we used for the MVC controller.</p>

<p>Global.asax: (full Global.asax is shown but the only change I made was the call to the WebApiConfig.Register method)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Optimization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MvcApplication</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">HttpApplication</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">AreaRegistration</span><span class="p">.</span><span class="nf">RegisterAllAreas</span><span class="p">();</span>
            <span class="n">GlobalConfiguration</span><span class="p">.</span><span class="nf">Configure</span><span class="p">(</span><span class="n">WebApiConfig</span><span class="p">.</span><span class="n">Register</span><span class="p">);</span>
            <span class="n">FilterConfig</span><span class="p">.</span><span class="nf">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">);</span>
            <span class="n">RouteConfig</span><span class="p">.</span><span class="nf">RegisterRoutes</span><span class="p">(</span><span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">);</span>
            <span class="n">BundleConfig</span><span class="p">.</span><span class="nf">RegisterBundles</span><span class="p">(</span><span class="n">BundleTable</span><span class="p">.</span><span class="n">Bundles</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>WebApiConfig.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Framework.WebApiExample.Custom</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Routing</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">WebApiConfig</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Register</span><span class="p">(</span><span class="n">HttpConfiguration</span> <span class="n">config</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">constraintsResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultInlineConstraintResolver</span><span class="p">();</span>
            <span class="n">constraintsResolver</span><span class="p">.</span><span class="n">ConstraintMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">EmailHttpRouteConstraint</span><span class="p">));</span>
            <span class="n">config</span><span class="p">.</span><span class="nf">MapHttpAttributeRoutes</span><span class="p">(</span><span class="n">constraintsResolver</span><span class="p">);</span>

            <span class="n">config</span><span class="p">.</span><span class="n">Routes</span><span class="p">.</span><span class="nf">MapHttpRoute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">:</span> <span class="s">"DefaultApi"</span><span class="p">,</span>
                <span class="n">routeTemplate</span><span class="p">:</span> <span class="s">"api/{controller}/{id}"</span><span class="p">,</span>
                <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">RouteParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>EmailHttpRouteConstraint.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Utilities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample.Custom</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailHttpRouteConstraint</span> <span class="p">:</span> <span class="n">IHttpRouteConstraint</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">IHttpRoute</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> 
                <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">,</span> <span class="n">HttpRouteDirection</span> <span class="n">routeDirection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">parameterName</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">routeValue</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">parameterValueString</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">routeValue</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">parameterValueString</span><span class="p">.</span><span class="nf">IsEmail</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">IHttpRoute</span> <span class="n">route</span><span class="p">,</span> 
                <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//validate input params  
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">parameterName</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">parameterName</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>RoutingApiController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">RoutePrefix</span><span class="p">(</span><span class="s">"api/routingapi"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RoutingApiController</span> <span class="p">:</span> <span class="n">ApiController</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{validPositiveInt32Value:range(0,2147483647)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">validPositiveInt32Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">validPositiveInt32Value</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{valueMatchingRegex:regex(^(.+)(_)(.+)$)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">GetByRegex</span><span class="p">(</span><span class="kt">string</span> <span class="n">valueMatchingRegex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">valueMatchingRegex</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>        
        <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As you may have noticed in the code above. The email custom route constraint for a WebApi controller implements the IHttpRouteConstraint interface instead of the IRouteConstraint interface. Be aware when intermingling MVC and WebApi controllers in a .Net Framework web application project that other attributes (like authorization) will also usually require different implementations to be used for a MVC and a WebApi controller.</p>

<p>By adding the RoutingApiController listed above the following routes become availlable:</p>

<ul>
  <li><span class="link-style">http://localhost/api/routingapi/{ValidPositiveInt32}</span></li>
  <li><span class="link-style">http://localhost/api/routingapi/{StringSplitByUnderscore}</span></li>
  <li><span class="link-style">http://localhost/api/routingapi/{StringContaining@Symbol}</span></li>
</ul>

<h3 id="route-constraints-in-a-net-core-web-application">Route constraints in a .Net Core web application</h3>

<p>In the .Net Core pipeline MVC and WebApi controllers now share the same base classes. The setup for routing is also now centralized in the Startup classes. The code snippets below how to set up the routing and then show an MVC and a WebApi controller with the same routing constraint concepts that I have explained in the previous sections of this post. 
The code snippets were added to a default .Net Core web application using the Model View Controller project template. The code in the Startup.cs is needed when adding a custom route constraint in the template. If you only use the route constraints that can be resolved by the DefaultInlineConstraintResolver, the code for setting up the RouteOptions configuration can be omitted.</p>

<p>Startup.cs</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">NetCore.WebApiExample.MiddleWare</span><span class="p">;</span>

<span class="p">...</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">CookiePolicyOptions</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// This lambda determines whether user consent for non-essential cookies is needed for a given request.
</span>
        <span class="n">options</span><span class="p">.</span><span class="n">CheckConsentNeeded</span> <span class="p">=</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">MinimumSameSitePolicy</span> <span class="p">=</span> <span class="n">SameSiteMode</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">RouteOptions</span><span class="p">&gt;(</span><span class="n">routeOptions</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">routeOptions</span><span class="p">.</span><span class="n">ConstraintMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">EmailRouteContraint</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">().</span><span class="nf">SetCompatibilityVersion</span><span class="p">(</span><span class="n">CompatibilityVersion</span><span class="p">.</span><span class="n">Version_2_1</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>EmailRouteConstraint.cs</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Utilities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.MiddleWare</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailRouteContraint</span> <span class="p">:</span> <span class="n">IRouteConstraint</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">IRouter</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">routeKey</span><span class="p">,</span> <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">,</span> <span class="n">RouteDirection</span> <span class="n">routeDirection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">routeKey</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">routeKey</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">routeValue</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">parameterValueString</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">routeValue</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">parameterValueString</span><span class="p">.</span><span class="nf">IsEmail</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">IRouter</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">routeKey</span><span class="p">,</span> <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//validate input params  
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">httpContext</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">routeKey</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">routeKey</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>HomeController.cs (.Net Core MVC Controller)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Index</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>RoutingApiController.cs (.Net Core WebApi Controller)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RoutingApiController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{inputMatchingRegex:regex(^(.+)(_)(.+)$)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">GetByRegex</span><span class="p">(</span><span class="kt">string</span> <span class="n">inputMatchingtRegexForValueContainingUnderscore</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">inputMatchingtRegexForValueContainingUnderscore</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{validPositiveInt32Value:range(0,2147483647)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">validPositiveInt32Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">validPositiveInt32Value</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="testing-routing-behavior-with-integration-tests">Testing routing behavior with integration tests</h3>
<p>To ensure your routes work as intended and faulty input does not lead to errors you can write a set of integration tests. I used a .Net Core test project combined with the NUnit testing framework to write the tests shown below.</p>

<p>TestClass: (the RouteDriver implementation is listed below the TestClass code snippet )</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">IntegrationTests.TestDriver</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">NUnit.Framework</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">IntegrationTests</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;
</span>
    <span class="c1">/// Be sure to have local instance of the Framework.WebApiExample website running on the url provided in the _localHostUrl constant.
</span>
    <span class="c1">/// &lt;/summary&gt;
</span>
    <span class="p">[</span><span class="n">TestFixture</span><span class="p">]</span>    
    <span class="k">public</span> <span class="k">class</span> <span class="nc">FrameworkMvcRouteTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">_localHostUrl</span> <span class="p">=</span> <span class="s">"http://localhost:55528/"</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">RouteTestDriver</span> <span class="n">_testDriver</span><span class="p">;</span>

        <span class="p">[</span><span class="n">SetUp</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Setup</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_testDriver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RouteTestDriver</span><span class="p">(</span><span class="n">_localHostUrl</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">TearDown</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">TearDown</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_testDriver</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span> <span class="c1">//Home/Index route    
</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/abc@"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/abc@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/0"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/12"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/123"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Convention_Based_Route_Should_Be_Valid_Route</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
           <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturnsSuccessStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>                                          
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>        
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/123"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/1234"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Convention_Based_Route_Should_Return_404_Not_Found_StatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturns404NotFoundStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>
        <span class="p">}</span>


        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>   
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/abc@"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/abc@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/0"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/12345"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/2147483647"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Attribute_Based_Route_Should_Be_Valid_Route</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturnsSuccessStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/-1"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/2147483648"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Attribute_Based_Route_Should_Return_404_Not_Found_StatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturns404NotFoundStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>RouteTestDriver.cs (this class is a helper to centralize code used for multiple tests)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"> 
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">IntegrationTests.TestDriver</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RouteTestDriver</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_localHostBaseUrl</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">RouteTestDriver</span><span class="p">(</span><span class="kt">string</span> <span class="n">localHostBaseUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">localHostBaseUrl</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">localHostBaseUrl</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">_localHostBaseUrl</span> <span class="p">=</span> <span class="nf">AppendBackSlashIfNeeded</span><span class="p">(</span><span class="n">localHostBaseUrl</span><span class="p">);</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">UrlReturnsSuccessStatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrlForTest</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="n">HttpClientFactory</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">uriToTest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">_localHostBaseUrl</span> <span class="p">+</span> <span class="p">(</span><span class="n">relativeUrlForTest</span> <span class="p">??</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">httpCallResult</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uriToTest</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">httpCallResult</span><span class="p">.</span><span class="n">IsSuccessStatusCode</span><span class="p">;</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">UrlReturns404NotFoundStatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrlForTest</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="n">HttpClientFactory</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">uriToTest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">_localHostBaseUrl</span> <span class="p">+</span> <span class="p">(</span><span class="n">relativeUrlForTest</span> <span class="p">??</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">httpCallResult</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uriToTest</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">httpCallResult</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">==</span> <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">NotFound</span><span class="p">;</span>

        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="nf">AppendBackSlashIfNeeded</span><span class="p">(</span><span class="kt">string</span> <span class="n">localHostBaseUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="p">!</span><span class="n">localHostBaseUrl</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
                <span class="p">?</span> <span class="n">localHostBaseUrl</span> <span class="p">+</span> <span class="s">"/"</span>
                <span class="p">:</span> <span class="n">localHostBaseUrl</span><span class="p">;</span>
        <span class="p">}</span>       
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HttpClientFactory</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="n">_instance</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="nf">GetInstance</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_instance</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>These tests can help you make sure that a route either works (by returning a success status code) or is not found (by returning a 404 not found status). I made sure to explicitly check for 404 not found statuses for the “failure” cases and not just check if the success status code was false. This ensures no unwanted internal server errors are returned. Internal server errors are unwanted behavior and if error handling is set up in the wrong way, they may even expose internals of your application that you do not want your users to see.</p>

<h3 id="microsoft-docs-reference-links">Microsoft Docs reference links:</h3>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/asp-net-mvc-routing-overview-cs" title="Microsoft docs page for convention based routing" target="_blank">Microsoft docs page for convention based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/creating-a-route-constraint-cs" title="Microsoft docs page for creating a custom route constraint for convention based routing" target="_blank">Microsoft docs page for creating a custom route constraint for convention based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#adding-route-attributes" title="Microsoft docs page for attribute based routing" target="_blank">Microsoft docs page for attribute based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-2.1" title="Microsoft docs page for routing in .Net Core 2.1" target="_blank">Microsoft docs page for routing in .Net Core 2.1</a>.</li>
</ul>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/08/17/tls1.2-not-supported-by-default-in-older-net-framework-applications.html">TLS1.2 not supported by default in older .NET Framework applications</a>
        </header>
        
        <span>Aug 17, 2018</span> <br />
        Tags: 
        <div class="article-content">
            <p>Lately more and more API providers have been disabling TLS 1.1 for their servers and are currently only accepting the TLS 1.2 protocol for establishing a HTTPS connection to their servers. TLS takes care of the encryption of the HTTPS communication and TLS1.2 was introduced in 2008. It is more secure (harder to decrypt) than the previous versions.</p>

<p>You may encounter that establishing a HTTPS connection to a 3rd party may suddenly fail without there having been any new code changes or deployments. This may be due to the fact that the 3rd party has decided to no longer accept TLS 1.1 or below for HTTPS connections.</p>

<p>I ran into this myself again this week because I used a PowerShell command to execute C# code to retrieve a bearer access token from Azure leveraging the ADAL dll’s. It suddenly did not work anymore last week and after some Googling I found a similar error that was solved by adding the TLS1.2 protocol to the ServicePointManager.SecurityProtocol property. I have needed to do this before in several older C# applications and it inspired me to write this blogpost today.</p>

<p>If you face the exception “The server forcibly closed the connection” this may be an indication that the ServicePointManager no longer has a compatible protocol to establish a HTTPS connection with the server.</p>

<p>The ServicePointManager is a static class .Net Framework class that will always choose the highest (securest) protocol available from the SecurityProtocol property and will only fall back to a previous version if the highest is not supported.</p>

<p>Use a debugger to inspect the ServicePointManager.SecurityProtocol value to see if TLS 1.2 is listed, to determine whether or not this may be the cause of your connection issues. 
This is usually the cause when using older .Net Framework versions (&lt; 4.7) as is it was with my PowerShell.</p>

<p>In C# use the code below to append the current security protocols with TLS1.2 before establishing the connection to the server or put this code snippet in your Global.asax startup.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="n">ServicePointManager</span><span class="p">.</span><span class="n">SecurityProtocol</span> <span class="p">|=</span> <span class="n">SecurityProtocolType</span><span class="p">.</span><span class="n">Tls12</span></code></pre></figure>

<p>When using powershell use the command below to check the current default protocols as used in Powershell:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"> <span class="o">[</span>Net.ServicePointManager]::SecurityProtocol</code></pre></figure>

<p>You can set the TLS1.2 protocol if it’s not listed by using:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">[</span>Net.ServicePointManager]::SecurityProtocol +<span class="o">=</span> <span class="o">[</span>Net.SecurityProtocolType]::Tls12 </code></pre></figure>

<p>Older version of PowerShell may not support this syntax. Use the syntax below set the most common protocols:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">[</span>Net.ServicePointManager]::SecurityProtocol <span class="o">=</span> <span class="o">[</span>Net.SecurityProtocolType]::Ssl3,  <span class="o">[</span>Net.SecurityProtocolType]::Tls, <span class="o">[</span>Net.SecurityProtocolType]::Tls12 </code></pre></figure>

<p>Remember: when appending or setting the ServicePointManager.SecurityProtocol property to a set value in your code, you may have to revisit this at a later time when newer TLS protocols become the new standard.</p>

<p>For more information on this subject visit the reference websites below:</p>

<p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" title="Wikipedia page for Transport Layer Security" target="_blank">Wikipedia page for Transport Layer Security</a></p>

<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepointmanager.securityprotocol?redirectedfrom=MSDN&amp;view=netframework-4.7.2#System_Net_ServicePointManager_SecurityProtocol" title="Microsoft Docs page on the ServicePointManager.SecurityProtocol property" target="_blank">Microsoft Docs page on the ServicePointManager.SecurityProtocol property</a></p>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/07/14/csharp-script-azure-functions-example.html">C# script Azure Functions example</a>
        </header>
        
        <span>Jul 14, 2018</span> <br />
        Tags: 
        Azure
        
        AzureFunctions
        
        <div class="article-content">
            <p>
C# Script Functions are another way to create Azure Functions based on C#. These functions rely on C# script files (.csx) that are not compiled into a dll. There is no Visual Studio project to create or manage the files. You use command line tooling for development and the advantage is that you can directly edit and run your code in the Azure portal. Script Functions can be developed and tested locally before uploading the Function to the portal.
</p>
<p>
If you would like to know more about compiled Azure Functions using the Visual Studio Azure Function project see <a href="https://samanthaneilen.github.io/2018/06/08/pre-compiled-azure-functions-example.html" target="_blank">my last blog post about pre-compiled Azure Functions</a>.
</p>
<p>
All the code from the following example can also be found in my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExample repository</a> in the solution folder AzureFunction_CsharpScript.
</p>
<h3>Create an C# script Azure Function</h3>
<p>
Install npm and nodejs from the <a href="https://nodejs.org/en/" target="_blank">nodejs website</a>.
</p>
<p>Install npm azure functions core tools using the command line. I used the v1 (.Net Framework version) using the command below.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">npm install <span class="nt">-g</span> azure-functions-core-tools</code></pre></figure>

<p>
Append the package name with @core to install de v2 version. The v2 version is built on .Net Core and is currently still in preview (the same as with the compiled Azure Functions)
</p>
<p>
The files for the azure-function-core-tools are placed in %USER%\AppData\Roaming\npm on your disk.
In the npm\node_modules\azure-functions-core-tools\bin folder you can view all the Framework and Nuget package dlls available for use at runtime.
</p>
<p>
If you wish to check the version of the downloaded package and the commands for the command line use the command below. For command usage see the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local" target="blank">Microsoft Docs guidance on developing C# script Functions</a>.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func version</code></pre></figure>

<p>
Next I want to create a queue Function based on the C# language. Go to the directory where you want to create the function folder. And use the command below.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func init AzureFunctionsExample.ScriptV1</code></pre></figure>

<p><br /><img src="/assets/images/20180714/cmd.exe-func-init.png" alt="cmd.exe func init" /></p>
<p>
This command will create a “project folder” for an empty Azure Function project with the host and localsettings json files. (These are used the same as for compiled Azure Functions. See <a href="https://samanthaneilen.github.io/2018/06/08/pre-compiled-azure-functions-example.html" target="_blank">my previous blogpost about compiled Azure Functions</a> or the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#local-settings-file" target="blank">Microsoft Docs pages</a> for more information) 
</p>
<p>
Also note the .vscode folder. Seeing as there is no .csproj file, the support for regular visual studio is limited. You can manage in the files in Visual Studio by creating a class library or solution folders and importing the files but with Visual Studio code you can just open the folder to manage the files. 
</p>
<p>
Visual Studio Code also has a plugin for Azure Functions that adds an Azure tab to your project. It also has options to create Azure Functions but these will create compiled Functions. When opening the folder you may be prompted to optimize the Function but as it was not created using the plugin, it will not optimize. 
</p>
<p>
I used regular Visual Studio with a class library and the regular command line shell for all the next steps because I did not have time to look into debugging script Azure Functions with Visual Studio Code. NPM installs a 32 bit version of the CLI and Visual Studio Code does not seem to support debugging the 32bit process.
</p>
<p>
The command below is used to create the files for the actual Function in a sub folder of the Azure Function app folder.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func new</code></pre></figure>

<p>
Next navigate the selection options to create a C# Queue trigger and provide a name for the Function.
<br /><img src="/assets/images/20180714/cmd.exe-func-new.png" alt="cmd.exe func new" />
</p>
<p>
This will create a new subfolder with a function.json that describes the input/output bindings, a run.csx that has the “main” method for the function called Run and a sample.dat file that can be used later to provide message data while debugging. It also has a readme file with little information. I just deleted the readme file. 
</p>
<p>Function.json:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"disabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"bindings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myQueueItem"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"queueTrigger"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"queueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myqueue-items"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Run.csx</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">string</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
For easy management just include all the files inside your Visual Studio class library project so you can access and manage them from the Solution Explorer as shown in the image below.
<br /><img src="/assets/images/20180714/solutionexplorer-AzureFunctionsExample.ScriptV1.png" alt="Solution Explorer AzureFunctionsExample.ScriptV1" />
</p>
<p>
Now we have all the files needed for the Function but first we need to configure connection to the Azure Storage emulator before we can start it up. 
</p>
<p>
Go into local.settings.json in the root folder and change the Values node with content below to configure the storage connections:
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"AzureWebJobsStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"AzureWebJobsDashboard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="w">
  </span><span class="p">}</span></code></pre></figure>

<p>
Next go to the function.json and set the connection to the AzureWebJobsStorage and the queueName to messages. If you do not have the Azure Storage Emulator set up yet view the Azure Storage Emulator paragraph in <a href="https://samanthaneilen.github.io/2018/06/08/pre-compiled-azure-functions-example.html" target="_blank">my post about compiled Azure Functions</a>. 
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"disabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"bindings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myQueueItem"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"queueTrigger"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"queueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"messages"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AzureWebJobsStorage"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
We can now run the Function by using the command shown below in the command shell in the root folder (where the host.json file is). Make sure that the Azure Storage Emulator is running,
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func host start <span class="nt">--debug</span> VS</code></pre></figure>

<p><br /><img src="/assets/images/20180714/cmd.exe-func-host-start.png" alt="cmd.exe func host start" /></p>
<p>
This will start the Azure Function the same way that it did with the compiled Azure Function.  
</p>
<p>
When specifying debug mode you also get the JIT Debugger window. Just choose the Visual Studio instance where the run.csx is available to attach the debugger.
<br /><img src="/assets/images/20180714/jit-debug-window.png" alt="jit debug window" />
</p>
<p>
You will also get the application in break mode tab in your Visual Studio instance. Just click the continue execution option. (You may have to press enter in the command shell to continue loading of the Function if it was interrupted by the debug prompt before it will pick up any messages)
</p>
<p>
Next set a breakpoint in the run.csx and use the QueueMessage project from my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExamples</a> repository or any other method to post a message to the queue and see the debugger in the run.asxc.
<br /><img src="/assets/images/20180714/debug-run.csx.png" alt="debug run.csx" />
</p>
<p>
For extra methods and simple Azure Functions you could create all extra classes and methods in the run.csx file. For better maintainability create classes and extra code into separate C# script (.csx) files or in a separate class library compiled to a dll. You can also reference the .Net assemblies that are available for the Azure Function runtime. For more information see the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp" target="_blank"> Microsoft Docs on C# script</a>.
</p>
<p>
In my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureExampleFunctions repository</a>. I’ve created a QueueMessage.csx class used to convert the input queuemessage from a string to an object instance. First add a QueueMessage.csx file to the ProcessMessageScriptV1 Function folder with the definition of the QueueMessage class (as shown below). There are no using or namespace definitions in the file. Next use the #load “QueueMessage.csx” statement in the run.csx to complete the reference binding and change the type for myQueueItem from string to QueueMessage. The code should look as below:
</p>
<p>
QueueMessage.csx:
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">internal</span> <span class="k">class</span> <span class="nc">QueueMessage</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">internal</span> <span class="k">enum</span> <span class="n">OrderStatus</span>
<span class="p">{</span>
    <span class="n">Concept</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
    <span class="n">Processing</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
    <span class="n">Processed</span> <span class="p">=</span> <span class="m">2</span>
<span class="p">}</span></code></pre></figure>

<p>run.csx:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="err">#</span><span class="n">load</span> <span class="s">"QueueMessage.csx"</span>
 
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
 
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Next run the Function to see that the myQueueItem is successfully converted from a Json message to a QueueMessage instance.
<br /><img src="/assets/images/20180714/debug-run.csx-queuemessage-object.png" alt="debug run.csx queuemessage object" />
</p>
<p>
Extra .csx files can also be placed in subfolders. If QueueMessage.csx was placed in a subfolder called helpers you would use the #load “helpers/QueueMessage.csx” in the run.csx file. The #load statement contains a relative path to the file. See the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp#reusing-csx-code" target="_blank"> Microsoft Docs on C# script</a> for examples.
</p>
<h3>Referencing a custom dll in an Azure Script Function</h3>
<p>
Next I can create separate dll containing a Data Access Layer and reference it in my script Function. 
(I couldn’t use the AzureFunctionExample.ResourceAccess library already present in the solution because I got exceptions that EntityFrameworkCore was not supported on the platflorm). Just add a .Net Framework library with the Entity Framework package and define the data access classes below:
</p>
<p>Order class:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">PersonID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="k">public</span> <span class="kt">string</span> <span class="n">OrderNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="n">Person</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Person class:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">Person</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Orders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>OrderDbContext class:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Entity.ModelConfiguration.Conventions</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">connectionString</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Database</span><span class="p">.</span><span class="n">SetInitializer</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">DbModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">HasMany</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Orders</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">WithRequired</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Person</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">HasForeignKey</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span><span class="p">);</span>
 
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="n">Remove</span><span class="p">&lt;</span><span class="n">PluralizingTableNameConvention</span><span class="p">&gt;();</span>
 
            <span class="k">base</span><span class="p">.</span><span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">modelBuilder</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
To use this library in my Function I need to get the output dll and the extra references to a location accessible to the script Function. So first I copy all the dll from the bin output to an empty references folder using a post-build event.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">xcopy /Y/S <span class="k">$(</span>TargetDir<span class="k">)$(</span>ProjectName<span class="k">)</span>.dll <span class="k">$(</span>SolutionDir<span class="k">)</span>AzureFunctionsExample.ScriptV1<span class="se">\P</span>rocessMessageScriptV1<span class="se">\r</span>eferences
xcopy /Y/S <span class="k">$(</span>TargetDir<span class="k">)</span>EntityFramework.dll <span class="k">$(</span>SolutionDir<span class="k">)</span>AzureFunctionsExample.ScriptV1<span class="se">\P</span>rocessMessageScriptV1<span class="se">\r</span>eferences
xcopy /Y/S <span class="k">$(</span>TargetDir<span class="k">)</span>EntityFramework.SqlServer.dll <span class="k">$(</span>SolutionDir<span class="k">)</span>AzureFunctionsExample.ScriptV1<span class="se">\P</span>rocessMessageScriptV1<span class="se">\r</span>eferences</code></pre></figure>

<p><br /><img src="/assets/images/20180714/project-properties-xcopy-build-event.png" alt="project properties xcopy build event" /></p>
<p>
This will ensure that after every build all the necessary dll will be in that folder (even though I excluded that folder from source control with the .gitignore file) 
</p>
<p>
Next add all the necessary settings to the local.settings.json. so it looks like below:
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"IsEncrypted"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"AzureWebJobsStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"AzureWebJobsDashboard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"OrderDbConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Server=.</span><span class="se">\\</span><span class="s2">SQLEXPRESS;Database=OrderDb;Integrated Security=True;"</span><span class="p">,</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
And finally I add the reference and using statements to the run.csv and change the implementation of the run.csx to the code shown below:
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="err">#</span><span class="n">load</span> <span class="s">"QueueMessage.csx"</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"references/EntityFramework.dll"</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"references/AzureFunctionsExample.ScriptResources.dll"</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"netstandard"</span>
 
<span class="k">using</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
 
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Person</span><span class="p">);</span>
 
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
By referencing dll or just using .csx files you can create pretty complex C# script Functions with the same functionality as a pre-compiled Azure Function.
<h3>Run and test in the Azure Portal</h3>
<p>
The command line offers a login and publish command to push your local Function app to a hosted Azure Function App. Another way you can upload the files is via de App Service Editor under the Platform Settings for an Azure App Function in the Azure Portal. Remember to copy the key value pairs from the appsettings.json to the Application Settings page of the Azure Function App in the portal.
</p>
<p>
With script Functions you can view the files and edit and run the Function directly in the portal with the editor show below.
<br /><img src="/assets/images/20180714/azure-function-app-editor.png" alt="azure-function-app-editor" />
</p>

 
</p>

        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/06/08/pre-compiled-azure-functions-example.html">Pre-compiled Azure Functions example</a>
        </header>
        
        <span>Jun 8, 2018</span> <br />
        Tags: 
        Azure
        
        AzureFunctions
        
        <div class="article-content">
            <p>
	Azure Functions are a great way of setting up small asynchronous processing with great parallel processing scaling options and a pay-as-you go pricing model at the cost of some time and memory limitations.
</p>
<p>There are multiple ways of creating a C# Azure Function: <br />
- Precompiled Azure Functions are created with a Visual Studio Azure Functions project<br />
- File based Azure Functions leverage the Azure Function CLI NPM package for development and do not require any specific editor to create.<br />
</p>
<p>
	In this blog post I will focus on developing precompiled Azure Functions using Visual Studio. In a next blog post I explain creating an Azure Function using the file based and Azure Functions.
</p>
<p>
	Azure Functions can be developed run and tested locally using the latest version of the Visual Studio 2017 IDE that has the Azure workload installed without the need to upload anything to the cloud. Installing the Azure workload also installs the Azure Storage Emulator to mimic the functionality of a storage account on your local machine.
</p>
<p> 
	I have created an <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExample github repository</a> with a solution that can be run local and be published to the cloud. An Azure Function v1 (Net Framework project) and a v2 (Net Standard and still in preview) example respond to a queue message, get some extra data from a database using Entity Framework Core, retrieve an emailtemplate from a blob storageaccount and then send an email using the data and the template with the <a href="https://sendgrid.com/solutions/email-api/" target="_blank">SendGrid emailservice</a>. (SendGrid offers an emailservice API that is free to use up to 100 emails per day)
</p>
<p>
	I used a separate class library to demonstrate that referencing other project libraries works the same as other project types. Complex Azure Functions can be build as a small microservice with a layer architecture to separate your execution/workflow, business logic and resource access into separate libraries.
</p>
<p>
 	In my example repository I used and referenced a .Net Standard 2.0 library by both an Azure Function v1 and v2 project but you can also add a class library matching the framework version of the Azure Function project. The code executed by the Functions is the same, just the underlying Framework and Azure Function runtime differs. Note that when installing NuGet package on a project it may reference different dll versions and dependencies with the same NuGet package version for the different Standard, Core and Framework projects. So when the referenced dependencies on the class library and executing project do not match it may result in runtime errors because expected DLL versions do not match on the executing project. An example of this is the WindowsAzure.Storage package version as shown below.
 <br /><img src="/assets/images/20180608/AzureStoragePackageVersionDifferences.png" alt="AzureStorage Package Version Differences" />
 </p>
<h3>Set up and run the storage emulator</h3>
<p> 
	In the windows programs or start menu find and start the Azure Storage Emulator. I encountered some issues starting the Azure Storage Emulator using the default LocalDB instance due to path naming and/or access rights, however I did manage to set up the needed database on my local SQLExpress instance. To force the Azure Storage Emulator to initialize on a named SQL instance instead of the default LocalDB use the command below and replace SQLExpress with the name of the SQL Server instance that you wish to use: 
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">AzureStorageEmulator.exe init /server SQLEXPRESS</code></pre></figure>

<p>
	After it's started, an icon for the emulator will pop-up. Use the context menu on the icon to use the "Show Storage Emulator UI" to view the command prompt with the possible commands for the emulator below.
	<br /><img src="/assets/images/20180608/AzureStorageEmulatorCommandPromt.png" alt="Azure Storage Emulator Commandpromt" />
</p>
<p>
	You can explore the contents of the endpoints using the Visual Studio Cloud Explorer window (found under the View main menu in Visual Studio) under the (Local) and then Storage Accounts node.
	You can access the storage programmatically using the account name and key found on the <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-use-emulator" target="_blank">Microsoft Docs page</a> for the emulator. The access key and account are defaults and publicly known thus they are also included in the config and appsettings files in the projects of my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExample GitHub repository</a>. 
</p>
<p>
	Note that the Storage Emulator will shutdown when the computer is turned of and will need to be restarted to access it after rebooting your computer.
</p>
<h3>Create a simple NetCore console application to post a queue message</h3>
<p>
	After the Azure Storage Emulator is running you can create a simple console application to post a message to the local queue storage. First create a new .Net Core Console application.	
	Next add an appsettings.json file to store any credentials and settings. Fill it with the content shown below and be sure to mark the file as "Copy to Output Directory" with a value of always in the file properties window.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"AzureStorageUri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:10001/devstoreaccount1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"AzureStorageAccountName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devstoreaccount1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"AzureStorageAccountKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw=="</span><span class="p">,</span><span class="w">
  </span><span class="s2">"AzureStorageQueueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"messages"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
	Next create a class that will be our data structure. We can use this to serialize easily to JSON. Because an Azure Function can automatically convert our serialized json queue message back to an object as I will show in the later part of this post where we create the actual Azure Function.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">internal</span> <span class="k">class</span> <span class="nc">QueueMessage</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
	Add the following NuGet packages to your project:<br />
- Microsoft.Extensions.Configuration.Json, used to access the appsettings file<br />
- WindowsAzure.Storage, used to access the queue storage<br />
<p>
	The code below shows the program.cs that can create and post a message.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Auth</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Queue</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">QueueMessageClient</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Get access to appsettings
</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConfigurationBuilder</span><span class="p">()</span>
               <span class="p">.</span><span class="nf">SetBasePath</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">GetCurrentDirectory</span><span class="p">())</span>
               <span class="p">.</span><span class="nf">AddJsonFile</span><span class="p">(</span><span class="s">"appsettings.json"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

            <span class="c1">//Get or create queue in StorageAccount
</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CloudQueueClient</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageUri"</span><span class="p">]),</span> 
                <span class="k">new</span> <span class="nf">StorageCredentials</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageAccountName"</span><span class="p">],</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageAccountKey"</span><span class="p">]));</span>
            <span class="kt">var</span> <span class="n">queue</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetQueueReference</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s">"AzureStorageQueueName"</span><span class="p">]);</span>
            <span class="kt">var</span> <span class="n">creationresult</span> <span class="p">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">CreateIfNotExistsAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>

            <span class="c1">//Create and send message as JSON
</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">QueueMessage</span>
            <span class="p">{</span>
                <span class="n">Order</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
                <span class="n">Person</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
                <span class="n">Status</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">OrderStatus</span><span class="p">.</span><span class="n">Processed</span>
            <span class="p">};</span>
            <span class="kt">var</span> <span class="n">messageJSON</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
            <span class="n">queue</span><span class="p">.</span><span class="nf">AddMessageAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">CloudQueueMessage</span><span class="p">(</span><span class="n">messageJSON</span><span class="p">)).</span><span class="nf">Wait</span><span class="p">();</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Message Sent"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
	Use the Cloud explorer to check if your message has been created in the queue.
	<br /><img src="/assets/images/20180608/CloudExplorerAndQueueWindows.png" alt="Cloud Explorer and Queue windows" />
</p>
<p>
	To post a message to an actual Azure Blob Storage, simply replace the access credentials and storage uri to values associated to an existing Azure Blob Storage.
</p>
<h3>Create a local database</h3>
<p>
	I've added a simple database project to my example solution. Create a local database in your SQL Instance, do a Schema Compare and create the tables and then run the testdata script included for a few records of data.
	(For more information on these steps outlined see my <a href="https://samanthaneilen.github.io/2017/11/24/managing-a-sql-server-database-from-a-visual-studio-database-project.html" target="_blank">previous blog post</a> on using a database project.
</p>
<h3>Create an Azure Function project</h3>
<p>
	The Azure Function project can be found under the cloud category (the Azure workload needs to be installed). When you create a project you immediately get a popup asking what kind of function you want to create within the project.
	<br /><img src="/assets/images/20180608/AzureFunctionProject.png" alt="Azure Function Project" />
</p>
<p>
	Notice the popup for the version of your function. Azure Functions V1 is based on the full .Net Framework and currently supports more triggers and bindings than the Azure Functions V2 that is currently still in preview and is based on the .Net Standard Framework. The choices for the kind of Azure Function to create with the project are actually limited to the most common ones. If you do not see the trigger you want to use, select the empty option and use the File then New option in the project context menu in the Solution Explorer to add a new Azure Function.	
</p>
<p>
Function V1 default trigger dialog:
<br /><img src="/assets/images/20180608/CreateV1Function.png" alt="Create V1 Function" />
</p>
<p>
Function V2 default trigger dialog:
<br /><img src="/assets/images/20180608/CreateV2Function.png" alt="Create V2 Function" />
</p>
<p> 
	When using the Add then Add New Item option in the context menu of the project, you get a lot more options for the Azure Function that you want to create.
</p>
<p>
    Add New Item dialog:
    <br /><img src="/assets/images/20180608/AzureFunctionItem.png" alt="Azure Function Item" />
</p>
<p>
	Azure Function version 1 triggers:
	<br /><img src="/assets/images/20180608/AzureFunctionTypesV1.png" alt="Azure Function Types V1" />
</p>
<p>
	Azure Function version 2 triggers:
	<br /><img src="/assets/images/20180608/AzureFunctionTypesV2.png" alt="Azure Function Types V2" />
</p>
<p>In my example project I created a Queue Function. For the settings I used the UseDevelopment storage and chose AzureWebJobsStorage for my connectionstring. A default project contains the Function1.cs with the default input variables defined by the chosen function template. More information on the bindings can be found <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings" target="_blank">here</a>.
</p>
<p>Default content of Function1.cs for a queue trigger</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Function1</span>
<span class="p">{</span>
	<span class="p">[</span><span class="nf">FunctionName</span><span class="p">(</span><span class="s">"Function1"</span><span class="p">)]</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="kt">string</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
Other than the Function1.cs there is a local.settings.json and a host.json. The local.settings.json is your appsettings file for running locally. When deployed to Azure the Azure Function will use the appsettings defined in the Application Settings page of the Function App in the Azure Portal. 
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"IsEncrypted"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AzureWebJobsStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"AzureWebJobsDashboard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
The host.json is used to defined certain runtime settings. Possible settings and the defaults if no settings are defined can be found <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-host-json" target="_blank">here </a>. The most important setting in the host.json is the functionTimeout setting. Azure Functions that run on a consumption plan only have a timeout of 5 minutes, meaning that the execution is terminated after 5 minutes without any decent error. When persisting state within the function this may lead to  leaving data in an unfinished or corrupted state. In a queue function a  message is set invisible when processing and only removed from the queue after being fully processed. When processing is interrupted without removing the message, the message will become visible again after a configurable timeout. The message then triggers another run of the Azure Function. This can trigger an infinite loop of failing requests in the message never finishes processing within the functionTimeout interval. On a consumption (pay-as-you-go plan) you can currently set the maximum to a 10 minute timeout. If you have workloads that need more processing time you should switch to an app service billing plan and be sure to remove the functionTimeout setting from the host.json to avoid functions being terminated.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
	</span><span class="s2">"functionTimout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00:10:00"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
The next thing of interest is the NuGet package for the Azure Function SDK called Microsoft.NET.Sdk.Functions. 
<br /><img src="/assets/images/20180608/NuGetSdkFunctions.png" alt="NuGet Sdk Functions" />
<br />
This NuGet contains al the references that are available in the Azure Function Environment. A thing to remember when using functionality, like accessing azure storage, is to use the version referenced in the SDK package because the Azure Function Apps runtime does not run the latest versions of packages like AzureStorage or SendGrid. When creating separate referenced class libraries use the same version Azure Function SDK to avoid mismatching dependencies. You will get a runtime error stating that the dependent dll with the expected version number is not found.
</p>
<p>
Now that we have an Azure Function that can respond to a queue message and that logs a logmessage. Run the project, you can add a breakpoint to the log line to see that debugging works as expected. Azure Functions projects start a console with logging as shown below.
<p>
	Azure Function v1 run in the console window:
	<br /><img src="/assets/images/20180608/ConsoleRunningFunctionV1.png" alt="Console Running Function V1" />
</p>
<p>
	Azure Function v2 run in the console window:
	<br /><img src="/assets/images/20180608/ConsoleRunningFunctionV2.png" alt="Console Running Function V1" />
</p>
</p>
Debugging one of the Functions:
<br /><img src="/assets/images/20180608/DebugDefaultAzureFunction.png" alt="DebugDefaultAzureFunction" />
</p>
<p>When working with queue triggers be aware that only one Function can respond to a queue message. If multiple functions are listening to the same queue only the first to respond to the message (and set the message invisible) will execute.</p>
<p>
There is one known issue when running a V2 Azure Function in that it has trouble finding the Azure CLI Runtime located in you Users/AppData/ folder when the path (usually your usename) contains spaces. Introduce a launchSettings.json file inside a properties folder in your project directory to help the runtime out in locating the correct location for the needed assemblies as described <a href="https://github.com/Azure/Azure-Functions/issues/623" target="_blank">here</a>.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"MyApp"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"commandName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Executable"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"executablePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">Program Files</span><span class="se">\\</span><span class="s2">dotnet</span><span class="se">\\</span><span class="s2">dotnet.exe"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"commandLineArgs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"</span><span class="se">\"</span><span class="s2">C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">XXXX</span><span class="se">\\</span><span class="s2">AppData</span><span class="se">\\</span><span class="s2">Roaming</span><span class="se">\\</span><span class="s2">npm</span><span class="se">\\</span><span class="s2">node_modules</span><span class="se">\\</span><span class="s2">azure-functions-core-tools</span><span class="se">\\</span><span class="s2">bin</span><span class="se">\\</span><span class="s2">Azure.Functions.Cli.dll</span><span class="se">\"</span><span class="s2"> host start"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"workingDirectory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$(TargetDir)"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span></code></pre></figure>

<p>
When running and debugging the message you can see that the message input is currently a string that needs to be deserialised. Since the structure is a known JSON input you can just add a class defining this structure to your Function project or a referenced class library and replace string type input with the type of your class.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">QueueMessage</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span></code></pre></figure>

<p>
After doing this you can see in the debugger that you get a nice object input ready for use in your function code. 
<br /><img src="/assets/images/20180608/DebugSerializedInput.png" alt="Debug Serialized Input" />	
</p>
<h3>Access the database using Entity Framework Core</h3>
<p>
For the data access framework I will be using Entity Framework Core. Add the Microsoft.EntityFrameworkCore.SqlServer NuGet package to your Function project or a referenced class library and specify a database context as shown below:
</p>
<p>Person class:

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">Person</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Orders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</p>
<p>Order class:

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">PersonID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>        
        <span class="k">public</span> <span class="kt">string</span> <span class="n">OrderNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="n">Person</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</p>
<p>Context class:

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>


        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">HasMany</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Orders</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">WithOne</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Person</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">HasForeignKey</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">OrderDbContext</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DbContextOptionsBuilder</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;().</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Options</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</p>
<p>
Next add a connectionstring to your local.settings.json referencing the database you created with the database project.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"OrderDbConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Server=.</span><span class="se">\\</span><span class="s2">SQLEXPRESS;Database=OrderDb;Integrated Security=True;"</span></code></pre></figure>

<p>
Then add the code to your Azure Function to create and call the context. The code snippet below shows how to get the ordernumber and person name into a MailSettings object that can be used as input for a mail sending service class.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">MailData</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">PersonName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">OrderNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="n">EmailTemplate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">OrderDbContext</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
	<span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Person</span><span class="p">);</span>

	<span class="kt">var</span> <span class="n">mailData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MailData</span>
	<span class="p">{</span>
		<span class="n">PersonName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
		<span class="n">Email</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
		<span class="n">OrderNumber</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderNumber</span><span class="p">,</span>
		<span class="n">Status</span> <span class="p">=</span> <span class="p">((</span><span class="n">OrderStatus</span><span class="p">)</span><span class="n">myQueueItem</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(),</span>
		<span class="n">EmailTemplate</span> <span class="p">=</span> <span class="n">blobService</span><span class="p">.</span><span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateContainerName"</span><span class="p">),</span>
			<span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateBlobName"</span><span class="p">))</span>
	<span class="p">};</span>

	<span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Debug or log the contents of the MailSettings object instance to check if the database data is retrieved as expected.
</p>
<p> </p>
<h3>Retrieve an emailtemplate file from a blobstorage</h3>
<p>
First create a emailtemplate html as shown below and upload it to an emaltemplate container in your local development blob storage. The text between brackets will be replaced with the data we retrieved from the database before sending the email.
</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/1999/xhtml"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Dear {CONTACT},<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>You order with ordernumber {ORDERNUMBER} now has status {STATUS}.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Regards,<span class="nt">&lt;br/&gt;</span>
        Sender
    <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure>

<p> 
Next add the Microsoft.NET.Sdk.Functions NuGet package to your Function project or class library so we have a reference to the WindowsAzureStorage. 
Below is the code to get a reference to a blob storage, get the file as a stream and then read the stream from the beginning to get the contents of a blob as a string. 
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Auth</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Blob</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">BlobStorageService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_storageUri</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_accountName</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_key</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">BlobStorageService</span><span class="p">(</span><span class="kt">string</span> <span class="n">storageUri</span><span class="p">,</span> <span class="kt">string</span> <span class="n">accountName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_storageUri</span> <span class="p">=</span> <span class="n">storageUri</span><span class="p">;</span>
            <span class="n">_accountName</span> <span class="p">=</span> <span class="n">accountName</span><span class="p">;</span>
            <span class="n">_key</span> <span class="p">=</span> <span class="n">key</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="kt">string</span> <span class="n">containerName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">emailTemplateName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="n">CloudBlobClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CloudBlobClient</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">_storageUri</span><span class="p">),</span> <span class="k">new</span> <span class="nf">StorageCredentials</span><span class="p">(</span><span class="n">_accountName</span><span class="p">,</span> <span class="n">_key</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetContainerReference</span><span class="p">(</span><span class="n">containerName</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="nf">ExistsAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">blob</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="nf">GetBlobReference</span><span class="p">(</span><span class="n">emailTemplateName</span><span class="p">);</span>
                    <span class="n">blob</span><span class="p">.</span><span class="nf">DownloadToStreamAsync</span><span class="p">(</span><span class="n">stream</span><span class="p">).</span><span class="nf">Wait</span><span class="p">();</span>

                    <span class="n">stream</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> 
                    <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamReader</span><span class="p">(</span><span class="n">stream</span><span class="p">).</span><span class="nf">ReadToEnd</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Container </span><span class="p">{</span><span class="n">containerName</span><span class="p">}</span><span class="s"> not found"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>        
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
All of the parameters for the constructor en method will be defined in the local.settings.json of the calling assembly so we can easily change the location and name of the emailtemplate without the need to redeploy the function. The settings below show the connection to the local Azure Emulator blob storage.
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"BlobStorageUri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:10000/devstoreaccount1"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BlobStorageAccount"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devstoreaccount1"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BlobStorageKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw=="</span><span class="p">,</span><span class="w">
</span><span class="s2">"EmailTemplateContainerName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"emailtemplates"</span><span class="p">,</span><span class="w">
</span><span class="s2">"EmailTemplateBlobName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"emailtemplate.html"</span></code></pre></figure>

<p>
Next we can create the blobservice in our function instance and call the method to get the emailtemplate contents as a string.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">OrderDbContext</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">blobService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlobStorageService</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageUri"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageAccount"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageKey"</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Person</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">mailData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MailData</span>
    <span class="p">{</span>
        <span class="n">PersonName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
        <span class="n">Email</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
        <span class="n">OrderNumber</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderNumber</span><span class="p">,</span>
        <span class="n">Status</span> <span class="p">=</span> <span class="p">((</span><span class="n">OrderStatus</span><span class="p">)</span><span class="n">myQueueItem</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(),</span>
        <span class="n">EmailTemplate</span> <span class="p">=</span> <span class="n">blobService</span><span class="p">.</span><span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateContainerName"</span><span class="p">),</span>
            <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateBlobName"</span><span class="p">))</span>
    <span class="p">};</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
When calling this code from the Azure Function V1 (Framework project), referencing a .Net Standard 2.0 library you will get a runtime error because as stated before referenced dll versions in the referenced SDK NuGet package do not match.
<br /><img src="/assets/images/20180608/AzureStorageDLLVersionError.png" alt="AzureStorageDLLVersionError" />
<br /><img src="/assets/images/20180608/AzureStoragePackageVersionDifferences.png" alt="AzureStorage Package Version Differences" />
<br />
To resolve this issue add the matching Windows Azure Storage version NuGet package to the Azure Function V1 project. After that it will have the proper version in the output directory of the Azure Function Project.
</p>
<p><br /><img src="/assets/images/20180608/ExtraWindowsAzureStoragePackage.png" alt="Extra Windows Azure Storage Package" /></p>
<p>
Again you can use the console or debugger to verify that the retrieved string matches the contents of the uploaded file. 
</p>
<h3>Send an email using the SendGrid email client</h3>
<p>
Now that we have all the settings data and a html string with placeholders for the data, we can add a sendemailservice to our project. (There is also an output binding that can send an email using a Azure SendGrid resource as explained <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-sendgrid" target="_blank">here</a>) but I prefer creating a custom serviceclient because you can change the implementation to use another online emailing service if needed and have more control for error handling.
</p>
<p>
First add the SendGrid NuGet package. Then add EmailService as show below. The key passed in the constructor is a unique API key that you can create in your SendGrid account under the Settings then API Keys option.
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">AzureFunctionsExample.Shared</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">SendGrid</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">SendGrid.Helpers.Mail</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionExample.ResourceAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_apiKey</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_from</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">HttpStatusCode</span><span class="p">&gt;</span> <span class="n">_validStatusCodes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HttpStatusCode</span><span class="p">&gt;{</span>
            <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">Accepted</span><span class="p">,</span>
            <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span>
        <span class="p">};</span>


        <span class="k">public</span> <span class="nf">EmailService</span><span class="p">(</span><span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span> <span class="kt">string</span> <span class="k">from</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_apiKey</span> <span class="p">=</span> <span class="n">apiKey</span><span class="p">;</span>
            <span class="n">_from</span> <span class="p">=</span> <span class="k">from</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="k">public</span> <span class="k">void</span> <span class="nf">SendEmail</span><span class="p">(</span><span class="n">MailData</span> <span class="n">mailData</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendGridMessage</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">From</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmailAddress</span><span class="p">(</span><span class="n">_from</span><span class="p">)</span>
            <span class="p">};</span>

            <span class="n">message</span><span class="p">.</span><span class="nf">AddTo</span><span class="p">(</span><span class="k">new</span> <span class="nf">EmailAddress</span><span class="p">(</span><span class="n">mailData</span><span class="p">.</span><span class="n">Email</span><span class="p">));</span>

            <span class="n">message</span><span class="p">.</span><span class="n">HtmlContent</span> <span class="p">=</span> <span class="n">mailData</span><span class="p">.</span><span class="n">EmailTemplate</span>
                <span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{CONTACT}"</span><span class="p">,</span><span class="n">mailData</span><span class="p">.</span><span class="n">PersonName</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{ORDERNUMBER}"</span><span class="p">,</span> <span class="n">mailData</span><span class="p">.</span><span class="n">PersonName</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{STATUS}"</span><span class="p">,</span> <span class="n">mailData</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
                
            <span class="n">message</span><span class="p">.</span><span class="n">Subject</span> <span class="p">=</span> <span class="s">"Mail from Azure Function"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendGridClient</span><span class="p">(</span><span class="n">_apiKey</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendEmailAsync</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_validStatusCodes</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Error sending mail"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
Next we add the API key and from email settings to the local.settings.json file and then create the mailservice calls the with the data in the Function. 
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"SendGridApiKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOUR_KEY_HERE"</span><span class="p">,</span><span class="w">
</span><span class="s2">"FromEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YOUR_SENDER_EMAIL_HERE"</span><span class="p">,</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[FunctionName("ProcessMessageV1")]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">QueueTrigger</span><span class="p">(</span><span class="s">"messages"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"AzureWebJobsStorage"</span><span class="p">)]</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">OrderDbContext</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">blobService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlobStorageService</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageUri"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageAccount"</span><span class="p">),</span>
        <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"BlobStorageKey"</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Person</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">mailData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MailData</span>
    <span class="p">{</span>
        <span class="n">PersonName</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
        <span class="n">Email</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
        <span class="n">OrderNumber</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">OrderNumber</span><span class="p">,</span>
        <span class="n">Status</span> <span class="p">=</span> <span class="p">((</span><span class="n">OrderStatus</span><span class="p">)</span><span class="n">myQueueItem</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(),</span>
        <span class="n">EmailTemplate</span> <span class="p">=</span> <span class="n">blobService</span><span class="p">.</span><span class="nf">GetEmailTemplateContents</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateContainerName"</span><span class="p">),</span>
            <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"EmailTemplateBlobName"</span><span class="p">))</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">senGridService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmailService</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"SendGridApiKey"</span><span class="p">),</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"FromEmail"</span><span class="p">));</span>
    <span class="n">senGridService</span><span class="p">.</span><span class="nf">SendEmail</span><span class="p">(</span><span class="n">mailData</span><span class="p">);</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Next run the function to send an email with your SendGrid account. (Some servers or domain names may have the SendGrid domain blacklisted and deny delivery but you can verify mails send in your SendGrid account under the Activity setting) 
</p>
<h3>Some notes on publishing to Azure</h3>
<p>Sometimes a publish to a new Azure Function app fails because the Function app resource is not created fast enough. Usually a second publish will succeed.</p>
<p>You cannot publish a version 1 Azure Function to a version 2 Azure Function app and publishing an Azure Function v2 app to an existing v1 app will cause a pop-up asking if you want to upgrade the version.</p>
<p>Publishing will not create the appropriate Application Setting keys for the Azure Function app in Azure. You will have to create them separately in the Azure portal.</p>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/04/20/podcasts-a-tip-for-consuming-it-related-content-on-the-go.html">Podcasts, a tip for consuming IT related content on the go</a>
        </header>
        
        <span>Apr 20, 2018</span> <br />
        Tags: 
        <div class="article-content">
            <p>
This month no technical article but a tip I want to share. For written content I usually tend to focus on books and lose track of blogs. With podcasts I can just listen on my work commute or exercise walks. There is a lot of free and actively updated content out there and the podcasts can be listened to from your phone from the different podcast apps out there like <a href="https://www.stitcher.com/" target="_blank">Stitcher</a> for Android or <a href="https://www.apple.com/itunes/" target="_blank">Itunes</a> for Apple devices. 
</p>
<h3>.Net/Microsoft specific shows</h3>
<ul>
    <li>
        <a href="https://www.dotnetrocks.com/" target="_blank"><b>.Net rocks</b></a><p>
        A show with interviews about .Net subjects. Mostly features interviews with Microsoft employee’s about their projects. Shows come out multiple times in a week and shows are about 45-60 minutes.
    </p></li>
    <li>
        <a href="https://msdevshow.com/" target="_blank"><b>MS dev show </b></a><p>
        A show with interviews about .Net subjects. Mostly features interviews with people about their .Net projects. Shows come out once every week, sometimes they have bigger gaps in their shedule. Shows are about 45-60 minutes long.
    </p></li>
    <li>
        <a href="http://www.mergeconflict.fm/" target="_blank"><b>Merge conflict</b></a><p>
        A show where 2 developers talk about their experiences and projects has a .NET focus but may also sometimes dive into other technology. Shows come out every week and are about 45-60 minutes long.
    </p></li>
    <li>
        <a href="https://www.microsoft.com/en-us/research/blog/category/podcast/" target="_blank"><b>Microsoft research podcast</b></a><p>
        Interview with employees at Microsoft research about their project. This podcast is less developer focused and features a variety of subjects researched at Microsoft. Shows come out every week and are about 30 minutes long.
    </p></li>   
</ul>
<h3>General IT shows</h3>
<ul>
     <li>
        <a href="https://www.codingblocks.net/" target="_blank"><b>Coding Blocks</b></a><p>
        3 developers talk about patterns, practices and design methodologies. Shows usually come out every one or 2 weeks and are about 90-120 minutes long.
    </p></li>
    <li>
        <a href="http://developeronfire.com/" target="_blank"><b>Developer on fire</b></a><p>
        Interviews with developers, follows a pattern of personal stories about their failures, successes, book recommendations and tips for other developers. Shows come out once or twice a week and are about 45 minutes long.
    </p></li>
    <li>
        <a href="https://www.hanselminutes.com/" target="_blank"><b>Hanselminutes</b></a><p>
        Interviews that Scott Hanselman from Microsoft has with a variety of people related to technology. Shows come out every week and are about 30 minutes long.
    </p></li>
        <li>
        <a href="https://www.codenewbie.org/" target="_blank"><b>CodeNewbie</b></a><p>
        Feature interviews about how people got into tech and their experiences in the developer world. Shows come out in seasons of weekly shows that are about 45 minutes long.
    </p></li>
        <li>
        <a href="https://learntocodewith.me/" target="_blank"><b>Learn to code with me</b></a><p>
        Interviews with developers on how they got started with their jobs. Shows come out in seasons of weekly episodes and are about 30-60 minutes long.
    </p></li>
    <li>
        <a href="https://www.legacycode.rocks/" target="_blank"><b>Legacy code rocks</b></a><p>
        Interviews with people about working with legacy code. Shows come out irregular and are about 45-60 minutes long.
    </p></li>
    <li>
        <a href="https://securityweekly.com/" target="_blank"><b>Paul’s security weekly</b></a><p>
        Discussions and interviews about security. The podcasts features numerous shows that zoom in on the various IT fields. Application Security weekly focusses on the developer side of things. This show also has a version with video, sometimes the interviews are demos and are not easily followed with audio only. Features multiple themed shows a week that are about 60-120 minutes long.
    </p></li>
    <li>
        <a href="https://softwareengineeringdaily.com/" target="_blank"><b>Software engineering daily</b></a><p>
        Daily shows featuring interviews with software engineers about a wide range of topics and technologies. Shows come out every business day and are about 60 minutes long.
    </p></li>
    <li>
        <a href="http://www.se-radio.net/" target="_blank"><b>Software Engineering Radio</b></a><p>
        Interviews with software engineers about a wide range of topics and technologies. Shows come out every 2 to 3 weeks and last about 60 minutes.
    </p></li>
    <li>
        <a href="https://joecolantonio.com/testtalks/" target="_blank"><b>TestTalks</b></a><p>
        A show featuring interviews about test automation. Shows come out every week and are about 30-45 minutes long.
    </p></li>
    <li>
        <a href="https://thewomenintechshow.com/" target="_blank"><b>The Women in Tech show</b></a><p>
        A show featuring interviews with software engineers (mostly women) and their projects and experiences. Shows come out every week and are about 30-60 minutes long.
    </p></li>
    <li>
        <a href="https://spec.fm/podcasts/developer-tea" target="_blank"><b>Developer tea</b></a><p>
        A show about taking on a learning mindset and developing you soft skills. Comes out 3 times a week and shows are about 20-30 minutes long. 
    </p></li>
    <li>
        <a href="http://www.weeklydevtips.com/" target="_blank"><b>Weekly dev tips</b></a><p>
        A show by Steve Smith about patterns and practices for developers. Shows come out very irregular and are about 5-10 minutes long. 
    </p></li>
    <li>
        <a href="https://channel9.msdn.com/Shows/Visual-Studio-Toolbox" target="_blank"><b>Visual Studio Toolbox</b></a><p>
        A video podcast affiliated with channel 9 that features demos about the tooling and usage of Visual Studio en Visual Studio Team Services. Shows come out about every 2 weeks and vary in length from 15-60 minutes.
    </p></li>  
</ul>
<h3>Shows about agile &amp; scrum</h3>
<ul>
    <li>
        <a href="https://scrum-master-toolbox.org/" target="_blank"><b>Scrum master toolbox</b></a><p>
        Interviews with scrum masters about their experiences. Features a set schedule of “theme-days” covering successes, failures, book recommendations, retro format recommendations. Shows come out every businessday and are about 10-20 minutes long.
    </p></li>
    <li>
        <a href="https://ryanripley.com/agile-for-humans/" target="_blank"><b>Agile for humans</b></a><p>
        This shows features subjects and Interviews relating to the scrum/agile way of working in teams. Shows come out about every week but may sometimes have gaps in the schedules. Shows vary in length from 30-45 minutes.
    </p></li>
</ul>

        </div>
    </article>
    
    <center><p><a href="/archive">For additional posts see the archive page for an overview of all available posts</a></p></center>
    
</div>

                </main>
            </div>
            <div class="col-md-3">
                <aside aria-label="sidebar">
                    <section class="sidebar-section">
    <h3>About me</h3>
    I am a dutch .Net developer.
    I have been coding professionaly since 2008.
    On this blog I will be writing about multiple subjects that I use in my daily programming job or subjects that I am studying.
</section>
<section class="sidebar-section">
    <h3>Social</h3>
    <a href="https://github.com/SamanthaNeilen"><i class="fa fa-github" aria-hidden="true"></i><span>&nbsp;SamanthaNeilen</span></a> <br />
    <a href="https://twitter.com/NeilenSamantha"><i class="fa fa-twitter" aria-hidden="true"></i><span>&nbsp;NeilenSamantha</span></a> <br />
    <a href="https://www.linkedin.com/in/samantha-neilen-16153713"><i class="fa fa-linkedin" aria-hidden="true"></i><span>&nbsp;Samantha Neilen</span></a><br />
    Subscribe via <a href="/feed.xml">RSS</a>
</section>
<section class="sidebar-section">
    <h3>Last posts </h3>
    
    <a href="/2018/10/09/using-route-constraints-for-input-validation-and-improved-security.html">Using route constraints for input validation and improved security</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/08/17/tls1.2-not-supported-by-default-in-older-net-framework-applications.html">TLS1.2 not supported by default in older .NET Framework applications</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/07/14/csharp-script-azure-functions-example.html">C# script Azure Functions example</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/06/08/pre-compiled-azure-functions-example.html">Pre-compiled Azure Functions example</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/04/20/podcasts-a-tip-for-consuming-it-related-content-on-the-go.html">Podcasts, a tip for consuming IT related content on the go</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/archive">Archive</a>
</section>
                </aside>
            </div>
        </div>
    </div>
</body>
</html>
