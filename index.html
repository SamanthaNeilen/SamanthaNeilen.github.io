<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Samantha Neilen</title>
    <meta name="description" content="My name is Samantha Neilen, a dutch .Net developer. I have been coding professionaly since 2008. On this blog I will be writing about multiple subjects that ...">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/site.css" />
    <link rel="canonical" href="https://samanthaneilen.github.io/">
    <link rel="alternate" type="application/rss+xml" title="Samantha Neilen" href="/feed.xml">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
    <header aria-label="header" class="header">
        <span class="header-text">Samantha Neilen</span>
    </header>
</div>
        <div class="row">
            <div class="col-md-7 col-md-offset-1">
                <main class="page-content" aria-label="content">
                    <div>
    
    
    
    <article>
        <header class="article-header">
            <a href="/2019/01/19/Web-API-versioning-using-the-NuGet-packages-from-Microsoft.html">Web API versioning using the NuGet packages from Microsoft</a>
        </header>
        
        <span>Jan 19, 2019</span> <br />
        Tags: 
        WebAPI
        
        <div class="article-content">
            <p>When developing a Web API, using versioning can greatly improve flexibility for production deployments. Even if the contract for your API changes, current users will not be impacted if you keep supporting the version they currently use. Using versioning will allow the consumers of your service more time to upgrade to newer versions and it will at the same time allow you to deploy on demand. At some point in time certain versions should of course be deprecated and finally removed to improve maintainability of the software.</p>

<p>Microsoft has several NuGet packages available to easily configure versioning in your API:</p>

<p><strong>NET core:</strong> <br />
Microsoft.AspNetCore.Mvc.Versioning<br />
Microsoft.AspNetCore.Mvc.Versioning.ApiExplorer</p>

<p><strong>NET framework:</strong><br />
Microsoft.AspNet.WebApi.Versioning<br />
Microsoft.AspNet. WebApi.Versioning.ApiExplorer</p>

<p>The ApiExplorer package is only needed when using the API metadata for each version (like for Swagger documentation).</p>

<p>In this blogpost I will describe how to enable versioning for your API including version support for the Swagger UI documentation. This blogpost will only describe these steps for a .NET Core projects. A complete solution with the code can be found in my <a href="https://github.com/SamanthaNeilen/WebApiExamples" title=" WebApiExamples GitHub repository ">WebApiExamples GitHub repository</a>. A .NET Framework example can be found on the <a href="https://github.com/Microsoft/aspnet-api-versioning/tree/master/samples/webapi/SwaggerWebApiSample" title="Microsoft.Asp.Net.WebApi.Versioning github repository for a sample project">Microsoft.Asp.Net.WebApi.Versioning github repository for a sample project</a>. The default Startup classes for the .NET Framework will need to be set up a little different from a project without versioning.</p>

<p>A small disclaimer: I will only show how to get started with versioning. When creating a new version, you should always think about support for previous versions or graceful degradation. Especially when you do database or schema changes. You must be careful not to break a previous version and may have to support multiple classes (or even database objects) with v1, v2 etcetera in their name or namespace if they are still used in a previous supported version. It is always a good idea when building an API to have integration tests. Having regression tests for the previous versions can ensure not breaking those versions while focusing on the new version.</p>

<p>The <a href="https://github.com/Microsoft/aspnet-api-versioning/wiki" title="Microsoft.Asp.Net.WebApi.Versioning github repository wiki">Microsoft.Asp.Net.WebApi.Versioning github repository wiki</a> contains all the documentation for the configuration and possibilities of the Microsoft.Asp.Net.WebApi.Versioning packages.</p>

<h3 id="minimal-configuration-for-versioning">Minimal configuration for versioning</h3>

<p>First install the NuGet package Microsoft.AspNetCore.Mvc.Versioning in your web project.</p>

<p>Next go to the Startup.cs file and add the code shown below to enable the default versioning by querystring.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//other code omitted</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddApiVersioning</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">o</span><span class="p">.</span><span class="n">AssumeDefaultVersionWhenUnspecified</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">o</span><span class="p">.</span><span class="n">DefaultApiVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ApiVersion</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">().</span><span class="nf">SetCompatibilityVersion</span><span class="p">(</span><span class="n">CompatibilityVersion</span><span class="p">.</span><span class="n">Version_2_1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is all you need to enable versioning. The 2 options set in this snippet ensure that your current API will act as version 1.0 and that everyone that calls your service without a version querystring receives that version. (If you use Swagger documentation via Swashbuckle you will need extra configuration to ensure Swagger file generation keeps working. See the “Setup versioning for Swagger documentation using the Swashbuckle NuGet package” section later in this post.)</p>

<p>In my <a href="https://github.com/SamanthaNeilen/WebApiExamples" title=" WebApiExamples GitHub repository ">WebApiExamples GitHub repository</a> I have an API endpoint on the route <span class="link-style">https://localhost:44314/api/routingapi/123</span>. After adding the versioning configuration, this API is still available and responding to that address. Next I can call <span class="link-style">https://localhost:44314/api/routingapi/123?api-version=2.0</span>. Since I did not define a version 2.0 (at this point), I will receive the automatic error generated from the versioning package as shown below.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s2">"error"</span><span class="p">:{</span><span class="s2">"code"</span><span class="p">:</span><span class="s2">"UnsupportedApiVersion"</span><span class="p">,</span><span class="s2">"message"</span><span class="p">:</span><span class="s2">"The HTTP resource that matches the request URI 'https://localhost:44314/api/routingapi/123' does not support the API version '2.0'."</span><span class="p">,</span><span class="s2">"innerError"</span><span class="p">:</span><span class="kc">null</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>I can now add a RouteApiV2Controller with a new interface to listen to the same url on V2. The code for the RouteApiController (that’s listening to version 1.0 or no ApiVersion specification) and RouteApiV2Controller are shown below.</p>

<p>RouteApiController:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">ApiVersion</span><span class="p">(</span><span class="s">"1.0"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RoutingApiController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">) (DEFAULT VERSION)"</span><span class="p">);</span>
        <span class="p">}</span>        

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{validPositiveInt32Value:range(0,2147483647)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">validPositiveInt32Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">validPositiveInt32Value</span><span class="p">)}</span><span class="s"> (DEFAULT VERSION)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{inputMatchingRegex:regex(^(.+)(_)(.+)$)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">GetByRegex</span><span class="p">(</span><span class="kt">string</span> <span class="n">inputMatchingtRegexForValueContainingUnderscore</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">inputMatchingtRegexForValueContainingUnderscore</span><span class="p">)}</span><span class="s">) (DEFAULT VERSION)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>RouteApiV2Controller:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/RoutingApi"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="p">[</span><span class="nf">ApiVersion</span><span class="p">(</span><span class="s">"2.0"</span><span class="p">)]</span>    
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RoutingApiV2Controller</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">) (V2)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{validPositiveInt32Value:range(0,2147483647)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">validPositiveInt32Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">validPositiveInt32Value</span><span class="p">)}</span><span class="s"> (V2)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice that the V2 controller maps to the same path but is missing an endpoint.</p>

<p>When calling <span class="link-style">https://localhost:44314/api/routingapi/123</span> the service will return the default version. When calling <span class="link-style">https://localhost:44314/api/routingapi/123?api-version=2.0</span> it will execute and return the RouteApiV2Controller version.</p>

<p>When calling the missing method in v2 <span class="link-style">https://localhost:44314/api/routingapi/some_value?api-version=2.0</span> it will return the error shown below. When calling <span class="link-style">https://localhost:44314/api/routingapi/some_value</span> or <span class="link-style">https://localhost:44314/api/routingapi/some_value?api-version=1.0</span> it will just return the old method for version 1.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UnsupportedApiVersion"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The HTTP resource that matches the request URI 
            'https://localhost:44314/api/routingapi/some_value' does not support the API version '2.0'."</span><span class="p">,</span><span class="w">
        </span><span class="s2">"innerError"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="setup-versioning-for-swagger-documentation-using-the-swashbuckle-nuget-package">Setup versioning for Swagger documentation using the Swashbuckle NuGet package</h3>

<p>If you use Swagger UI via the Swashbuckle package as online documentation for your API you can set up descriptions per version. This will allow you to write release notes per versions and will give consumers documentation that represents actual the version the API that they currently use even if newer versions are available.</p>

<p>If you are using Swagger, the generation of the Swagger file will fail if routes are available for multiple versions and you have changed the configuration for Swagger to support multiple versions.</p>

<p>First install the Microsoft.AspNetCore.Mvc.Versioning.ApiExplorer NuGet package.</p>

<p>Next configure the Swagger configuration for versions in the ConfigureService method in the StartUp.cs as shown below to change the generation of a Swagger.json file per version.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// other code omitted 	</span>

    <span class="c1">// ConfigureSwagger(services) contains the services.AddSwaggerGen(options =&gt; {...}) code see method definition below</span>
    <span class="nf">ConfigureSwagger</span><span class="p">(</span><span class="n">services</span><span class="p">);</span>
 
    <span class="n">services</span><span class="p">.</span><span class="nf">AddApiVersioning</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
	        <span class="n">o</span><span class="p">.</span><span class="n">AssumeDefaultVersionWhenUnspecified</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
	        <span class="n">o</span><span class="p">.</span><span class="n">DefaultApiVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ApiVersion</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="nf">AddVersionedApiExplorer</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">GroupNameFormat</span> <span class="p">=</span> <span class="s">"'V'VVV"</span><span class="p">);</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">().</span><span class="nf">SetCompatibilityVersion</span><span class="p">(</span><span class="n">CompatibilityVersion</span><span class="p">.</span><span class="n">Version_2_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">ConfigureSwagger</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">provider</span> <span class="p">=</span> <span class="n">services</span><span class="p">.</span><span class="nf">BuildServiceProvider</span><span class="p">()</span>
            <span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IApiVersionDescriptionProvider</span><span class="p">&gt;();</span>
        
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">apiVersion</span> <span class="k">in</span> <span class="n">provider</span><span class="p">.</span><span class="n">ApiVersionDescriptions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">ConfigureVersionedDescription</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">apiVersion</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">xmlCommentsPath</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">()</span>
            <span class="p">.</span><span class="n">Location</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"dll"</span><span class="p">,</span> <span class="s">"xml"</span><span class="p">);</span>
        <span class="n">options</span><span class="p">.</span><span class="nf">IncludeXmlComments</span><span class="p">(</span><span class="n">xmlCommentsPath</span><span class="p">);</span>

        <span class="n">options</span><span class="p">.</span><span class="n">OperationFilter</span><span class="p">&lt;</span><span class="n">SwaggerOperationFilter</span><span class="p">&gt;();</span>
        <span class="n">options</span><span class="p">.</span><span class="n">DocumentFilter</span><span class="p">&lt;</span><span class="n">SwaggerDocumentFilter</span><span class="p">&gt;();</span>
    <span class="p">});</span>
<span class="p">}</span>
        
<span class="k">private</span> <span class="k">void</span> <span class="nf">ConfigureVersionedDescription</span><span class="p">(</span><span class="n">SwaggerGenOptions</span> <span class="n">options</span><span class="p">,</span> <span class="n">ApiVersionDescription</span> <span class="n">apiVersion</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//In production code you should probably use a seperate class to get these version descriptions</span>
    <span class="kt">var</span> <span class="n">dictionairy</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> 
    <span class="p">{</span>
        <span class="p">{</span> <span class="s">"1.0"</span><span class="p">,</span> <span class="s">"This API features several endpoints showing different API features for API version V1"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">"2.0"</span><span class="p">,</span> <span class="s">"This API features several endpoints showing different API features for API version V2"</span> <span class="p">}</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">apiVersionName</span> <span class="p">=</span> <span class="n">apiVersion</span><span class="p">.</span><span class="n">ApiVersion</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">options</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="n">apiVersion</span><span class="p">.</span><span class="n">GroupName</span><span class="p">,</span>
        <span class="k">new</span> <span class="nf">Info</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Title</span> <span class="p">=</span> <span class="s">"NetCore.WebApiExample"</span><span class="p">,</span>
            <span class="n">Version</span> <span class="p">=</span> <span class="n">apiVersionName</span><span class="p">,</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">dictionairy</span><span class="p">[</span><span class="n">apiVersionName</span><span class="p">]</span> 
        <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally change the Configure method as shown below to enable the version selection in Swagger UI.(Notice the IApiVersionDescriptionProvider provider parameter is added to the method signature.)</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IHostingEnvironment</span> <span class="n">env</span><span class="p">,</span> <span class="n">IApiVersionDescriptionProvider</span> <span class="n">provider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>

    <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">apiVersion</span> <span class="k">in</span> <span class="n">provider</span><span class="p">.</span><span class="n">ApiVersionDescriptions</span>
                 <span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">version</span> <span class="p">=&gt;</span> <span class="n">version</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()))</span>
        <span class="p">{</span>
            <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerEndpoint</span><span class="p">(</span>
                <span class="s">$"/swagger/</span><span class="p">{</span><span class="n">apiVersion</span><span class="p">.</span><span class="n">GroupName</span><span class="p">}</span><span class="s">/swagger.json"</span><span class="p">,</span>
                    <span class="s">$"NetCore.WebApiExample </span><span class="p">{</span><span class="n">apiVersion</span><span class="p">.</span><span class="n">GroupName</span><span class="p">}</span><span class="s">"</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="n">app</span><span class="p">.</span><span class="nf">UseMvc</span><span class="p">(</span><span class="n">routes</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">"default"</span><span class="p">,</span>
            <span class="n">template</span><span class="p">:</span> <span class="s">"{controller=Home}/{action=Index}/{id?}"</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After this configuration the Swagger UI will have the different versions available in the dropdown to the left. Also notice that the version 2 will only contain the routes and models defined for version 2.</p>

<p>When versioning is enabled the api-version query parameter input field will be automatically added to all methods in Swagger UI.</p>

<p>Swagger UI for version 1:</p>

<p><img src="/assets/images/20190119/SwaggerUIWebAPIV1.png" alt="[Swagger UI API Version 1]" /></p>

<p>Swagger UI for version 2:</p>

<p><img src="/assets/images/20190119/SwaggerUIWebAPIV2.png" alt="[Swagger UI API Version 2]" /></p>

<p>If you use document or operation filters (as explained in <a href="https://samanthaneilen.github.io/2018/12/08/Using-and-extending-swagger.json-for-API-documentation.html" title="my blogpost regarding Swagger/OpenApi/Swashbuckle constraints">my previous post</a>) you may get some unintended behavior when they are executed based on strings and names that overlap over versions.</p>

<p>For example look at the document filter below:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.Swagger</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.SwaggerGen</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.MiddleWare.Swagger</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SwaggerDocumentFilter</span> <span class="p">:</span> <span class="n">IDocumentFilter</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tag</span><span class="p">&gt;</span> <span class="n">_tags</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tag</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Tag</span> <span class="p">{</span> 
            	<span class="n">Name</span> <span class="p">=</span> <span class="s">"RoutingApi"</span><span class="p">,</span> 
            	<span class="n">Description</span> <span class="p">=</span> <span class="s">"This is a description for the api routes"</span> 
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">SwaggerDocument</span> <span class="n">swaggerDoc</span><span class="p">,</span> <span class="n">DocumentFilterContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">swaggerDoc</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">swaggerDoc</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">swaggerDoc</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="nf">GetFilteredTagDefinitions</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
            <span class="n">swaggerDoc</span><span class="p">.</span><span class="n">Paths</span> <span class="p">=</span> <span class="nf">GetSortedPaths</span><span class="p">(</span><span class="n">swaggerDoc</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tag</span><span class="p">&gt;</span> <span class="nf">GetFilteredTagDefinitions</span><span class="p">(</span><span class="n">DocumentFilterContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Filtering ensures route for tag is present</span>
            <span class="kt">var</span> <span class="n">currentGroupNames</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">ApiDescriptions</span>
            	<span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">description</span> <span class="p">=&gt;</span> <span class="n">description</span><span class="p">.</span><span class="n">GroupName</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">_tags</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">tag</span> <span class="p">=&gt;</span> <span class="n">currentGroupNames</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">tag</span><span class="p">.</span><span class="n">Name</span><span class="p">)).</span><span class="nf">ToList</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">PathItem</span><span class="p">&gt;</span> <span class="nf">GetSortedPaths</span><span class="p">(</span>
        	<span class="n">SwaggerDocument</span> <span class="n">swaggerDoc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">swaggerDoc</span><span class="p">.</span><span class="n">Paths</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">pair</span> <span class="p">=&gt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span>
            	<span class="p">.</span><span class="nf">ToDictionary</span><span class="p">(</span><span class="n">pair</span> <span class="p">=&gt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">pair</span> <span class="p">=&gt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The Tag list contains a hardcoded name here that is not present when switching to version 2 of the API (see the screenshots of Swagger UI earlier in the post). If you do not use the context.ApiDescriptions to check there are routes for the group it will end up adding an empty group for version 2. If I did not add the filtering the Swagger UI page for version 2 would have looked as shown in the screenshot below.</p>

<p><img src="/assets/images/20190119/SwaggerUIEmptyTag.png" alt="[Swagger UI with empty Tag]" /></p>

<h3 id="resources">Resources</h3>

<p>For more information on all the features and configuration of the versioning packages visit the link below.</p>

<p><a href="https://github.com/Microsoft/aspnet-api-versioning/wiki" title="Microsoft.Asp.Net.WebApi.Versioning github repository wiki">Microsoft.Asp.Net.WebApi.Versioning github repository wiki</a></p>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/12/08/Using-and-extending-swagger.json-for-API-documentation.html">Using and extending Swagger.json (OpenApi) for API documentation</a>
        </header>
        
        <span>Dec 8, 2018</span> <br />
        Tags: 
        WebAPI
        
        <div class="article-content">
            <p>The <a href="https://en.wikipedia.org/wiki/OpenAPI_Specification" title="OpenAPI specification" target="_blank">OpenAPI specification</a> (previously known as the Swagger specification) is used to describe a web API in a JSON format. An example format is shown below.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebApplication1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is a description for WebApplication1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"/api/Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"Values"</span><span class="w"> </span><span class="p">],</span><span class="w">
        </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Get"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"consumes"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"text/plain"</span><span class="p">,</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w"> </span><span class="s2">"text/json"</span><span class="w"> </span><span class="p">],</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Success"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"uniqueItems"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"post"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"Values"</span><span class="w"> </span><span class="p">],</span><span class="w">
        </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Post"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"consumes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"application/json-patch+json"</span><span class="p">,</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w"> </span><span class="s2">"text/json"</span><span class="p">,</span><span class="w"> </span><span class="s2">"application/*+json"</span><span class="w"> </span><span class="p">],</span><span class="w">
        </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"body"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"required"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="s2">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Success"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>The file describes the endpoint, parameters and returned JSON format for a web API. If you plan to develop an API that will be used by other teams or even 3rd parties outside your company then consider setting up Swagger with the Swashbuckle library for your .NET web API project.</p>

<p>The Swashbuckle library will automaticaly generate the Swagger specification file for your API and even generate a front-end page called Swagger UI. This UI will offer a nice visual overview for your API and also allow user to make calls to the API with build in input validation and view results fot the calls.
Below is screenshot of the UI for the Swagger.json as generated for the definition listed above.</p>

<p><br /><img src="/assets/images/20181208/SwaggerUIExample.png" alt="Swagger UI Example" /></p>

<p>In this blogpost I will show you how to how to enable Swagger UI for your .NET Framework and Core web projects. Be aware that in .NET Framework only API Controller methods will be listed. MVC Controllers and actions will not be listed. 
Next I will show some customizations to the default generated Swagger.json and Swagger UI. For these customizations I will only list the .NET Core code. The .NET Framework (as well as the .NET Core) implementation can be found in my <a href="https://github.com/SamanthaNeilen/WebApiExamples" title=" WebApiExamples GitHub repository " target="_blank">WebApiExamples GitHub repository</a>.</p>

<h3 id="configure-the-generation-of-a-swaggerjson-file">Configure the generation of a Swagger.json file</h3>

<p>To get started install the Swashbuckle NuGet package for a .NET Framework project or Swashbuckle.AspNetCore for a .NET Core project.</p>

<p>Next set up the pipeline in the Startup files to enable the generation of a Swagger.json file and the Swagger UI frontend based on the default meta data for your API.</p>

<p>For .NET Core, go to the Startup.cs file and add the configuration show below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.Swagger</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="p">{</span> 
            <span class="c1">//other configuration omitted...
</span>
 
            <span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span>
                    <span class="k">new</span> <span class="nf">Info</span><span class="p">()</span>
                    <span class="p">{</span>
                        <span class="n">Title</span> <span class="p">=</span> <span class="s">"NetCore.WebApiExample"</span><span class="p">,</span>
                        <span class="n">Version</span> <span class="p">=</span> <span class="s">"1.0"</span><span class="p">,</span>
                        <span class="n">Description</span> <span class="p">=</span> <span class="s">"This API features several endpoints showing different API features"</span>
                    <span class="p">});</span>
            <span class="p">});</span>
 
            <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">().</span><span class="nf">SetCompatibilityVersion</span><span class="p">(</span><span class="n">CompatibilityVersion</span><span class="p">.</span><span class="n">Version_2_1</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IHostingEnvironment</span> <span class="n">env</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//other configuration omitted...
</span>
 
            <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>
 
            <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerEndpoint</span><span class="p">(</span>
                 <span class="s">$"/swagger/v1/swagger.json"</span><span class="p">,</span>
                 <span class="s">$"NetCore.WebApiExample 1.0"</span><span class="p">);</span>
            <span class="p">});</span>
           
            <span class="n">app</span><span class="p">.</span><span class="nf">UseMvc</span><span class="p">(</span><span class="n">routes</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">:</span> <span class="s">"default"</span><span class="p">,</span>
                    <span class="n">template</span><span class="p">:</span> <span class="s">"{controller=Home}/{action=Index}/{id?}"</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>After setting up the Swagger configuration run your project and access the path that now has the SwaggerUI (<span class="link-style">https://localhost:port/swagger</span>). 
The Swagger UI will also have a link to the actual JSON file on which the UI was generated (<span class="link-style">/swagger/v1/swagger.json</span>). The v1 part of this path is the value of the first parameter (name) of the SwaggerDoc method called in the StartUp.cs file.</p>

<p>For a .NET Framework project, a file with a lot of commented out code (App_Start\SwaggerConfig.cs) was added when you installed the NuGet package. This file already enables a default generated Swagger.json endpoint and the Swagger UI frontend.
An example of this file without all the default comments is show below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">WebActivatorEx</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Framework.WebApiExample</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Swashbuckle.Application</span><span class="p">;</span>
 
<span class="na">[assembly: PreApplicationStartMethod(typeof(SwaggerConfig), "Register")]</span>
 
<span class="k">namespace</span> <span class="nn">Framework.WebApiExample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SwaggerConfig</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Register</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">thisAssembly</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">SwaggerConfig</span><span class="p">).</span><span class="n">Assembly</span><span class="p">;</span>
 
            <span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span>
                <span class="p">.</span><span class="nf">EnableSwagger</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">c</span><span class="p">.</span><span class="nf">SingleApiVersion</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span> <span class="s">"Framework.WebApiExample"</span><span class="p">);</span> <span class="p">})</span>
                <span class="p">.</span><span class="nf">EnableSwaggerUi</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> </code></pre></figure>

<p>With this configuration the Swagger UI is again reached on <span class="link-style">https://localhost:port/swagger</span>). Note that the Swagger.json for .NET Framework projects is in a different location (<span class="link-style">/swagger/docs/v1</span>).
Again, be aware that in .NET Framework only API Controller methods will be listed. MVC Controllers and actions will not be listed.</p>

<h3 id="customizing-the-swaggerjson">Customizing the Swagger.json</h3>

<p>All the code shown in this paragraph will only show the .NET Core implementation. The .NET Framework code and configuration will be slightly different. The .NET Framework (as well as the .NET Core) implementation can be found in my <a href="https://github.com/SamanthaNeilen/WebApiExamples" title=" WebApiExamples GitHub repository " target="_blank">WebApiExamples GitHub repository</a>.</p>

<p>The default generated Swagger.json uses the metadata for your classes and methods to generate the specification file. Information such as authentication or other custom headers are not known in the Swagger UI.</p>

<p>You can modify the parameters listed for yourr operation with an extension called an OperationFilter.</p>

<p>An example of an OperationFilter to add a custom header is listed below. You could use for example use this technique to add the Authorization header input fields for secured API.
OperationFilters are run for every discovered method. You can examine the current OperationContext and add conditional logic such as the IsMethodWithHttpGetAttribute function as shown in the example below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.Swagger</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.SwaggerGen</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.MiddleWare.Swagger</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SwaggerOperationFilter</span> <span class="p">:</span> <span class="n">IOperationFilter</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">Operation</span> <span class="n">operation</span><span class="p">,</span> <span class="n">OperationFilterContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">ValidateInput</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nf">IsMethodWithHttpGetAttribute</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">operation</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">NonBodyParameter</span>
                <span class="p">{</span>
                    <span class="n">Name</span> <span class="p">=</span> <span class="s">"extra"</span><span class="p">,</span>
                    <span class="n">In</span> <span class="p">=</span> <span class="s">"query"</span><span class="p">,</span>
                    <span class="n">Description</span> <span class="p">=</span> <span class="s">"This is an extra querystring parameter"</span><span class="p">,</span>
                    <span class="n">Required</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
                    <span class="n">Type</span> <span class="p">=</span> <span class="s">"string"</span>
                <span class="p">});</span>
 
                <span class="n">operation</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">NonBodyParameter</span>
                <span class="p">{</span>
                    <span class="n">Name</span> <span class="p">=</span> <span class="s">"Authorization"</span><span class="p">,</span>
                    <span class="n">In</span> <span class="p">=</span> <span class="s">"header"</span><span class="p">,</span>
                    <span class="n">Description</span> <span class="p">=</span> <span class="s">"Used for certain authorization policies such as Bearer token authentication"</span><span class="p">,</span>
                    <span class="n">Required</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
                    <span class="n">Type</span> <span class="p">=</span> <span class="s">"string"</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
 
        <span class="k">private</span> <span class="k">void</span> <span class="nf">ValidateInput</span><span class="p">(</span><span class="n">Operation</span> <span class="n">operation</span><span class="p">,</span> <span class="n">OperationFilterContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">operation</span><span class="p">));</span>
            <span class="p">}</span>
 
            <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">context</span><span class="p">));</span>
            <span class="p">}</span>
 
            <span class="k">if</span> <span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="n">Parameters</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">operation</span><span class="p">.</span><span class="n">Parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IParameter</span><span class="p">&gt;();</span>
            <span class="p">}</span>
        <span class="p">}</span>
 
        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">IsMethodWithHttpGetAttribute</span><span class="p">(</span><span class="n">OperationFilterContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">MethodInfo</span><span class="p">.</span><span class="n">CustomAttributes</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">attribute</span> <span class="p">=&gt;</span> <span class="n">attribute</span><span class="p">.</span><span class="n">AttributeType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">HttpGetAttribute</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>After defining the OperationFilter you will also have to plug the filter into the Swagger processing pipeline as shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span> 
    <span class="c1">//other configuration omitted...
</span>
 
    <span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span>
            <span class="k">new</span> <span class="nf">Info</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">Title</span> <span class="p">=</span> <span class="s">"NetCore.WebApiExample"</span><span class="p">,</span>
                <span class="n">Version</span> <span class="p">=</span> <span class="s">"1.0"</span><span class="p">,</span>
                <span class="n">Description</span> <span class="p">=</span> <span class="s">"This API features several endpoints showing different API features"</span>
            <span class="p">});</span>
    <span class="p">});</span>
 
    <span class="n">c</span><span class="p">.</span><span class="n">OperationFilter</span><span class="p">&lt;</span><span class="n">SwaggerOperationFilter</span><span class="p">&gt;();</span>
 
    <span class="c1">//other configuration omitted...
</span>
<span class="p">}</span></code></pre></figure>

<p>Swagger UI for a Get method before enabling the OperationFilter:
<br /><img src="/assets/images/20181208/BeforeOperationFilter.png" alt="Swagger UI before OperationFilter" /></p>

<p>Swagger UI for the same Get method after enabling the OperationFilter:
<br /><img src="/assets/images/20181208/AfterOperationFilter.png" alt="Swagger UI after OperationFilter" /></p>

<p>Also you might want to add or modify certain properties or descriptions for the endpoint. To modify a part of the Swagger.json above the “operation” level, use a DocumentFilter.</p>

<p>An example of a DocumentFilter is to add descriptions to the tags. Operations for a Controller will be grouped within a collapsible pane in Swagger UI and the header of the pane is the tag assigned to that grouping. The DocumentFilter listed below will also sort the operations per tag in alphabetical order instead of the default method ordering as discovered within the API controller.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.Swagger</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Swashbuckle.AspNetCore.SwaggerGen</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.MiddleWare.Swagger</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SwaggerDocumentFilter</span> <span class="p">:</span> <span class="n">IDocumentFilter</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">SwaggerDocument</span> <span class="n">swaggerDoc</span><span class="p">,</span> <span class="n">DocumentFilterContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">swaggerDoc</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">swaggerDoc</span><span class="p">));</span>
            <span class="p">}</span>
 
            <span class="n">swaggerDoc</span><span class="p">.</span><span class="n">Tags</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tag</span><span class="p">&gt;</span> <span class="p">{</span>
                    <span class="k">new</span> <span class="n">Tag</span><span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"RoutingApi"</span><span class="p">,</span> <span class="n">Description</span> <span class="p">=</span> <span class="s">"This is a description for the api routes"</span> <span class="p">}</span>
                <span class="p">};</span>
 
            <span class="n">swaggerDoc</span><span class="p">.</span><span class="n">Paths</span> <span class="p">=</span> <span class="n">swaggerDoc</span><span class="p">.</span><span class="n">Paths</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">pair</span> <span class="p">=&gt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">).</span><span class="nf">ToDictionary</span><span class="p">(</span><span class="n">pair</span> <span class="p">=&gt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">pair</span> <span class="p">=&gt;</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>After defining the DocumentFilter you will also have to plug the filter into the Swagger processing pipeline as shown below.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span> 
        <span class="c1">//other configuration omitted...
</span>
 
        <span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span>
                <span class="k">new</span> <span class="nf">Info</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">Title</span> <span class="p">=</span> <span class="s">"NetCore.WebApiExample"</span><span class="p">,</span>
                    <span class="n">Version</span> <span class="p">=</span> <span class="s">"1.0"</span><span class="p">,</span>
                    <span class="n">Description</span> <span class="p">=</span> <span class="s">"This API features several endpoints showing different API features"</span>
                <span class="p">});</span>
        <span class="p">});</span>
 
        <span class="n">c</span><span class="p">.</span><span class="n">OperationFilter</span><span class="p">&lt;</span><span class="n">SwaggerOperationFilter</span><span class="p">&gt;();</span>
        <span class="n">c</span><span class="p">.</span><span class="n">DocumentFilter</span><span class="p">&lt;</span><span class="n">SwaggerDocumentFilter</span><span class="p">&gt;();</span>
 
        <span class="c1">//other configuration omitted...
</span>
    <span class="p">}</span></code></pre></figure>

<p>Swagger UI method listings before enabling the DocumentFilter:
<br /><img src="/assets/images/20181208/BeforeDocumentFilter.png" alt="Swagger UI before DocumentFilter" /></p>

<p>Swagger UI method listings after enabling the DocumentFilter:
<br /><img src="/assets/images/20181208/AfterDocumentFilter.png" alt="Swagger UI after DocumentFilter" /></p>

<p>Swagger can use certain attributes to enrich the documentation of your API.
Like specifying a return type. These return types will be listed in definitions part of the Swagger.json and will also show in the Swagger UI.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>        
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"customResponsetype"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">ProducesResponseType</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="n">Type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">MyResponseType</span><span class="p">))]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">GetCustomResponseType</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="k">new</span> <span class="n">MyResponseType</span> <span class="p">{</span>
                <span class="n">Title</span> <span class="p">=</span> <span class="s">"SomeTitle"</span><span class="p">,</span>
                <span class="n">Data</span> <span class="p">=</span> <span class="s">"SomeData"</span>
 
            <span class="p">});</span>
        <span class="p">}</span>
 
        <span class="k">public</span> <span class="k">class</span> <span class="nc">MyResponseType</span> <span class="p">{</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">Title</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 
            <span class="k">public</span> <span class="kt">string</span> <span class="n">Data</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 
            <span class="k">public</span> <span class="kt">int</span> <span class="n">Number</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 
            <span class="k">public</span> <span class="n">DateTime</span> <span class="n">Timestamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Swagger UI method listing without the ProduceResponseType attribute:
<br /><img src="/assets/images/20181208/MethodDescriptionBeforeOutputSpecification.png" alt="Swagger UI before output specification attribute" /></p>

<p>Swagger UI method listing with the ProduceResponseType attribute (also note the appearance of the models section):
<br /><img src="/assets/images/20181208/MethodDescriptionAfterOutputSpecification.png" alt="Swagger UI after output specification attribute" /></p>

<p>Swashbuckle can also use an XML comments file to enrich the descriptions for your endpoints.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Index</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="c1">/// &lt;summary&gt;
</span>
        <span class="c1">/// This route has a XML comments description
</span>
        <span class="c1">/// &lt;/summary&gt;
</span>
        <span class="c1">/// &lt;param name="email"&gt;A valid email&lt;/param&gt;
</span>
        <span class="c1">/// &lt;returns&gt;Single line of text describing the route for the result&lt;/returns&gt;
</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>        
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Next you can output the XML file with the comments in the project properties. In the project properties, go to the Build tab. Be sure to select “All Configurations” the Configuration drop down on the top of the page. Next check the XML file checkbox. In the project properties you can only specify a hardcoded path, but we can change it in the project file to make it dynamic to the build configuration and target framework to make sure the xml file ends up next to your output dll. When enabling the XML comments checkbox warnings will pop-up in the Error List window for every method not decorated with XML comments on the next build. To ignore these warnings, add the value “;1591” to the Suppress Warnings field also in the Build tab of the project properties.</p>

<p>Project properties:
<br /><img src="/assets/images/20181208/ProjectPropertiesXmlOutputFile.png" alt="Project properties Build tab for XML comments file" /></p>

<p>To make the XML comments file output location variable. Change the DocumentationFile values in the project file as shown below.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;TargetFramework&gt;</span>netcoreapp2.1<span class="nt">&lt;/TargetFramework&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
 
  <span class="nt">&lt;PropertyGroup</span> <span class="na">Condition=</span><span class="s">"'$(Configuration)|$(Platform)'=='Debug|AnyCPU'"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;DocumentationFile&gt;</span>bin\$(Configuration)\$(TargetFramework)\NetCore.WebApiExample.xml<span class="nt">&lt;/DocumentationFile&gt;</span>
    <span class="nt">&lt;NoWarn&gt;</span>1701;1702;1591<span class="nt">&lt;/NoWarn&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
 
  <span class="nt">&lt;PropertyGroup</span> <span class="na">Condition=</span><span class="s">"'$(Configuration)|$(Platform)'=='Release|AnyCPU'"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;DocumentationFile&gt;</span>bin\$(Configuration)\$(TargetFramework)\NetCore.WebApiExample.xml<span class="nt">&lt;/DocumentationFile&gt;</span>
    <span class="nt">&lt;NoWarn&gt;</span>1701;1702;1591<span class="nt">&lt;/NoWarn&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
 </code></pre></figure>

<p>After setting the file location, you set the IncludeXmlComments in the Swagger startup configuration to read the comments file with the correct location for the file.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span>
        <span class="k">new</span> <span class="nf">Info</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Title</span> <span class="p">=</span> <span class="s">"NetCore.WebApiExample"</span><span class="p">,</span>
            <span class="n">Version</span> <span class="p">=</span> <span class="s">"1.0"</span><span class="p">,</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="s">"This API features several endpoints showing different API features"</span>
        <span class="p">});</span>
 
    <span class="kt">var</span> <span class="n">xmlCommentsPath</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"dll"</span><span class="p">,</span><span class="s">"xml"</span><span class="p">);</span>
    <span class="n">c</span><span class="p">.</span><span class="nf">IncludeXmlComments</span><span class="p">(</span><span class="n">xmlCommentsPath</span><span class="p">);</span>    
<span class="p">});</span>
 </code></pre></figure>

<p>After this setup, when you navigate to the Swagger page you will see the extra descriptions.</p>

<p>Swagger UI method listing without the XML comments file loaded:
<br /><img src="/assets/images/20181208/WithoutXmlComments.png" alt="Swagger UI before XML comments" /></p>

<p>Swagger UI method listing with the XML comments file loaded:
<br /><img src="/assets/images/20181208/WithXmlComments.png" alt="Swagger UI after XML comments" /></p>

<h3 id="resources-and-further-documentation">Resources and further documentation</h3>

<ul>
  <li><a href="https://github.com/domaindrivendev/Swashbuckle" title="Swashbuckle github project and documentation" target="_blank">Swashbuckle github project and documentation</a></li>
  <li><a href="https://github.com/domaindrivendev/Swashbuckle.AspNetCore" title="Swashbuckle.AspNetCore github project and documentation" target="_blank">Swashbuckle. AspNetCore github project and documentation</a></li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/core/tutorials/web-api-help-pages-using-swagger" title="Microsoft docs Swagger page for .NET Core " target="_blank">Microsoft docs Swagger page for .NET Core</a></li>
  <li><a href="https://en.wikipedia.org/wiki/OpenAPI_Specification" title="OpenAPI specification on Wikipedia" target="_blank">OpenAPI specification on Wikipedia</a></li>
  <li><a href="https://github.com/OAI/OpenAPI-Specification" title="Open API specification GitHub repository" target="_blank">Open API specification GitHub repository</a></li>
</ul>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/10/09/using-route-constraints.html">Using route constraints for input validation and improved security</a>
        </header>
        
        <span>Oct 9, 2018</span> <br />
        Tags: 
        MVC
        
        WebAPI
        
        <div class="article-content">
            <p>In .Net web applications you use the routing system to expose URLs and endpoints in your application. If your method has a framework value type like int then the routing engine will automatically parse your inputs to these types.</p>

<p>Also if you the default convention based route in a .Net Framework MVC web application uses the convention below:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">"Default"</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"{controller}/{action}/{id}"</span><span class="p">,</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">"Home"</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">"Index"</span><span class="p">,</span> <span class="n">id</span> <span class="p">=</span> <span class="n">UrlParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure>

<p>This means that if I have the controller with a method as shown below:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Index</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>If I pas a numeric value that does not map to an int32 (for example max Int32 +1 (= 2147483648)) so <span class="link-style">http://localhost/My/Index/2147483648</span> or if I use <span class="link-style">http://localhost/My/Index/abc</span>, I get a server error saying that I passed a null value for a non-nullable integer. This error occurs because the input value could not be parsed to the correct value type.</p>

<p>After your method gets hit with an valid int32 value, you may also want to do some input validation. For example: is my integer input a positive number. When using string inputs you may want to validate and execute different code depending on what input was given. An example of this is shown below:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">input</span><span class="p">),</span> <span class="s">"Input has to be a valid positive integer"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">businessLogic</span><span class="p">.</span><span class="nf">ProcessInput</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">input</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"@"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">//return something
</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// return something else
</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>By using route constraints you can avoid cluttering controllers with validation code and routing logic inside your controller methods. Using route constraints will also add security benefits. If a route is not found the processing will stop quite early in the processing pipeline and return a 404 not found exception. This 404 exception will also never include sensitive internal information about a specific method that was being processed.</p>

<p>In this blogpost I will be describing the default route constraints provided by the .Net Frameworks and how to create custom constraints to make sure a method or route only gets hit by the intended input.</p>

<p>I have created a <a href="https://github.com/SamanthaNeilen/WebApiExamples" title="reference project on GitHub" target="_blank">reference project on GitHub</a> where all code snippets described in the rest of this blogpost can be found in a running project including integration tests demonstrating the working and denied routes.</p>

<h3 id="route-constraints-in-a-net-framework-web-application-for-mvc-controllers">Route constraints in a .Net Framework web application for MVC controllers</h3>
<p>Create a new .Net Framework web application using the MVC template. Next navigate to the Controllers/Home.cs file. The parameterless methods for showing the homepage, contact and about page are already listed. The default template uses the convention based routing by default. The default route template is defined in App_Start/RouteConfig.cs.</p>

<p>To add another route using a route constraint to the convention based routes, add the code as shown below:</p>

<p>RouteConfig.cs (make sure to add this above the default route)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">"GetNumber"</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"GetNumber/{input}"</span><span class="p">,</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">"Home"</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">"GetNumber"</span> <span class="p">},</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">input</span> <span class="p">=</span> <span class="s">@"\d{1,3}"</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure>

<p>HomeController.cs</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="kt">string</span> <span class="nf">GetNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.GetNumber((</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">input</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>With this defined route you will expose the <span class="link-style">http://localhost/GetNumber/{number}</span> route where the number parameter is a number of 1 to 3 digits. The constraints parameter in the MapRoute method accepts regular expressions and will route any call to the GetNumber method if the digits match. If the route does not match (for example {number} is 4 digits) no route will be found and you will get a HTTP 404 not found error when calling the GetNumber url.</p>

<p>Next if your logic is too complex for a regular expression you can choose to define a custom RouteConstraint as shown in the code snippets below:</p>

<p>RouteConfig: (again make sure to add this above the default route)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">"GetEmail"</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="s">"GetEmail/{email}"</span><span class="p">,</span>
    <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">"Home"</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">"GetEmail"</span> <span class="p">},</span>
    <span class="n">constraints</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Email</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmailRouteContraint</span><span class="p">()</span> <span class="p">}</span>
<span class="p">);</span></code></pre></figure>

<p>HomeController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEmail</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.GetEmail((</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>EmailRouteContraint.cs (this is a new class file added to the project)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Utilities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample.Custom</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailRouteContraint</span> <span class="p">:</span> <span class="n">IRouteConstraint</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">HttpContextBase</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">Route</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> 
                <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">,</span> <span class="n">RouteDirection</span> <span class="n">routeDirection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">parameterName</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">routeValue</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">parameterValueString</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">routeValue</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">parameterValueString</span><span class="p">.</span><span class="nf">IsEmail</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">HttpContextBase</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">Route</span> <span class="n">route</span><span class="p">,</span> 
                <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//validate input params  
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">httpContext</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">parameterName</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">parameterName</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>IsEmail extension method implementation:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">namespace</span> <span class="nn">Utilities</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Extensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsEmail</span><span class="p">(</span><span class="k">this</span> <span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">value</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"@"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Now we’ve set up a route for <span class="link-style">http://localhost/GetEmail/{email}</span> where the input string for email will only match if the value has a @ symbol in it. So just <span class="link-style">http://localhost/GetEmail/abc</span> will return a 404 not found result, but <span class="link-style">http://localhost/GetEmail/abc@</span> will route to our GetEmail method in the HomeController.cs file.</p>

<p>Convention based routing has some limitations for route constraints and also the route templates may unintentionally overlap and result in unexpected behavior. (If we did not specify the GetEmail of GetNumber paths in the url, the default route would have used our input and try to route it to one of our methods). Also attribute routing already has default constraint options for basic value type constraints.</p>

<p>For more information on convention based and attribute based routing and conventions for defining a route see the Microsoft docs pages about routing.</p>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/asp-net-mvc-routing-overview-cs" title="Microsoft docs page for convention based routing" target="_blank">Microsoft docs page for convention based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#adding-route-attributes" title="Microsoft docs page for attribute based routing" target="_blank">Microsoft docs page for attribute based routing</a>.</li>
</ul>

<p>To enable attribute based routing, add the snippet below to the RouteConfig file. Next add a number method using a Route attribute with a default inline constraint as shown below.</p>

<p>RouteConfig:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">routes</span><span class="p">.</span><span class="nf">MapMvcAttributeRoutes</span><span class="p">();</span></code></pre></figure>

<p>HomeController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("Attr/{number:range(0,2147483647)}")]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">GetNumberAttributeRoute</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">number</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Now we have a <span class="link-style">http://localhost/Attr/{number}</span> route defined. The default route constraint will ensure that only a valid positive integer will be accepted. Negative input will result in a 404 not found result. Also if you did not specify a constraint, an input larger than Int32 would have routed to this method and the input would have been 0 as the number would not have been parsable to a valid int32.</p>

<p>For a table of the default inline constraints for attribute routing see: <a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#route-constraints" title="the Microsoft docs page for default inline constraints" target="_blank">the Microsoft docs page for default inline constraints</a>. These default constraints do not seem to work in the convention based routing constraints parameter. When using convention based routing you will only be able to use regex or custom route constraint implementations.</p>

<p>To add a custom constraint to an attribute routing template, change the call to the MapMvcAttributeRoutes method to the snippet shown below and add a method using the custom constraint in the HomeController.</p>

<p>RouteConfig:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">constraintsResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultInlineConstraintResolver</span><span class="p">();</span>
<span class="n">constraintsResolver</span><span class="p">.</span><span class="n">ConstraintMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">EmailRouteContraint</span><span class="p">));</span>
<span class="n">routes</span><span class="p">.</span><span class="nf">MapMvcAttributeRoutes</span><span class="p">(</span><span class="n">constraintsResolver</span><span class="p">);</span></code></pre></figure>

<p>HomeController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("Attr/{email:Email}")]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEmailAttributeRoute</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Here we map the string “Email” to our custom constraint implementation. Now we can use that string in our Route template as “{parametername:Email}”. When using multiple custom constraints you have to map them to unique names to use in your routes. The implementation above maps the url <span class="link-style">http://localhost/Attr/{email}</span> to our method. So now we can use <span class="link-style">http://localhost/Attr/abc@</span> as a valid route but the constaint will ensure that <span class="link-style">http://localhost/Attr/abc</span> will still return a 404 not found.</p>

<h3 id="route-constraints-in-a-net-framework-web-application-for-webapi-controllers">Route constraints in a .Net Framework web application for WebApi controllers</h3>
<p>In the .Net Framework projects, MVC Controllers and WebApi Controllers work with different implementations. When adding a new controller and selecting a WebApi controller template, a WebApiConfig.cs file will appear in the App_Start folder. As you compare that file with the RouteConfig.cs you will see that the methods use different types with different methods to configure routing. 
(When adding a WebApi controller to an MVC project you also need add the GlobalConfiguration.Configure(WebApiConfig.Register); line to your global.asax file to enable the WebApi routing)</p>

<p>We can add a WebApi controller to the project and define some routes showing the attribute route constraints with almost the same code as we used for the MVC controller.</p>

<p>Global.asax: (full Global.asax is shown but the only change I made was the call to the WebApiConfig.Register method)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Optimization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MvcApplication</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">HttpApplication</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">AreaRegistration</span><span class="p">.</span><span class="nf">RegisterAllAreas</span><span class="p">();</span>
            <span class="n">GlobalConfiguration</span><span class="p">.</span><span class="nf">Configure</span><span class="p">(</span><span class="n">WebApiConfig</span><span class="p">.</span><span class="n">Register</span><span class="p">);</span>
            <span class="n">FilterConfig</span><span class="p">.</span><span class="nf">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">);</span>
            <span class="n">RouteConfig</span><span class="p">.</span><span class="nf">RegisterRoutes</span><span class="p">(</span><span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">);</span>
            <span class="n">BundleConfig</span><span class="p">.</span><span class="nf">RegisterBundles</span><span class="p">(</span><span class="n">BundleTable</span><span class="p">.</span><span class="n">Bundles</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>WebApiConfig.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Framework.WebApiExample.Custom</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Routing</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">WebApiConfig</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Register</span><span class="p">(</span><span class="n">HttpConfiguration</span> <span class="n">config</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">constraintsResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultInlineConstraintResolver</span><span class="p">();</span>
            <span class="n">constraintsResolver</span><span class="p">.</span><span class="n">ConstraintMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">EmailHttpRouteConstraint</span><span class="p">));</span>
            <span class="n">config</span><span class="p">.</span><span class="nf">MapHttpAttributeRoutes</span><span class="p">(</span><span class="n">constraintsResolver</span><span class="p">);</span>

            <span class="n">config</span><span class="p">.</span><span class="n">Routes</span><span class="p">.</span><span class="nf">MapHttpRoute</span><span class="p">(</span>
                <span class="n">name</span><span class="p">:</span> <span class="s">"DefaultApi"</span><span class="p">,</span>
                <span class="n">routeTemplate</span><span class="p">:</span> <span class="s">"api/{controller}/{id}"</span><span class="p">,</span>
                <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">RouteParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>EmailHttpRouteConstraint.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Http.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Utilities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample.Custom</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailHttpRouteConstraint</span> <span class="p">:</span> <span class="n">IHttpRouteConstraint</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">IHttpRoute</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> 
                <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">,</span> <span class="n">HttpRouteDirection</span> <span class="n">routeDirection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">parameterName</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">routeValue</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">parameterValueString</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">routeValue</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">parameterValueString</span><span class="p">.</span><span class="nf">IsEmail</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">IHttpRoute</span> <span class="n">route</span><span class="p">,</span> 
                <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//validate input params  
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">parameterName</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">parameterName</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>RoutingApiController.cs:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Web.Http</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Framework.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">RoutePrefix</span><span class="p">(</span><span class="s">"api/routingapi"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RoutingApiController</span> <span class="p">:</span> <span class="n">ApiController</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{validPositiveInt32Value:range(0,2147483647)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">validPositiveInt32Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">validPositiveInt32Value</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{valueMatchingRegex:regex(^(.+)(_)(.+)$)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">GetByRegex</span><span class="p">(</span><span class="kt">string</span> <span class="n">valueMatchingRegex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">valueMatchingRegex</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>        
        <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As you may have noticed in the code above. The email custom route constraint for a WebApi controller implements the IHttpRouteConstraint interface instead of the IRouteConstraint interface. Be aware when intermingling MVC and WebApi controllers in a .Net Framework web application project that other attributes (like authorization) will also usually require different implementations to be used for a MVC and a WebApi controller.</p>

<p>By adding the RoutingApiController listed above the following routes become availlable:</p>

<ul>
  <li><span class="link-style">http://localhost/api/routingapi/{ValidPositiveInt32}</span></li>
  <li><span class="link-style">http://localhost/api/routingapi/{StringSplitByUnderscore}</span></li>
  <li><span class="link-style">http://localhost/api/routingapi/{StringContaining@Symbol}</span></li>
</ul>

<h3 id="route-constraints-in-a-net-core-web-application">Route constraints in a .Net Core web application</h3>

<p>In the .Net Core pipeline MVC and WebApi controllers now share the same base classes. The setup for routing is also now centralized in the Startup classes. The code snippets below how to set up the routing and then show an MVC and a WebApi controller with the same routing constraint concepts that I have explained in the previous sections of this post. 
The code snippets were added to a default .Net Core web application using the Model View Controller project template. The code in the Startup.cs is needed when adding a custom route constraint in the template. If you only use the route constraints that can be resolved by the DefaultInlineConstraintResolver, the code for setting up the RouteOptions configuration can be omitted.</p>

<p>Startup.cs</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">NetCore.WebApiExample.MiddleWare</span><span class="p">;</span>

<span class="p">...</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">CookiePolicyOptions</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// This lambda determines whether user consent for non-essential cookies is needed for a given request.
</span>
        <span class="n">options</span><span class="p">.</span><span class="n">CheckConsentNeeded</span> <span class="p">=</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">MinimumSameSitePolicy</span> <span class="p">=</span> <span class="n">SameSiteMode</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">RouteOptions</span><span class="p">&gt;(</span><span class="n">routeOptions</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">routeOptions</span><span class="p">.</span><span class="n">ConstraintMap</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">EmailRouteContraint</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">().</span><span class="nf">SetCompatibilityVersion</span><span class="p">(</span><span class="n">CompatibilityVersion</span><span class="p">.</span><span class="n">Version_2_1</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>EmailRouteConstraint.cs</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Routing</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Utilities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.MiddleWare</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmailRouteContraint</span> <span class="p">:</span> <span class="n">IRouteConstraint</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">IRouter</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">routeKey</span><span class="p">,</span> <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">,</span> <span class="n">RouteDirection</span> <span class="n">routeDirection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">routeKey</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">routeKey</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">routeValue</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">parameterValueString</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">routeValue</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">parameterValueString</span><span class="p">.</span><span class="nf">IsEmail</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">RouteParameterInputValidation</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">httpContext</span><span class="p">,</span> <span class="n">IRouter</span> <span class="n">route</span><span class="p">,</span> <span class="kt">string</span> <span class="n">routeKey</span><span class="p">,</span> <span class="n">RouteValueDictionary</span> <span class="n">values</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//validate input params  
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">httpContext</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">routeKey</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">routeKey</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">values</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>HomeController.cs (.Net Core MVC Controller)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Index</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is HomeController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>RoutingApiController.cs (.Net Core WebApi Controller)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetCore.WebApiExample.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RoutingApiController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{email:Email}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">email</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{inputMatchingRegex:regex(^(.+)(_)(.+)$)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">GetByRegex</span><span class="p">(</span><span class="kt">string</span> <span class="n">inputMatchingtRegexForValueContainingUnderscore</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">inputMatchingtRegexForValueContainingUnderscore</span><span class="p">)}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"{validPositiveInt32Value:range(0,2147483647)}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">validPositiveInt32Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="s">$"Route is RoutingApiController.Get(</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">validPositiveInt32Value</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="testing-routing-behavior-with-integration-tests">Testing routing behavior with integration tests</h3>
<p>To ensure your routes work as intended and faulty input does not lead to errors you can write a set of integration tests. I used a .Net Core test project combined with the NUnit testing framework to write the tests shown below.</p>

<p>TestClass: (the RouteDriver implementation is listed below the TestClass code snippet )</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">IntegrationTests.TestDriver</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">NUnit.Framework</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">IntegrationTests</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;
</span>
    <span class="c1">/// Be sure to have local instance of the Framework.WebApiExample website running on the url provided in the _localHostUrl constant.
</span>
    <span class="c1">/// &lt;/summary&gt;
</span>
    <span class="p">[</span><span class="n">TestFixture</span><span class="p">]</span>    
    <span class="k">public</span> <span class="k">class</span> <span class="nc">FrameworkMvcRouteTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">_localHostUrl</span> <span class="p">=</span> <span class="s">"http://localhost:55528/"</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">RouteTestDriver</span> <span class="n">_testDriver</span><span class="p">;</span>

        <span class="p">[</span><span class="n">SetUp</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Setup</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_testDriver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RouteTestDriver</span><span class="p">(</span><span class="n">_localHostUrl</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">TearDown</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">TearDown</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_testDriver</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">""</span><span class="p">)]</span> <span class="c1">//Home/Index route    
</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/abc@"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/abc@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/0"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/12"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/123"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Convention_Based_Route_Should_Be_Valid_Route</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
           <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturnsSuccessStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>                                          
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>        
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetEmail/123"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"GetNumber/1234"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Convention_Based_Route_Should_Return_404_Not_Found_StatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturns404NotFoundStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>
        <span class="p">}</span>


        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>   
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/abc@"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/abc@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/@abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/0"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/12345"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/2147483647"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Attribute_Based_Route_Should_Be_Valid_Route</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturnsSuccessStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/abc"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/-1"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">TestCase</span><span class="p">(</span><span class="s">"Attr/2147483648"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">FrameworkMvc_Given_Relative_MVC_Attribute_Based_Route_Should_Return_404_Not_Found_StatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">IsTrue</span><span class="p">(</span><span class="n">_testDriver</span><span class="p">.</span><span class="nf">UrlReturns404NotFoundStatusCode</span><span class="p">(</span><span class="n">relativeUrl</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>RouteTestDriver.cs (this class is a helper to centralize code used for multiple tests)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"> 
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">IntegrationTests.TestDriver</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RouteTestDriver</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_localHostBaseUrl</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">RouteTestDriver</span><span class="p">(</span><span class="kt">string</span> <span class="n">localHostBaseUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">localHostBaseUrl</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">localHostBaseUrl</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">_localHostBaseUrl</span> <span class="p">=</span> <span class="nf">AppendBackSlashIfNeeded</span><span class="p">(</span><span class="n">localHostBaseUrl</span><span class="p">);</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">UrlReturnsSuccessStatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrlForTest</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="n">HttpClientFactory</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">uriToTest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">_localHostBaseUrl</span> <span class="p">+</span> <span class="p">(</span><span class="n">relativeUrlForTest</span> <span class="p">??</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">httpCallResult</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uriToTest</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">httpCallResult</span><span class="p">.</span><span class="n">IsSuccessStatusCode</span><span class="p">;</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">UrlReturns404NotFoundStatusCode</span><span class="p">(</span><span class="kt">string</span> <span class="n">relativeUrlForTest</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="n">HttpClientFactory</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">uriToTest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">_localHostBaseUrl</span> <span class="p">+</span> <span class="p">(</span><span class="n">relativeUrlForTest</span> <span class="p">??</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">httpCallResult</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uriToTest</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">httpCallResult</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">==</span> <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">NotFound</span><span class="p">;</span>

        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="nf">AppendBackSlashIfNeeded</span><span class="p">(</span><span class="kt">string</span> <span class="n">localHostBaseUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="p">!</span><span class="n">localHostBaseUrl</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
                <span class="p">?</span> <span class="n">localHostBaseUrl</span> <span class="p">+</span> <span class="s">"/"</span>
                <span class="p">:</span> <span class="n">localHostBaseUrl</span><span class="p">;</span>
        <span class="p">}</span>       
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HttpClientFactory</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="n">_instance</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="nf">GetInstance</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_instance</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>These tests can help you make sure that a route either works (by returning a success status code) or is not found (by returning a 404 not found status). I made sure to explicitly check for 404 not found statuses for the “failure” cases and not just check if the success status code was false. This ensures no unwanted internal server errors are returned. Internal server errors are unwanted behavior and if error handling is set up in the wrong way, they may even expose internals of your application that you do not want your users to see.</p>

<h3 id="microsoft-docs-reference-links">Microsoft Docs reference links:</h3>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/asp-net-mvc-routing-overview-cs" title="Microsoft docs page for convention based routing" target="_blank">Microsoft docs page for convention based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions-1/controllers-and-routing/creating-a-route-constraint-cs" title="Microsoft docs page for creating a custom route constraint for convention based routing" target="_blank">Microsoft docs page for creating a custom route constraint for convention based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#adding-route-attributes" title="Microsoft docs page for attribute based routing" target="_blank">Microsoft docs page for attribute based routing</a>.</li>
  <li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/routing?view=aspnetcore-2.1" title="Microsoft docs page for routing in .Net Core 2.1" target="_blank">Microsoft docs page for routing in .Net Core 2.1</a>.</li>
</ul>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/08/17/tls1.2-not-supported-by-default-in-older-net-framework-applications.html">TLS1.2 not supported by default in older .NET Framework applications</a>
        </header>
        
        <span>Aug 17, 2018</span> <br />
        Tags: 
        <div class="article-content">
            <p>Lately more and more API providers have been disabling TLS 1.1 for their servers and are currently only accepting the TLS 1.2 protocol for establishing a HTTPS connection to their servers. TLS takes care of the encryption of the HTTPS communication and TLS1.2 was introduced in 2008. It is more secure (harder to decrypt) than the previous versions.</p>

<p>You may encounter that establishing a HTTPS connection to a 3rd party may suddenly fail without there having been any new code changes or deployments. This may be due to the fact that the 3rd party has decided to no longer accept TLS 1.1 or below for HTTPS connections.</p>

<p>I ran into this myself again this week because I used a PowerShell command to execute C# code to retrieve a bearer access token from Azure leveraging the ADAL dll’s. It suddenly did not work anymore last week and after some Googling I found a similar error that was solved by adding the TLS1.2 protocol to the ServicePointManager.SecurityProtocol property. I have needed to do this before in several older C# applications and it inspired me to write this blogpost today.</p>

<p>If you face the exception “The server forcibly closed the connection” this may be an indication that the ServicePointManager no longer has a compatible protocol to establish a HTTPS connection with the server.</p>

<p>The ServicePointManager is a static class .Net Framework class that will always choose the highest (securest) protocol available from the SecurityProtocol property and will only fall back to a previous version if the highest is not supported.</p>

<p>Use a debugger to inspect the ServicePointManager.SecurityProtocol value to see if TLS 1.2 is listed, to determine whether or not this may be the cause of your connection issues. 
This is usually the cause when using older .Net Framework versions (&lt; 4.7) as is it was with my PowerShell.</p>

<p>In C# use the code below to append the current security protocols with TLS1.2 before establishing the connection to the server or put this code snippet in your Global.asax startup.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="n">ServicePointManager</span><span class="p">.</span><span class="n">SecurityProtocol</span> <span class="p">|=</span> <span class="n">SecurityProtocolType</span><span class="p">.</span><span class="n">Tls12</span></code></pre></figure>

<p>When using powershell use the command below to check the current default protocols as used in Powershell:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"> <span class="o">[</span>Net.ServicePointManager]::SecurityProtocol</code></pre></figure>

<p>You can set the TLS1.2 protocol if it’s not listed by using:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">[</span>Net.ServicePointManager]::SecurityProtocol +<span class="o">=</span> <span class="o">[</span>Net.SecurityProtocolType]::Tls12 </code></pre></figure>

<p>Older version of PowerShell may not support this syntax. Use the syntax below set the most common protocols:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="o">[</span>Net.ServicePointManager]::SecurityProtocol <span class="o">=</span> <span class="o">[</span>Net.SecurityProtocolType]::Ssl3,  <span class="o">[</span>Net.SecurityProtocolType]::Tls, <span class="o">[</span>Net.SecurityProtocolType]::Tls12 </code></pre></figure>

<p>Remember: when appending or setting the ServicePointManager.SecurityProtocol property to a set value in your code, you may have to revisit this at a later time when newer TLS protocols become the new standard.</p>

<p>For more information on this subject visit the reference websites below:</p>

<p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" title="Wikipedia page for Transport Layer Security" target="_blank">Wikipedia page for Transport Layer Security</a></p>

<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepointmanager.securityprotocol?redirectedfrom=MSDN&amp;view=netframework-4.7.2#System_Net_ServicePointManager_SecurityProtocol" title="Microsoft Docs page on the ServicePointManager.SecurityProtocol property" target="_blank">Microsoft Docs page on the ServicePointManager.SecurityProtocol property</a></p>


        </div>
    </article>
    
    <article>
        <header class="article-header">
            <a href="/2018/07/14/csharp-script-azure-functions-example.html">C# script Azure Functions example</a>
        </header>
        
        <span>Jul 14, 2018</span> <br />
        Tags: 
        Azure
        
        AzureFunctions
        
        <div class="article-content">
            <p>
C# Script Functions are another way to create Azure Functions based on C#. These functions rely on C# script files (.csx) that are not compiled into a dll. There is no Visual Studio project to create or manage the files. You use command line tooling for development and the advantage is that you can directly edit and run your code in the Azure portal. Script Functions can be developed and tested locally before uploading the Function to the portal.
</p>
<p>
If you would like to know more about compiled Azure Functions using the Visual Studio Azure Function project see <a href="https://samanthaneilen.github.io/2018/06/08/pre-compiled-azure-functions-example.html" target="_blank">my last blog post about pre-compiled Azure Functions</a>.
</p>
<p>
All the code from the following example can also be found in my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExample repository</a> in the solution folder AzureFunction_CsharpScript.
</p>
<h3>Create an C# script Azure Function</h3>
<p>
Install npm and nodejs from the <a href="https://nodejs.org/en/" target="_blank">nodejs website</a>.
</p>
<p>Install npm azure functions core tools using the command line. I used the v1 (.Net Framework version) using the command below.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">npm install <span class="nt">-g</span> azure-functions-core-tools</code></pre></figure>

<p>
Append the package name with @core to install de v2 version. The v2 version is built on .Net Core and is currently still in preview (the same as with the compiled Azure Functions)
</p>
<p>
The files for the azure-function-core-tools are placed in %USER%\AppData\Roaming\npm on your disk.
In the npm\node_modules\azure-functions-core-tools\bin folder you can view all the Framework and Nuget package dlls available for use at runtime.
</p>
<p>
If you wish to check the version of the downloaded package and the commands for the command line use the command below. For command usage see the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local" target="blank">Microsoft Docs guidance on developing C# script Functions</a>.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func version</code></pre></figure>

<p>
Next I want to create a queue Function based on the C# language. Go to the directory where you want to create the function folder. And use the command below.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func init AzureFunctionsExample.ScriptV1</code></pre></figure>

<p><br /><img src="/assets/images/20180714/cmd.exe-func-init.png" alt="cmd.exe func init" /></p>
<p>
This command will create a “project folder” for an empty Azure Function project with the host and localsettings json files. (These are used the same as for compiled Azure Functions. See <a href="https://samanthaneilen.github.io/2018/06/08/pre-compiled-azure-functions-example.html" target="_blank">my previous blogpost about compiled Azure Functions</a> or the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#local-settings-file" target="blank">Microsoft Docs pages</a> for more information) 
</p>
<p>
Also note the .vscode folder. Seeing as there is no .csproj file, the support for regular visual studio is limited. You can manage in the files in Visual Studio by creating a class library or solution folders and importing the files but with Visual Studio code you can just open the folder to manage the files. 
</p>
<p>
Visual Studio Code also has a plugin for Azure Functions that adds an Azure tab to your project. It also has options to create Azure Functions but these will create compiled Functions. When opening the folder you may be prompted to optimize the Function but as it was not created using the plugin, it will not optimize. 
</p>
<p>
I used regular Visual Studio with a class library and the regular command line shell for all the next steps because I did not have time to look into debugging script Azure Functions with Visual Studio Code. NPM installs a 32 bit version of the CLI and Visual Studio Code does not seem to support debugging the 32bit process.
</p>
<p>
The command below is used to create the files for the actual Function in a sub folder of the Azure Function app folder.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func new</code></pre></figure>

<p>
Next navigate the selection options to create a C# Queue trigger and provide a name for the Function.
<br /><img src="/assets/images/20180714/cmd.exe-func-new.png" alt="cmd.exe func new" />
</p>
<p>
This will create a new subfolder with a function.json that describes the input/output bindings, a run.csx that has the “main” method for the function called Run and a sample.dat file that can be used later to provide message data while debugging. It also has a readme file with little information. I just deleted the readme file. 
</p>
<p>Function.json:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"disabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"bindings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myQueueItem"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"queueTrigger"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"queueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myqueue-items"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Run.csx</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">string</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
For easy management just include all the files inside your Visual Studio class library project so you can access and manage them from the Solution Explorer as shown in the image below.
<br /><img src="/assets/images/20180714/solutionexplorer-AzureFunctionsExample.ScriptV1.png" alt="Solution Explorer AzureFunctionsExample.ScriptV1" />
</p>
<p>
Now we have all the files needed for the Function but first we need to configure connection to the Azure Storage emulator before we can start it up. 
</p>
<p>
Go into local.settings.json in the root folder and change the Values node with content below to configure the storage connections:
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"AzureWebJobsStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"AzureWebJobsDashboard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="w">
  </span><span class="p">}</span></code></pre></figure>

<p>
Next go to the function.json and set the connection to the AzureWebJobsStorage and the queueName to messages. If you do not have the Azure Storage Emulator set up yet view the Azure Storage Emulator paragraph in <a href="https://samanthaneilen.github.io/2018/06/08/pre-compiled-azure-functions-example.html" target="_blank">my post about compiled Azure Functions</a>. 
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"disabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"bindings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myQueueItem"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"queueTrigger"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"queueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"messages"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AzureWebJobsStorage"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
We can now run the Function by using the command shown below in the command shell in the root folder (where the host.json file is). Make sure that the Azure Storage Emulator is running,
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">func host start <span class="nt">--debug</span> VS</code></pre></figure>

<p><br /><img src="/assets/images/20180714/cmd.exe-func-host-start.png" alt="cmd.exe func host start" /></p>
<p>
This will start the Azure Function the same way that it did with the compiled Azure Function.  
</p>
<p>
When specifying debug mode you also get the JIT Debugger window. Just choose the Visual Studio instance where the run.csx is available to attach the debugger.
<br /><img src="/assets/images/20180714/jit-debug-window.png" alt="jit debug window" />
</p>
<p>
You will also get the application in break mode tab in your Visual Studio instance. Just click the continue execution option. (You may have to press enter in the command shell to continue loading of the Function if it was interrupted by the debug prompt before it will pick up any messages)
</p>
<p>
Next set a breakpoint in the run.csx and use the QueueMessage project from my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureFunctionExamples</a> repository or any other method to post a message to the queue and see the debugger in the run.asxc.
<br /><img src="/assets/images/20180714/debug-run.csx.png" alt="debug run.csx" />
</p>
<p>
For extra methods and simple Azure Functions you could create all extra classes and methods in the run.csx file. For better maintainability create classes and extra code into separate C# script (.csx) files or in a separate class library compiled to a dll. You can also reference the .Net assemblies that are available for the Azure Function runtime. For more information see the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp" target="_blank"> Microsoft Docs on C# script</a>.
</p>
<p>
In my <a href="https://github.com/SamanthaNeilen/AzureFunctionExamples" target="_blank">AzureExampleFunctions repository</a>. I’ve created a QueueMessage.csx class used to convert the input queuemessage from a string to an object instance. First add a QueueMessage.csx file to the ProcessMessageScriptV1 Function folder with the definition of the QueueMessage class (as shown below). There are no using or namespace definitions in the file. Next use the #load “QueueMessage.csx” statement in the run.csx to complete the reference binding and change the type for myQueueItem from string to QueueMessage. The code should look as below:
</p>
<p>
QueueMessage.csx:
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">internal</span> <span class="k">class</span> <span class="nc">QueueMessage</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">internal</span> <span class="k">enum</span> <span class="n">OrderStatus</span>
<span class="p">{</span>
    <span class="n">Concept</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
    <span class="n">Processing</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
    <span class="n">Processed</span> <span class="p">=</span> <span class="m">2</span>
<span class="p">}</span></code></pre></figure>

<p>run.csx:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="err">#</span><span class="n">load</span> <span class="s">"QueueMessage.csx"</span>
 
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
 
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
Next run the Function to see that the myQueueItem is successfully converted from a Json message to a QueueMessage instance.
<br /><img src="/assets/images/20180714/debug-run.csx-queuemessage-object.png" alt="debug run.csx queuemessage object" />
</p>
<p>
Extra .csx files can also be placed in subfolders. If QueueMessage.csx was placed in a subfolder called helpers you would use the #load “helpers/QueueMessage.csx” in the run.csx file. The #load statement contains a relative path to the file. See the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference-csharp#reusing-csx-code" target="_blank"> Microsoft Docs on C# script</a> for examples.
</p>
<h3>Referencing a custom dll in an Azure Script Function</h3>
<p>
Next I can create separate dll containing a Data Access Layer and reference it in my script Function. 
(I couldn’t use the AzureFunctionExample.ResourceAccess library already present in the solution because I got exceptions that EntityFrameworkCore was not supported on the platflorm). Just add a .Net Framework library with the Entity Framework package and define the data access classes below:
</p>
<p>Order class:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">PersonID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="k">public</span> <span class="kt">string</span> <span class="n">OrderNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="n">Person</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Person class:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">Person</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Orders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>OrderDbContext class:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Entity.ModelConfiguration.Conventions</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">connectionString</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Database</span><span class="p">.</span><span class="n">SetInitializer</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">Person</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Order</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">DbModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
               <span class="p">.</span><span class="nf">HasMany</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Orders</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">WithRequired</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Person</span><span class="p">)</span>
               <span class="p">.</span><span class="nf">HasForeignKey</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span><span class="p">);</span>
 
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="n">Remove</span><span class="p">&lt;</span><span class="n">PluralizingTableNameConvention</span><span class="p">&gt;();</span>
 
            <span class="k">base</span><span class="p">.</span><span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">modelBuilder</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>
To use this library in my Function I need to get the output dll and the extra references to a location accessible to the script Function. So first I copy all the dll from the bin output to an empty references folder using a post-build event.
</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">xcopy /Y/S <span class="k">$(</span>TargetDir<span class="k">)$(</span>ProjectName<span class="k">)</span>.dll <span class="k">$(</span>SolutionDir<span class="k">)</span>AzureFunctionsExample.ScriptV1<span class="se">\P</span>rocessMessageScriptV1<span class="se">\r</span>eferences
xcopy /Y/S <span class="k">$(</span>TargetDir<span class="k">)</span>EntityFramework.dll <span class="k">$(</span>SolutionDir<span class="k">)</span>AzureFunctionsExample.ScriptV1<span class="se">\P</span>rocessMessageScriptV1<span class="se">\r</span>eferences
xcopy /Y/S <span class="k">$(</span>TargetDir<span class="k">)</span>EntityFramework.SqlServer.dll <span class="k">$(</span>SolutionDir<span class="k">)</span>AzureFunctionsExample.ScriptV1<span class="se">\P</span>rocessMessageScriptV1<span class="se">\r</span>eferences</code></pre></figure>

<p><br /><img src="/assets/images/20180714/project-properties-xcopy-build-event.png" alt="project properties xcopy build event" /></p>
<p>
This will ensure that after every build all the necessary dll will be in that folder (even though I excluded that folder from source control with the .gitignore file) 
</p>
<p>
Next add all the necessary settings to the local.settings.json. so it looks like below:
</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"IsEncrypted"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"AzureWebJobsStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"AzureWebJobsDashboard"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UseDevelopmentStorage=true"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"OrderDbConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Server=.</span><span class="se">\\</span><span class="s2">SQLEXPRESS;Database=OrderDb;Integrated Security=True;"</span><span class="p">,</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>
And finally I add the reference and using statements to the run.csv and change the implementation of the run.csx to the code shown below:
</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="err">#</span><span class="n">load</span> <span class="s">"QueueMessage.csx"</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"references/EntityFramework.dll"</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"references/AzureFunctionsExample.ScriptResources.dll"</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"netstandard"</span>
 
<span class="k">using</span> <span class="nn">AzureFunctionsExample.ScriptResources.DataAccess</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
 
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">QueueMessage</span> <span class="n">myQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"OrderDbConnection"</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Person</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Order</span> <span class="p">&amp;&amp;</span> <span class="n">o</span><span class="p">.</span><span class="n">PersonID</span> <span class="p">==</span> <span class="n">myQueueItem</span><span class="p">.</span><span class="n">Person</span><span class="p">);</span>
 
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>
By referencing dll or just using .csx files you can create pretty complex C# script Functions with the same functionality as a pre-compiled Azure Function.
<h3>Run and test in the Azure Portal</h3>
<p>
The command line offers a login and publish command to push your local Function app to a hosted Azure Function App. Another way you can upload the files is via de App Service Editor under the Platform Settings for an Azure App Function in the Azure Portal. Remember to copy the key value pairs from the appsettings.json to the Application Settings page of the Azure Function App in the portal.
</p>
<p>
With script Functions you can view the files and edit and run the Function directly in the portal with the editor show below.
<br /><img src="/assets/images/20180714/azure-function-app-editor.png" alt="azure-function-app-editor" />
</p>

 
</p>

        </div>
    </article>
    
    <center><p><a href="/archive">For additional posts see the archive page for an overview of all available posts</a></p></center>
    
</div>

                </main>
            </div>
            <div class="col-md-3">
                <aside aria-label="sidebar">
                    <section class="sidebar-section">
    <h3>About me</h3>
    I am a dutch .Net developer.
    I have been coding professionaly since 2008.
    On this blog I will be writing about multiple subjects that I use in my daily programming job or subjects that I am studying.
</section>
<section class="sidebar-section">
    <h3>Social</h3>
    <a href="https://github.com/SamanthaNeilen"><i class="fa fa-github" aria-hidden="true"></i><span>&nbsp;SamanthaNeilen</span></a> <br />
    <a href="https://twitter.com/NeilenSamantha"><i class="fa fa-twitter" aria-hidden="true"></i><span>&nbsp;NeilenSamantha</span></a> <br />
    <a href="https://www.linkedin.com/in/samantha-neilen-16153713"><i class="fa fa-linkedin" aria-hidden="true"></i><span>&nbsp;Samantha Neilen</span></a><br />
    Subscribe via <a href="/feed.xml">RSS</a>
</section>
<section class="sidebar-section">
    <h3>Last posts </h3>
    
    <a href="/2019/01/19/Web-API-versioning-using-the-NuGet-packages-from-Microsoft.html">Web API versioning using the NuGet packages from Microsoft</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/12/08/Using-and-extending-swagger.json-for-API-documentation.html">Using and extending Swagger.json (OpenApi) for API documentation</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/10/09/using-route-constraints.html">Using route constraints for input validation and improved security</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/08/17/tls1.2-not-supported-by-default-in-older-net-framework-applications.html">TLS1.2 not supported by default in older .NET Framework applications</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/2018/07/14/csharp-script-azure-functions-example.html">C# script Azure Functions example</a> <br />
    <div class="last-posts-spacer"></div>
    
    <a href="/archive">Archive</a>
</section>
                </aside>
            </div>
        </div>
    </div>
</body>
</html>
